{% extends "base.html" %}

{% block title %}결과 - 시험 시간표 배정 시스템{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Header -->
        <div class="text-center mb-4">
            <h2 class="text-primary">
                <i class="fas fa-chart-bar me-2"></i>
                시험 시간표 결과
            </h2>
            <p class="text-muted">생성된 시험 시간표와 분석 결과를 확인하세요.</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center">
            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
            <h5>결과를 불러오는 중...</h5>
        </div>

        <!-- Results Content -->
        <div id="resultsContent" style="display: none;">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-users fa-2x text-primary mb-2"></i>
                            <h4 id="totalStudents">-</h4>
                            <p class="text-muted mb-0">총 학생 수</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-book fa-2x text-success mb-2"></i>
                            <h4 id="totalSubjects">-</h4>
                            <p class="text-muted mb-0">총 과목 수</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-calendar fa-2x text-info mb-2"></i>
                            <h4 id="totalSlots">-</h4>
                            <p class="text-muted mb-0">총 슬롯 수</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h4 id="avgExamsPerDay">-</h4>
                            <p class="text-muted mb-0">평균 시험/일</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        시험 시간표
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>슬롯</th>
                                    <th>배정된 과목</th>
                                    <th>과목 수</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Distribution Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                하루 시험 수 분포
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="examDistributionChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                하루 어려운 시험 수 분포
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="hardExamDistributionChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        상세 분석
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">하루에 3과목 치는 학생들</h6>
                            <div id="studentsWith3Exams" class="mb-3">
                                <p class="text-muted">데이터 로딩 중...</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">하루에 어려운 시험 2과목 치는 학생들</h6>
                            <div id="studentsWith2HardExams" class="mb-3">
                                <p class="text-muted">데이터 로딩 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-download me-2"></i>
                        결과 다운로드
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="/download/schedule_result.json" class="btn btn-outline-primary btn-lg mb-2">
                                <i class="fas fa-file-code me-2"></i>
                                상세 결과 (JSON)
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="/download/schedule_summary.json" class="btn btn-outline-success btn-lg mb-2">
                                <i class="fas fa-file-chart-line me-2"></i>
                                요약 통계 (JSON)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="text-center" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5>결과를 불러올 수 없습니다</h5>
            <p class="text-muted">시험 시간표를 먼저 생성해주세요.</p>
            <a href="/configure" class="btn btn-primary">
                <i class="fas fa-cog me-2"></i>
                설정 페이지로 이동
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadResults();
});

function loadResults() {
    fetch('/api/results')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResults(data.result, data.summary);
        } else {
            showErrorState();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorState();
    });
}

function displayResults(result, summary) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsContent').style.display = 'block';
    
    // Update summary cards
    document.getElementById('totalStudents').textContent = summary.total_students || 0;
    document.getElementById('totalSubjects').textContent = summary.total_subjects || 0;
    document.getElementById('totalSlots').textContent = summary.total_slots || 0;
    
    // Calculate average exams per day
    const totalExams = Object.values(summary.exam_distribution || {}).reduce((sum, item) => sum + item.count, 0);
    const avgExams = totalExams > 0 ? (totalExams / (summary.total_students || 1)).toFixed(1) : 0;
    document.getElementById('avgExamsPerDay').textContent = avgExams;
    
    // Display schedule table
    displayScheduleTable(result.slot_assignments || {});
    
    // Create distribution charts
    createDistributionCharts(summary);
    
    // Display detailed analysis
    displayDetailedAnalysis(summary);
}

function displayScheduleTable(slotAssignments) {
    const tbody = document.getElementById('scheduleTableBody');
    tbody.innerHTML = '';
    
    const slots = Object.keys(slotAssignments).sort();
    
    if (slots.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">배정된 과목이 없습니다.</td></tr>';
        return;
    }
    
    slots.forEach(slot => {
        const subjects = slotAssignments[slot];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${slot}</strong></td>
            <td>${subjects.join(', ')}</td>
            <td><span class="badge bg-primary">${subjects.length}</span></td>
        `;
        tbody.appendChild(row);
    });
}

function createDistributionCharts(summary) {
    // Exam distribution chart
    const examCtx = document.createElement('canvas');
    examCtx.id = 'examChart';
    document.getElementById('examDistributionChart').appendChild(examCtx);
    
    const examData = summary.exam_distribution || {};
    const examLabels = Object.keys(examData).map(key => `${key}과목`);
    const examValues = Object.values(examData).map(item => item.count);
    
    new Chart(examCtx, {
        type: 'doughnut',
        data: {
            labels: examLabels,
            datasets: [{
                data: examValues,
                backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Hard exam distribution chart
    const hardExamCtx = document.createElement('canvas');
    hardExamCtx.id = 'hardExamChart';
    document.getElementById('hardExamDistributionChart').appendChild(hardExamCtx);
    
    const hardExamData = summary.hard_exam_distribution || {};
    const hardExamLabels = Object.keys(hardExamData).map(key => `${key}과목`);
    const hardExamValues = Object.values(hardExamData).map(item => item.count);
    
    new Chart(hardExamCtx, {
        type: 'doughnut',
        data: {
            labels: hardExamLabels,
            datasets: [{
                data: hardExamValues,
                backgroundColor: ['#17a2b8', '#fd7e14', '#e83e8c']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function displayDetailedAnalysis(summary) {
    // Students with 3 exams per day
    const studentsWith3 = summary.exam_distribution?.[3]?.students || [];
    const studentsWith3Div = document.getElementById('studentsWith3Exams');
    
    if (studentsWith3.length === 0) {
        studentsWith3Div.innerHTML = '<p class="text-success">해당하는 학생이 없습니다.</p>';
    } else {
        let html = `<p class="text-warning"><strong>${studentsWith3.length}명</strong></p>`;
        studentsWith3.slice(0, 5).forEach(student => {
            html += `<div class="badge bg-warning text-dark me-1 mb-1">${student}</div>`;
        });
        if (studentsWith3.length > 5) {
            html += `<div class="badge bg-secondary me-1 mb-1">...외 ${studentsWith3.length - 5}명</div>`;
        }
        studentsWith3Div.innerHTML = html;
    }
    
    // Students with 2 hard exams per day
    const studentsWith2Hard = summary.hard_exam_distribution?.[2]?.students || [];
    const studentsWith2HardDiv = document.getElementById('studentsWith2HardExams');
    
    if (studentsWith2Hard.length === 0) {
        studentsWith2HardDiv.innerHTML = '<p class="text-success">해당하는 학생이 없습니다.</p>';
    } else {
        let html = `<p class="text-warning"><strong>${studentsWith2Hard.length}명</strong></p>`;
        studentsWith2Hard.slice(0, 5).forEach(student => {
            html += `<div class="badge bg-warning text-dark me-1 mb-1">${student}</div>`;
        });
        if (studentsWith2Hard.length > 5) {
            html += `<div class="badge bg-secondary me-1 mb-1">...외 ${studentsWith2Hard.length - 5}명</div>`;
        }
        studentsWith2HardDiv.innerHTML = html;
    }
}

function showErrorState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
}
</script>
{% endblock %} 