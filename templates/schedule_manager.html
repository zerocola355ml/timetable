{% extends "base.html" %}

{% block title %}ì‹œí—˜ ì‹œê°„í‘œ ê´€ë¦¬ - ì‹œí—˜ ì‹œê°„í‘œ ë°°ì • ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
/* ì „ì²´ ë ˆì´ì•„ì›ƒ */
html, body {
    overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ìˆ¨ê¸°ê¸° */
    overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
}

.schedule-manager-container {
    min-height: calc(100vh - 80px); /* heightë¥¼ min-heightë¡œ ë³€ê²½ */
    /* overflow: hidden ì œê±°í•˜ì—¬ ìŠ¤í¬ë¡¤ í—ˆìš© */
}

.schedule-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 1.5rem 0;
    margin-bottom: 1rem;
    backdrop-filter: blur(10px);
    animation: fadeInUp 0.6s ease-out;
}

/* ìƒë‹¨ ì •ë³´ ë°” ìŠ¤íƒ€ì¼ */
.info-stats {
    font-size: 0.9rem;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
}

.stat-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.5rem;
    padding: 0 1rem;
    border-right: 1px solid rgba(255,255,255,0.4);
}

.stat-item:last-child {
    border-right: none;
}

.stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.stat-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.stat-value.warning {
    color: #ffc107;
    text-shadow: 0 1px 2px rgba(0,0,0,0.7);
}

.stat-value.danger {
    color: #ff6b6b;
    text-shadow: 0 1px 2px rgba(0,0,0,0.7);
}

.schedule-content {
    display: flex;
    align-items: stretch; /* ì¤‘ìš”: ë‘ íŒ¨ë„ì˜ ë†’ì´ë¥¼ ê°™ê²Œ! */
    gap: 1rem;
    padding: 1rem 0; /* ìƒí•˜ ì—¬ë°± ì¶”ê°€ */
}

/* ì¢Œì¸¡ íŒ¨ë„ */
.left-panel {
    width: 200px;
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    /* ë†’ì´ ë¯¸ì§€ì •! ìë™ìœ¼ë¡œ main-panelê³¼ ë™ì¼í•´ì§ */
}

.subject-list {
    flex: 1 1 0;
    overflow-y: auto; /* ë§ì„ ë•Œë§Œ subject-list ì˜ì—­ì— ìŠ¤í¬ë¡¤ */
    margin: 0;
    margin-bottom: 0;
    min-height: 0; /* flexboxì—ì„œ stretchì‹œ overflow ì œëŒ€ë¡œ ì‘ë™ */
    padding-bottom: 0.5rem; /* í•˜ë‹¨ ì—¬ë°± */
    padding-right: 0.25rem; /* ìŠ¤í¬ë¡¤ë°”ì™€ ì—¬ë°± */
}

.subject-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 0.375rem;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
    position: relative;
    z-index: 2;
}

.subject-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.subject-item:active {
    cursor: grabbing;
}

.subject-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

/* ì¶”ì²œ ê³¼ëª© ìŠ¤íƒ€ì¼ */
.recommendation-section {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    background: #f8fafc;
}

.recommended-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin: 4px 0;
    background: white;
    border: 2px solid #fbbf24;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.recommended-item:hover {
    background: #fffbeb;
    border-color: #f59e0b;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
}

.recommended-item .subject-name {
    font-weight: 500;
    color: #1f2937;
    font-size: 13px;
}

.recommended-item .priority-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 12px;
    font-weight: 600;
}

.priority-high {
    background: #fee2e2;
    color: #dc2626;
}

.priority-medium {
    background: #fef3c7;
    color: #d97706;
}

.priority-low {
    background: #d1fae5;
    color: #059669;
}

.recommended-item .reason-icon {
    color: #6b7280;
    margin-left: 4px;
    cursor: help;
}


.banner-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0;
    min-height: auto;
}

.banner-icon {
    font-size: 18px;
    margin-right: 10px;
    animation: pulse 2s infinite;
}

.banner-text {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 6px;
}

.banner-label {
    font-weight: 600;
    font-size: 14px;
    opacity: 0.9;
}

.banner-recommendations {
    font-size: 14px;
    line-height: 1.4;
}

/* ìƒì„¸ì •ë³´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#bannerDetailsBtn {
    padding: 4px 8px;
    font-size: 11px;
    border-color: rgba(255,255,255,0.3);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}

#bannerDetailsBtn:hover {
    background: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.6);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* ì¶”ì²œ ê³¼ëª© í•­ëª© ìŠ¤íƒ€ì¼ */
.banner-recommendation-item {
    display: inline-flex;
    align-items: center;
    background: rgba(255,255,255,0.15);
    padding: 4px 8px;
    border-radius: 12px;
    margin-right: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
}

.banner-recommendation-item:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
}

.banner-recommendation-item .priority-badge {
    font-size: 10px;
    padding: 2px 4px;
    border-radius: 8px;
    margin-right: 4px;
    font-weight: 600;
}

.banner-recommendation-item .priority-1 {
    background: #ef4444;
    color: white;
}

.banner-recommendation-item .priority-2 {
    background: #f59e0b;
    color: white;
}

.banner-recommendation-item .priority-3 {
    background: #10b981;
    color: white;
}

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes fadeInUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}


@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .banner-content {
        padding: 8px 0;
        min-height: 40px;
    }
    
    .banner-icon {
        font-size: 16px;
        margin-right: 8px;
    }
    
    .banner-label, .banner-recommendations {
        font-size: 12px;
    }
    
    .banner-recommendation-item {
        font-size: 11px;
        padding: 2px 6px;
        margin-right: 4px;
    }
    
    .banner-actions {
        gap: 4px;
    }
}

/* ë°°ë„ˆê°€ ë‹«íŒ ìƒíƒœ */
.recommendation-banner.collapsed {
    height: 0;
    overflow: hidden;
    padding: 0;
}

.subject-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
}

.subject-info {
    font-size: 0.8rem;
    color: #6c757d;
}

.subject-duration {
    color: #0d6efd;
    font-weight: 500;
}

.subject-grade {
    color: #28a745;
}

.subject-student-count {
    color: #6f42c1;
    font-weight: 500;
}

/* í•™ìƒ ë¶€ë‹´ ë¶„ì„ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
.student-burden-panel {
    flex: 0 0 auto; /* ê³ ì • í¬ê¸° */
    margin-top: 0.5rem; /* ìƒë‹¨ ì—¬ë°± ì¤„ì„ */
    /* heightì™€ overflow ì œê±°ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ë†’ì´ í™•ì¥ í—ˆìš© */
}

.burden-table {
    table-layout: fixed;
    font-size: 0.85rem;
}

.burden-header {
    background-color: #f8f9fa;
    font-weight: 600;
    width: 80px;
    text-align: center;
}

.burden-cell {
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 80px;
    padding: 0.5rem 0.25rem;
}

.burden-cell:hover {
    background-color: #e9ecef;
}

.burden-cell.normal {
    color: #28a745;
    background-color: #d4edda;
}

.burden-cell.warning {
    color: #ffc107;
    background-color: #fff3cd;
}

.burden-cell.danger {
    color: #dc3545;
    background-color: #f8d7da;
}

.burden-cell.normal:hover {
    background-color: #c3e6cb;
}

.burden-cell.warning:hover {
    background-color: #ffeaa7;
}

.burden-cell.danger:hover {
    background-color: #f1aeb5;
}

#burdenPanelBody.collapsed {
    display: none;
}

.burden-section h6 {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

/* ì¢Œì¸¡ íŒ¨ë„ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ */
.left-panel-buttons {
    flex-shrink: 0; /* ë²„íŠ¼ ì˜ì—­ì´ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
    flex-grow: 0; /* ëŠ˜ì–´ë‚˜ì§€ë„ ì•Šë„ë¡ */
    margin-top: 0.5rem; /* ìœ„ìª½ ì—¬ë°± */
    padding: 0.75rem 0 0 0; /* ìœ„ìª½ íŒ¨ë”© */
    border-top: 1px solid #dee2e6;
    background: #f8f9fa; /* ë°°ê²½ìƒ‰ ë™ì¼ */
    /* sticky ì œê±°ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ìœ„ì¹˜ */
}

/* ì¤‘ì•™ ë©”ì¸ ì˜ì—­ */
.main-panel {
    flex: 1;
    min-height: 0; /* flexbox shrink fix, í•„ìš”ì‹œ */
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    /* ìŠ¤í¬ë¡¤ ì—†ìŒ: overflow ì†ì„± ì§€ì •í•˜ì§€ ì•ŠìŒ */
}

.schedule-grid-container {
    min-width: 800px;
    overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ë§Œ ìœ ì§€ (í…Œì´ë¸”ì´ ë„ˆë¬´ ë„“ì„ ë•Œ) */
    width: 100%;
    flex: 0 0 auto; /* ê³ ì • í¬ê¸°ë¡œ ë³€ê²½ - í•„ìš”í•œ ê³µê°„ë§Œ ì°¨ì§€ */
    margin-bottom: 0; /* í•˜ë‹¨ ì—¬ë°± ì œê±° */
}


.schedule-grid {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    overflow: hidden;
    margin: 0; /* í…Œì´ë¸” ì—¬ë°± ì œê±° */
}

.schedule-grid th {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    border: 1px solid #6366f1;
}

.schedule-grid td {
    height: 80px; /* ë†’ì´ ì¤„ì„ */
    min-width: 100px;
    width: auto;
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    vertical-align: top;
    position: relative;
    background: #fafafa;
    transition: all 0.2s ease;
    z-index: 1;
}

.schedule-grid td:hover {
    background: #f0f9ff;
    border-color: #0ea5e9;
}

.schedule-grid td.drop-zone {
    background: #dbeafe;
    border-color: #0ea5e9;
    border-style: dashed;
    border-width: 2px;
}

.schedule-grid td.drop-zone-invalid {
    background: #fecaca;
    border-color: #ef4444;
    border-style: dashed;
    border-width: 2px;
}

.schedule-grid td.drop-zone-warning {
    background: #fef3c7;
    border-color: #f59e0b;
    border-style: dashed;
    border-width: 2px;
}

.schedule-grid td.drop-zone-recommended {
    background: #d1fae5;
    border-color: #10b981;
    border-style: solid;
    border-width: 3px;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}

/* ë‚ ì§œ ì „ì²´ ë¶€ë‹´ ì´ˆê³¼ ìŠ¤íƒ€ì¼ */
.schedule-grid th.date-burden-warning,
.schedule-grid td.date-burden-warning {
    border-left: 3px dashed #f97316 !important;
    border-right: 3px dashed #f97316 !important;
}

.schedule-grid th.date-burden-warning {
    border-top: 3px dashed #f97316 !important;
}

.schedule-grid tr:last-child td.date-burden-warning {
    border-bottom: 3px dashed #f97316 !important;
}

.tool-btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.tool-btn-warning:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
}

.time-slot-header {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.assigned-subject {
    background: #e0e7ff;
    border: 1px solid #6366f1;
    border-radius: 0.25rem;
    padding: 0.375rem;
    margin-bottom: 0.25rem;
    cursor: move;
    transition: all 0.2s ease;
    position: relative;
    z-index: 2;
}

.assigned-subject:hover {
    background: #c7d2fe;
    border-color: #4f46e5;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.assigned-subject.dragging {
    opacity: 0.7;
    transform: rotate(3deg);
    z-index: 1000;
}

.assigned-subject-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: #4f46e5;
    margin-bottom: 0.125rem;
}

.assigned-subject-info {
    font-size: 0.7rem;
    color: #6b7280;
}

.assigned-subject-actions {
    position: absolute;
    top: 2px;
    right: 2px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.assigned-subject:hover .assigned-subject-actions {
    opacity: 1;
}

.btn-remove-subject {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-remove-subject:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.assigned-subject {
    position: relative;
}

/* ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
.context-menu-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 0.875rem;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item:first-child {
    border-radius: 0.375rem 0.375rem 0 0;
}

.context-menu-item:last-child {
    border-radius: 0 0 0.375rem 0.375rem;
}

/* ìš°ì¸¡ íŒ¨ë„ ì œê±° - ìƒë‹¨ìœ¼ë¡œ ì´ë™ */

.info-section {
    background: white;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
}

.info-section h6 {
    color: #374151;
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* ë„êµ¬ ë²„íŠ¼ */
.tool-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

/* ìƒë‹¨ í—¤ë”ì˜ ë„êµ¬ ë²„íŠ¼ë“¤ */
.schedule-header .tool-buttons {
    margin-bottom: 0;
    align-items: center;
    height: 100%;
}

.tool-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.tool-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.tool-btn-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.tool-btn-secondary {
    background: #6c757d;
    color: white;
}

.tool-btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.tool-btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.tool-btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.tool-btn-danger {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
}

.tool-btn-danger:hover {
    background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.tool-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

/* í†µê³„ ì¹´ë“œ */
.stat-card {
    background: white;
    border-radius: 0.375rem;
    padding: 0.75rem;
    text-align: center;
    border: 1px solid #dee2e6;
    margin-bottom: 0.75rem;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

/* ì§„í–‰ë¥  í‘œì‹œ */
.progress-container {
    background: white;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
}

.progress-bar-custom {
    background: #e5e7eb;
    border-radius: 0.5rem;
    height: 0.5rem;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    height: 100%;
    border-radius: 0.5rem;
    transition: width 0.3s ease;
}

/* ë°˜ì‘í˜• */
@media (max-width: 1200px) {
    .schedule-content {
        flex-direction: column;
        height: auto;
    }
    
    .left-panel {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .schedule-grid-container {
        overflow-x: auto;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ìƒë‹¨ ë°” ì¡°ì • */
    .col-md-4 {
        margin-bottom: 0.5rem;
    }
    
    .info-stats {
        flex-direction: row;
        justify-content: space-around;
    }
    
    .stat-item {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        padding: 0.25rem 0;
        margin: 0 0.5rem;
    }
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
/* ì¢Œì¸¡ íŒ¨ë„ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
.left-panel::-webkit-scrollbar,
.subject-list::-webkit-scrollbar {
    width: 6px;
}

.left-panel::-webkit-scrollbar-track,
.subject-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.left-panel::-webkit-scrollbar-thumb,
.subject-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.left-panel::-webkit-scrollbar-thumb:hover,
.subject-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

{% block content %}
<div class="schedule-manager-container">
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="schedule-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <!-- ì™¼ìª½: ì¶”ì²œ ë‚´ìš© -->
                <div class="col-md-6">
                    <div class="banner-content">
                        <div class="banner-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="banner-text" id="bannerText">
                            <span class="banner-label">ì¶”ì²œ:</span>
                            <button class="btn btn-sm btn-outline-light me-2" id="bannerDetailsBtn" title="ìƒì„¸ ì •ë³´">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <span class="banner-recommendations" id="bannerRecommendations">
                                ê³¼ëª©ì„ ë°°ì¹˜í•˜ë©´ ì¶”ì²œì´ í‘œì‹œë©ë‹ˆë‹¤
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ë“¤ -->
                <div class="col-md-6 text-end">
                    <div class="tool-buttons d-flex align-items-center justify-content-end gap-3">
                        <!-- í†µí•© ìë™ìƒì„± ë“œë¡­ë‹¤ìš´ -->
                        <div class="dropdown">
                            <button class="tool-btn tool-btn-primary dropdown-toggle" type="button" id="autoGenerateDropdown" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
                                <i class="fas fa-magic me-2"></i>
                                ìë™ìƒì„±
                                <span class="badge bg-light text-dark ms-2" id="timeBadge">ê³ í’ˆì§ˆ</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="autoGenerateDropdown" style="z-index: 9999999; position: fixed;">
                                <li><h6 class="dropdown-header">ìƒì„± ëª¨ë“œ ì„ íƒ</h6></li>
                                <li><a class="dropdown-item" href="#" data-time="10" data-text="ë¹ ë¦„">
                                    ğŸš€ ë¹ ë¦„ (10ì´ˆ)
                                    <small class="text-muted d-block">ë¹ ë¥¸ í™•ì¸ìš©</small>
                                </a></li>
                                <li><a class="dropdown-item" href="#" data-time="60" data-text="ê· í˜•">
                                    âš–ï¸ ê· í˜• (1ë¶„)
                                    <small class="text-muted d-block">ì¼ë°˜ ì‚¬ìš©</small>
                                </a></li>
                                <li><a class="dropdown-item" href="#" data-time="120" data-text="ê³ í’ˆì§ˆ">
                                    ğŸ¯ ê³ í’ˆì§ˆ (2ë¶„)
                                    <small class="text-muted d-block">ìµœì  ê²°ê³¼</small>
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-time="custom" data-text="ì‚¬ìš©ì ì„¤ì •">
                                    âš™ï¸ ì‚¬ìš©ì ì„¤ì •
                                </a></li>
                            </ul>
                        </div>
                        
                        <!-- ì‚¬ìš©ì ì„¤ì • ì…ë ¥ (ìˆ¨ê¹€) -->
                        <div id="customTimeInput" class="me-2" style="display: none;">
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <input type="number" class="form-control" id="customTimeValue" min="5" max="300" value="120" placeholder="ì´ˆ">
                                <span class="input-group-text">ì´ˆ</span>
                            </div>
                        </div>
                        <button class="tool-btn tool-btn-warning" id="validateBtn">
                            <i class="fas fa-check-circle"></i>
                            ê²€ì¦
                        </button>
                        <button class="tool-btn tool-btn-danger" id="clearAllBtn">
                            <i class="fas fa-trash"></i>
                            ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container-fluid">
        <div class="schedule-content">
            <!-- ì¢Œì¸¡ íŒ¨ë„ -->
            <div class="left-panel">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-book text-primary"></i>
                        ê³¼ëª©
                    </h6>
                    <small class="text-muted">
                        <span id="sidebarAssignedCount">0</span>/<span id="sidebarTotalCount">0</span>
                    </small>
                </div>
                
                <!-- ê³¼ëª© ëª©ë¡ -->
                <div class="subject-list" id="subjectList">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i>
                        ë¡œë”©ì¤‘...
                    </div>
                </div>

                <!-- ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ (ìˆ¨ê¹€ - ìƒë‹¨ ë°°ë„ˆë¡œ ì´ë™ë¨) -->
                <div class="recommendation-section mb-3" style="display: none;">
                    <h6 class="mb-2">
                        <i class="fas fa-lightbulb text-warning"></i>
                        ì¶”ì²œ ê³¼ëª©
                    </h6>
                    <div id="recommendedSubjects">
                        <div class="text-center text-muted py-2">
                            <small>ê³¼ëª©ì„ ë°°ì¹˜í•˜ë©´ ì¶”ì²œì´ í‘œì‹œë©ë‹ˆë‹¤</small>
                        </div>
                    </div>
                </div>

                <!-- ë¹ ë¥¸ ë„êµ¬ ì˜ì—­ì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ëª¨ë“  ë²„íŠ¼ì´ ìƒë‹¨ìœ¼ë¡œ ì´ë™ë¨) -->
            </div>

            <!-- ì¤‘ì•™ ë©”ì¸ ì˜ì—­ -->
            <div class="main-panel">
                <div class="schedule-grid-container">
                    <table class="schedule-grid" id="scheduleGrid">
                        <thead>
                            <tr>
                                <th style="width: 80px;">êµì‹œ</th>
                                <!-- ë‚ ì§œ í—¤ë”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                            </tr>
                        </thead>
                        <tbody id="scheduleGridBody">
                            <!-- ì‹œê°„í‘œ ê·¸ë¦¬ë“œëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </tbody>
                    </table>
                </div>
                
                <!-- í•™ìƒ ë¶€ë‹´ ë¶„ì„ íŒ¨ë„ -->
        <div class="student-burden-panel mt-3" id="studentBurdenPanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar text-info me-2"></i>
                        í•™ìƒ ë¶€ë‹´ ë¶„ì„
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleBurdenPanel" type="button">
                        <i class="fas fa-chevron-up" id="burdenPanelIcon"></i>
                    </button>
                </div>
                <div class="card-body" id="burdenPanelBody">
                    <!-- ì¼ë°˜ ê³¼ëª© ë¶€ë‹´ ë¶„ì„ -->
                    <div class="burden-section mb-4" id="generalBurdenSection">
                        <h6 class="text-secondary mb-3">
                            <i class="fas fa-books me-2"></i>
                            í•˜ë£¨ ì‹œí—˜ ê³¼ëª© ìˆ˜ ë¶„í¬
                            <small class="text-muted">(ìµœëŒ€ <span id="maxExamsPerDay">ì„¤ì • ì—†ìŒ</span>ê°œ)</small>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered burden-table" id="generalBurdenTable">
                                <thead>
                                    <tr class="table-light">
                                        <th class="burden-header">ê³¼ëª© ìˆ˜</th>
                                        <!-- ë‚ ì§œ í—¤ë”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                                    </tr>
                                </thead>
                                <tbody id="generalBurdenTableBody">
                                    <!-- ë¶€ë‹´ ë¶„ì„ ë°ì´í„°ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì–´ë ¤ìš´ ê³¼ëª© ë¶€ë‹´ ë¶„ì„ -->
                    <div class="burden-section" id="hardBurdenSection">
                        <h6 class="text-secondary mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ì–´ë ¤ìš´ ê³¼ëª© ìˆ˜ ë¶„í¬
                            <small class="text-muted">(ìµœëŒ€ <span id="maxHardExamsPerDay">ì„¤ì • ì—†ìŒ</span>ê°œ)</small>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered burden-table" id="hardBurdenTable">
                                <thead>
                                    <tr class="table-light">
                                        <th class="burden-header">ê³¼ëª© ìˆ˜</th>
                                        <!-- ë‚ ì§œ í—¤ë”ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                                    </tr>
                                </thead>
                                <tbody id="hardBurdenTableBody">
                                    <!-- ì–´ë ¤ìš´ ê³¼ëª© ë¶€ë‹´ ë¶„ì„ ë°ì´í„°ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </div>

        </div>
    </div>
</div>

<!-- í•™ìƒ ë¶€ë‹´ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
<div class="modal fade" id="burdenDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="burdenDetailTitle">
                    <i class="fas fa-users me-2"></i>
                    ìƒì„¸ ì •ë³´
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="burdenDetailContent">
                    <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                <h5 id="loadingTitle">ì²˜ë¦¬ ì¤‘...</h5>
                <p class="text-muted" id="loadingMessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                
                <!-- ì§„í–‰ë¥  ë°” (ìë™ìƒì„± ì‹œì—ë§Œ í‘œì‹œ) -->
                <div id="progressContainer" style="display: none;" class="mt-3">
                    <div class="progress mb-2" style="height: 8px;">
                        <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" id="progressText">0%</small>
                </div>
                
                <!-- ë‹¨ê³„ë³„ ë©”ì‹œì§€ (ìë™ìƒì„± ì‹œì—ë§Œ í‘œì‹œ) -->
                <div id="stepContainer" style="display: none;" class="mt-3">
                    <div class="text-start">
                        <small class="text-muted" id="currentStep">ì¤€ë¹„ ì¤‘...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ì „ì—­ ë³€ìˆ˜
let examInfo = {};
let subjectInfo = {};
let scheduleData = {};
let selectedSlot = null;
let isDragging = false;
let validationCache = new Map(); // ê²€ì¦ ê²°ê³¼ ìºì‹œ

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    // ì œì•½ì¡°ê±´ ë°ì´í„° ë¡œë“œ
    await loadConstraintData();
    
    // ì‹œê°„í‘œ ë§¤ë‹ˆì € ì´ˆê¸°í™”
    initializeScheduleManager();
    
    // ì €ì¥ëœ ìˆ˜ë™ ë°°ì¹˜ ë°ì´í„° ë¡œë“œ
    await loadManualSchedule();
    
    // ì´ˆê¸° ì¶”ì²œ ìƒì„±
    setTimeout(() => {
        updateRecommendationBanner();
    }, 1000);
});

async function initializeScheduleManager() {
    try {
        showLoading('ë°ì´í„° ë¡œë”©', 'ì‹œí—˜ ì •ë³´ì™€ ê³¼ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ë°ì´í„° ë¡œë“œ
        await loadExamInfo();
        await loadSubjectInfo();
        
        console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ, UI ë Œë”ë§ ì‹œì‘...');
        
        // UI ë Œë”ë§
        try {
            renderSubjectList();
            console.log('ê³¼ëª© ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
            
            renderScheduleGrid();
            console.log('ì‹œê°„í‘œ ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ');
            
            updateStatistics();
            console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        } catch (renderError) {
            console.error('UI ë Œë”ë§ ì˜¤ë¥˜:', renderError);
            throw renderError;
        }
        
        console.log('ì‹œê°„í‘œ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ');
        
        // í•™ìƒ ë¶€ë‹´ ë¶„ì„ íŒ¨ë„ ì´ˆê¸°í™”
        initializeBurdenPanelToggle();
        
        // í•™ìƒ ë¶€ë‹´ ì„¤ì •ì´ ìˆê±°ë‚˜ ì„¤ì •ì´ ì—†ì–´ë„ ë¶„ì„ì€ ì‹¤í–‰ (ë‹¨ìˆœ ì¹´ìš´íŠ¸ë§Œ)
        console.log('í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì´ˆê¸°í™” ì‹œì‘...');
        console.log('window.studentBurdenConfig:', window.studentBurdenConfig);
        console.log('constraintData:', constraintData);
        
        // íŒ¨ë„ì´ ì ‘í˜€ìˆëŠ”ì§€ í™•ì¸
        const panelBody = document.getElementById('burdenPanelBody');
        console.log('íŒ¨ë„ ìƒíƒœ:', panelBody ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ');
        if (panelBody) {
            console.log('íŒ¨ë„ í´ë˜ìŠ¤:', panelBody.className);
            console.log('íŒ¨ë„ì´ ì ‘í˜€ìˆëŠ”ê°€?', panelBody.classList.contains('collapsed'));
        }
        
        renderStudentBurdenAnalysis();
        
        // ë Œë”ë§ í›„ íŒ¨ë„ ì „ì²´ ìƒíƒœ í™•ì¸
        setTimeout(() => {
            const panel = document.getElementById('studentBurdenPanel');
            const panelBody = document.getElementById('burdenPanelBody');
            console.log('=== íŒ¨ë„ ìµœì¢… ìƒíƒœ í™•ì¸ ===');
            console.log('íŒ¨ë„ ì¡´ì¬:', panel ? 'ìˆìŒ' : 'ì—†ìŒ');
            console.log('íŒ¨ë„ display:', panel ? panel.style.display : 'N/A');
            console.log('íŒ¨ë„ ë†’ì´:', panel ? panel.offsetHeight : 'N/A');
            console.log('íŒ¨ë„ ë°”ë”” ì¡´ì¬:', panelBody ? 'ìˆìŒ' : 'ì—†ìŒ');
            console.log('íŒ¨ë„ ë°”ë”” í´ë˜ìŠ¤:', panelBody ? panelBody.className : 'N/A');
            console.log('íŒ¨ë„ ë°”ë”” display:', panelBody ? panelBody.style.display : 'N/A');
            console.log('íŒ¨ë„ ë°”ë”” ë†’ì´:', panelBody ? panelBody.offsetHeight : 'N/A');
            
            // í…Œì´ë¸”ë“¤ë„ í™•ì¸
            const generalTable = document.getElementById('generalBurdenTable');
            const hardTable = document.getElementById('hardBurdenTable');
            console.log('ì¼ë°˜ í…Œì´ë¸” ë†’ì´:', generalTable ? generalTable.offsetHeight : 'N/A');
            console.log('ì–´ë ¤ìš´ í…Œì´ë¸” ë†’ì´:', hardTable ? hardTable.offsetHeight : 'N/A');
            
            // íŒ¨ë„ ìœ„ì¹˜ ì •ë³´ í™•ì¸
            if (panel) {
                const rect = panel.getBoundingClientRect();
                console.log('íŒ¨ë„ ìœ„ì¹˜ ì •ë³´:');
                console.log('  top:', rect.top, 'left:', rect.left);
                console.log('  width:', rect.width, 'height:', rect.height);
                console.log('  í™”ë©´ì— ë³´ì´ëŠ”ê°€?', rect.top >= 0 && rect.top <= window.innerHeight);
                console.log('  í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜:', window.pageYOffset);
                console.log('  íŒ¨ë„ê¹Œì§€ ìŠ¤í¬ë¡¤ í•„ìš”:', rect.top + window.pageYOffset);
                
                // íŒ¨ë„ì´ í™”ë©´ ë°–ì— ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤í•´ì„œ ë³´ì´ê²Œ í•˜ê¸°
                if (rect.top < 0 || rect.top > window.innerHeight) {
                    console.log('íŒ¨ë„ì´ í™”ë©´ ë°–ì— ìˆì–´ì„œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤');
                    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }, 100);
        
        // ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ë¡œë”© ìˆ¨ê¸°ê¸° (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ UI ë Œë”ë§ ì™„ë£Œ ë³´ì¥)
        setTimeout(() => {
            hideLoading();
        }, 500);
        
    } catch (error) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        hideLoading();
        showAlert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
    }
}

// ì‹œí—˜ ì •ë³´ ë¡œë“œ
async function loadExamInfo() {
    try {
        console.log('ì‹œí—˜ ì •ë³´ ë¡œë“œ ì‹œì‘...');
        const response = await fetch('/api/data/exam_info.json');
        console.log('ì‹œí—˜ ì •ë³´ API ì‘ë‹µ:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ì‹œí—˜ ì •ë³´ API ì˜¤ë¥˜:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        examInfo = await response.json();
        console.log('ì‹œí—˜ ì •ë³´ ë¡œë“œ ì™„ë£Œ:', examInfo);
    } catch (error) {
        console.error('ì‹œí—˜ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        // ê¸°ë³¸ê°’ ì„¤ì •
        examInfo = {
            "ì‹œí—˜ë‚ ì§œ": {"ì œ1ì¼": "2024-10-01", "ì œ2ì¼": "2024-10-02", "ì œ3ì¼": "2024-10-03"},
            "ì‹œí—˜íƒ€ì„": {
                "ì œ1ì¼1êµì‹œ": {"ì‹œì‘": "09:00:00", "ì¢…ë£Œ": "10:20:00", "ì§„í–‰ì‹œê°„": 80},
                "ì œ1ì¼2êµì‹œ": {"ì‹œì‘": "10:40:00", "ì¢…ë£Œ": "11:30:00", "ì§„í–‰ì‹œê°„": 50},
                "ì œ1ì¼3êµì‹œ": {"ì‹œì‘": "11:50:00", "ì¢…ë£Œ": "13:30:00", "ì§„í–‰ì‹œê°„": 100},
                "ì œ2ì¼1êµì‹œ": {"ì‹œì‘": "09:00:00", "ì¢…ë£Œ": "10:20:00", "ì§„í–‰ì‹œê°„": 80},
                "ì œ2ì¼2êµì‹œ": {"ì‹œì‘": "10:40:00", "ì¢…ë£Œ": "11:30:00", "ì§„í–‰ì‹œê°„": 50},
                "ì œ2ì¼3êµì‹œ": {"ì‹œì‘": "11:50:00", "ì¢…ë£Œ": "13:30:00", "ì§„í–‰ì‹œê°„": 100},
                "ì œ3ì¼1êµì‹œ": {"ì‹œì‘": "09:00:00", "ì¢…ë£Œ": "10:20:00", "ì§„í–‰ì‹œê°„": 80},
                "ì œ3ì¼2êµì‹œ": {"ì‹œì‘": "10:40:00", "ì¢…ë£Œ": "11:30:00", "ì§„í–‰ì‹œê°„": 50},
                "ì œ3ì¼3êµì‹œ": {"ì‹œì‘": "11:50:00", "ì¢…ë£Œ": "13:30:00", "ì§„í–‰ì‹œê°„": 100}
            }
        };
        console.log('ê¸°ë³¸ ì‹œí—˜ ì •ë³´ ì‚¬ìš©:', examInfo);
    }
}

// ê³¼ëª© ì •ë³´ ë¡œë“œ
async function loadSubjectInfo() {
    try {
        console.log('ê³¼ëª© ì •ë³´ ë¡œë“œ ì‹œì‘...');
        const response = await fetch('/api/data/subject_info.json');
        console.log('ê³¼ëª© ì •ë³´ API ì‘ë‹µ:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('ê³¼ëª© ì •ë³´ API ì˜¤ë¥˜:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        subjectInfo = await response.json();
        console.log('ê³¼ëª© ì •ë³´ ë¡œë“œ ì™„ë£Œ:', Object.keys(subjectInfo).length + 'ê°œ ê³¼ëª©');
    } catch (error) {
        console.error('ê³¼ëª© ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        // ê¸°ë³¸ê°’ ì„¤ì •
        subjectInfo = {
            "êµ­ì–´": {"ì‹œê°„": 50, "í•™ë…„": "1", "ë‹´ë‹¹êµì‚¬": ["ê¹€êµì‚¬"], "ë“£ê¸°í‰ê°€": false},
            "ìˆ˜í•™": {"ì‹œê°„": 80, "í•™ë…„": "1", "ë‹´ë‹¹êµì‚¬": ["ì´êµì‚¬"], "ë“£ê¸°í‰ê°€": false},
            "ì˜ì–´": {"ì‹œê°„": 50, "í•™ë…„": "1", "ë‹´ë‹¹êµì‚¬": ["ë°•êµì‚¬"], "ë“£ê¸°í‰ê°€": true},
            "ê³¼í•™": {"ì‹œê°„": 80, "í•™ë…„": "1", "ë‹´ë‹¹êµì‚¬": ["ìµœêµì‚¬"], "ë“£ê¸°í‰ê°€": false},
            "ì‚¬íšŒ": {"ì‹œê°„": 50, "í•™ë…„": "1", "ë‹´ë‹¹êµì‚¬": ["ì •êµì‚¬"], "ë“£ê¸°í‰ê°€": false}
        };
        console.log('ê¸°ë³¸ ê³¼ëª© ì •ë³´ ì‚¬ìš©:', Object.keys(subjectInfo).length + 'ê°œ ê³¼ëª©');
    }
}

// ê³¼ëª© ëª©ë¡ ë Œë”ë§
function renderSubjectList() {
    const subjectList = document.getElementById('subjectList');
    
    if (Object.keys(subjectInfo).length === 0) {
        subjectList.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-circle"></i>
                ê³¼ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        `;
        return;
    }
    
    let html = '';
    for (const [subjectName, subject] of Object.entries(subjectInfo)) {
        // ì´ë¯¸ ë°°ì¹˜ëœ ê³¼ëª©ì¸ì§€ í™•ì¸
        const isAssigned = isSubjectAssigned(subjectName);
        
        html += `
            <div class="subject-item ${isAssigned ? 'opacity-50' : ''}" 
                 draggable="true" 
                 data-subject="${subjectName}"
                 data-duration="${subject.ì‹œê°„ || 50}"
                 data-grade="${subject.í•™ë…„ || ''}"
                 data-listening="${subject.ë“£ê¸°í‰ê°€ || false}">
                <div class="subject-name">
                    ${subjectName}
                    ${subject.ë“£ê¸°í‰ê°€ ? '<span class="badge bg-warning ms-1">ë“£ê¸°</span>' : ''}
                </div>
                <div class="subject-info">
                    <span class="subject-duration">${subject.ì‹œê°„ || 50}ë¶„</span>
                    <span class="subject-grade ms-2">${subject.í•™ë…„ || ''}í•™ë…„</span>
                    ${constraintData.subjectStats[subjectName] && constraintData.subjectStats[subjectName].student_count ? 
                        `<span class="subject-student-count ms-2">${constraintData.subjectStats[subjectName].student_count}ëª…</span>` : ''}
                </div>
            </div>
        `;
    }
    
    subjectList.innerHTML = html;
    
    // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€
    addDragEventListeners();
    
    // ì´ ê³¼ëª© ìˆ˜ ì—…ë°ì´íŠ¸ (ì‚¬ì´ë“œë°”ë§Œ)
    const totalSubjects = Object.keys(subjectInfo).length;
    const sidebarTotalCount = document.getElementById('sidebarTotalCount');
    
    if (sidebarTotalCount) sidebarTotalCount.textContent = totalSubjects;
}

// ì‹œê°„í‘œ ê·¸ë¦¬ë“œ ë Œë”ë§
function renderScheduleGrid() {
    const scheduleGrid = document.getElementById('scheduleGrid');
    const thead = scheduleGrid.querySelector('thead tr');
    const tbody = document.getElementById('scheduleGridBody');
    
    // ë‚ ì§œ ì •ë³´ ì¶”ì¶œ (ë™ì ìœ¼ë¡œ ëª¨ë“  ë‚ ì§œ ì²˜ë¦¬)
    const examDates = examInfo.ì‹œí—˜ë‚ ì§œ || {};
    const validDates = Object.entries(examDates)
        .filter(([day, date]) => date && date !== 'nan' && date.trim() !== '')
        .sort((a, b) => {
            // ì œ1ì¼, ì œ2ì¼... ìˆœì„œë¡œ ì •ë ¬
            const numA = parseInt(a[0].match(/\d+/)?.[0] || '0');
            const numB = parseInt(b[0].match(/\d+/)?.[0] || '0');
            return numA - numB;
        }); // ë¬´ì œí•œ ë‚ ì§œ ì§€ì› (7ì¼ ì œí•œ ì œê±°)
    
    if (validDates.length === 0) {
        // ê¸°ë³¸ê°’ ì„¤ì •
        validDates.push(['ì œ1ì¼', '2024-10-01'], ['ì œ2ì¼', '2024-10-02'], ['ì œ3ì¼', '2024-10-03']);
    }
    
    // í—¤ë” ìƒì„± (ë‚ ì§œ)
    thead.innerHTML = '<th style="width: 80px;">êµì‹œ</th>';
    validDates.forEach(([dayLabel, date]) => {
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        
        thead.innerHTML += `
            <th class="text-center">
                <div class="fw-bold">${dayLabel}</div>
                <small class="opacity-75">${formattedDate}</small>
            </th>
        `;
    });
    
    // ì „ì²´ ì‚¬ìš© ê°€ëŠ¥í•œ êµì‹œë“¤ì„ ë¨¼ì € íŒŒì•…
    const allAvailablePeriods = new Set();
    const datePeriods = examInfo.date_periods || {};
    
    Object.values(datePeriods).forEach(dayPeriods => {
        Object.keys(dayPeriods).forEach(periodNum => {
            const periodData = dayPeriods[periodNum];
            if (!periodData._deleted) {
                allAvailablePeriods.add(parseInt(periodNum));
            }
        });
    });
    
    // êµì‹œê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ì‚¬ìš© (í•˜ë“œì½”ë”© ì œê±°)
    const periodsToRender = allAvailablePeriods.size > 0 ? 
        Array.from(allAvailablePeriods).sort((a, b) => a - b) : 
        [];
    
    console.log('ì „ì²´ ë Œë”ë§ êµì‹œë“¤:', periodsToRender);
    
    // êµì‹œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ê²½ê³ 
    if (periodsToRender.length === 0) {
        console.warn('êµì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. /exam-infoì—ì„œ ì‹œí—˜ ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted p-4">ì‹œí—˜ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>/exam-info í˜ì´ì§€ì—ì„œ ì‹œí—˜ ë‚ ì§œì™€ êµì‹œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</td></tr>';
        return;
    }
    
    // ë‚ ì§œë³„ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ êµì‹œ ë§¤í•‘ ìƒì„±
    const dateToAvailablePeriods = {};
    validDates.forEach(([dayLabel]) => {
        const dayMatch = dayLabel.match(/ì œ(\d+)ì¼/);
        if (dayMatch) {
            const dayNum = dayMatch[1];
            const dayPeriods = datePeriods[dayNum] || {};
            dateToAvailablePeriods[dayLabel] = new Set();
            
            Object.keys(dayPeriods).forEach(periodNum => {
                const periodData = dayPeriods[periodNum];
                if (!periodData._deleted) {
                    dateToAvailablePeriods[dayLabel].add(parseInt(periodNum));
                }
            });
            
            // ê¸°ë³¸ê°’ ì—†ìŒ (ì™„ì „íˆ ë™ì  ì²˜ë¦¬)
        }
    });
    
    console.log('ë‚ ì§œë³„ ì‚¬ìš©ê°€ëŠ¥ êµì‹œ:', dateToAvailablePeriods);
    
    // êµì‹œ í–‰ ìƒì„± (ë‚ ì§œë³„ ê°œë³„ êµì‹œ ì²˜ë¦¬)
    tbody.innerHTML = '';
    periodsToRender.forEach(period => {
        let rowHtml = `<th class="text-center fw-bold">${period}êµì‹œ</th>`;
        
        validDates.forEach(([dayLabel]) => {
            const isAvailable = dateToAvailablePeriods[dayLabel] && 
                               dateToAvailablePeriods[dayLabel].has(period);
            
            if (isAvailable) {
                const slotId = `${dayLabel}${period}êµì‹œ`;
                const timeInfo = getTimeSlotInfo(slotId);
                
                rowHtml += `
                    <td class="schedule-cell" 
                        data-slot="${slotId}" 
                        data-day="${dayLabel}" 
                        data-period="${period}">
                        <div class="time-slot-header">
                            ${timeInfo ? `${timeInfo.start} - ${timeInfo.end} (${timeInfo.duration}ë¶„)` : `${period}êµì‹œ`}
                        </div>
                                                 <div class="slot-content" data-slot="${slotId}">
                             ${renderAssignedSubjects(slotId)}
                         </div>
                    </td>
                `;
            } else {
                // ì‚­ì œëœ ìŠ¬ë¡¯ì€ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
                rowHtml += `
                    <td class="schedule-cell disabled" 
                        style="background-color: #f8f9fa; border: 1px dashed #dee2e6;">
                        <div class="time-slot-header text-muted">
                            <small>ì‚¬ìš© ì•ˆí•¨</small>
                        </div>
                    </td>
                `;
            }
        });
        
        tbody.innerHTML += `<tr>${rowHtml}</tr>`;
    });
    
    // ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
    addDropEventListeners();
    
    // ì…€ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    addCellClickListeners();
    
    // ì´ ìŠ¬ë¡¯ ìˆ˜ëŠ” ë” ì´ìƒ í‘œì‹œí•˜ì§€ ì•ŠìŒ
}

// ì‹œê°„ ìŠ¬ë¡¯ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë‚ ì§œë³„ ê°œë³„ ì‹œê°„ ì§€ì›)
function getTimeSlotInfo(slotId) {
    // date_periodsì—ì„œ ì°¾ê¸° (ìš°ì„  - ë‚ ì§œë³„ ê°œë³„ ì‹œê°„)
    const dayMatch = slotId.match(/ì œ(\d+)ì¼(\d+)êµì‹œ/);
    if (dayMatch && examInfo.date_periods) {
        const dayNum = dayMatch[1];
        const periodNum = dayMatch[2];
        const dayPeriods = examInfo.date_periods[dayNum];
        
        if (dayPeriods && dayPeriods[periodNum] && !dayPeriods[periodNum]._deleted) {
            const periodData = dayPeriods[periodNum];
            const duration = parseInt(periodData.duration) || 50;
            const startTime = periodData.start_time;
            const endTime = periodData.end_time;
            
            console.log(`ìŠ¬ë¡¯ ${slotId}: ${startTime} - ${endTime} (${duration}ë¶„) [JSONì—ì„œ ì§ì ‘ ë¡œë“œ]`);
            
            return {
                start: startTime,
                end: endTime,
                duration: duration
            };
        }
    }
    
    // fallback: ì‹œí—˜íƒ€ì„ì—ì„œ ì°¾ê¸° (ê¸°ì¡´ ë°©ì‹)
    const timeData = examInfo.ì‹œí—˜íƒ€ì„ && examInfo.ì‹œí—˜íƒ€ì„[slotId];
    if (timeData && timeData.ì‹œì‘ && timeData.ì¢…ë£Œ) {
        console.log(`ìŠ¬ë¡¯ ${slotId}: ${timeData.ì‹œì‘} - ${timeData.ì¢…ë£Œ} (${timeData.ì§„í–‰ì‹œê°„}ë¶„) [ì‹œí—˜íƒ€ì„ì—ì„œ ë¡œë“œ]`);
        
        return {
            start: timeData.ì‹œì‘.slice(0, 5), // HH:MM í˜•ì‹
            end: timeData.ì¢…ë£Œ.slice(0, 5),
            duration: timeData.ì§„í–‰ì‹œê°„ || 50
        };
    }
    
    console.warn(`ìŠ¬ë¡¯ ${slotId}: ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
    return null;
}

// ë°°ì¹˜ëœ ê³¼ëª©ë“¤ì„ ë Œë”ë§
function renderAssignedSubjects(slotId) {
    const assignedSubjects = scheduleData[slotId] || [];
    let html = '';
    
    assignedSubjects.forEach(subjectName => {
        const subject = subjectInfo[subjectName];
        if (subject) {
            html += `
                <div class="assigned-subject" 
                     data-subject="${subjectName}" 
                     data-slot="${slotId}"
                     draggable="true"
                     title="ë”ë¸”í´ë¦­: ì œê±°, ìš°í´ë¦­: ë©”ë‰´">
                    <div class="assigned-subject-name">${subjectName}</div>
                    <div class="assigned-subject-info">
                        ${subject.ì‹œê°„ || 50}ë¶„ | ${subject.í•™ë…„ || ''}í•™ë…„
                        ${constraintData.subjectStats[subjectName] && constraintData.subjectStats[subjectName].student_count ? 
                            ` | ${constraintData.subjectStats[subjectName].student_count}ëª…` : ''}
                        ${subject.ë“£ê¸°í‰ê°€ ? '<span class="badge bg-warning ms-1">ë“£ê¸°</span>' : ''}
                    </div>
                    <div class="assigned-subject-actions">
                        <button class="btn-remove-subject" title="ì œê±°" onclick="removeSubjectFromSlot('${subjectName}', '${slotId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }
    });
    
    return html;
}

// ê³¼ëª©ì´ ì´ë¯¸ ë°°ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
function isSubjectAssigned(subjectName) {
    for (const slot of Object.keys(scheduleData)) {
        if (scheduleData[slot] && scheduleData[slot].includes(subjectName)) {
            return true;
        }
    }
    return false;
}

// ìŠ¬ë¡¯ì—ì„œ ê³¼ëª© ì œê±°
function removeSubjectFromSlot(subjectName, slotId) {
    console.log('ê³¼ëª© ì œê±° ì‹œì‘:', subjectName, 'from', slotId);
    
    if (scheduleData[slotId] && Array.isArray(scheduleData[slotId])) {
        scheduleData[slotId] = scheduleData[slotId].filter(subject => subject !== subjectName);
        
        // ë¹ˆ ë°°ì—´ì´ë©´ ìŠ¬ë¡¯ ì‚­ì œ
        if (scheduleData[slotId].length === 0) {
            delete scheduleData[slotId];
        }
        
        console.log('ê³¼ëª© ì œê±° ì™„ë£Œ:', subjectName);
        
        // ìë™ ì €ì¥
        saveManualSchedule();
        
        // UI ì—…ë°ì´íŠ¸
        renderScheduleGrid();
        renderSubjectList();
        updateStatistics();
        updateRecommendationBanner(); // ë°°ë„ˆ ì¶”ì²œ ì—…ë°ì´íŠ¸
        
        // í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì—…ë°ì´íŠ¸ (ì„¤ì • ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰)
        if (!document.getElementById('burdenPanelBody').classList.contains('collapsed')) {
            renderStudentBurdenAnalysis();
        }
        
        showAlert(`${subjectName}ì´(ê°€) ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
    } else {
        console.error('ì œê±°í•  ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', subjectName, slotId);
    }
}

// ê³¼ëª© ë”ë¸”í´ë¦­ ì²˜ë¦¬ (ì œê±°)
function handleSubjectDoubleClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const subjectName = e.currentTarget.dataset.subject;
    const slotId = e.currentTarget.dataset.slot;
    
    console.log('ê³¼ëª© ë”ë¸”í´ë¦­:', subjectName, 'in', slotId);
    
    if (confirm(`${subjectName}ì„(ë¥¼) ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        removeSubjectFromSlot(subjectName, slotId);
    }
}

// ê³¼ëª© ìš°í´ë¦­ ì²˜ë¦¬ (ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´)
function handleSubjectRightClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const subjectName = e.currentTarget.dataset.subject;
    const slotId = e.currentTarget.dataset.slot;
    
    console.log('ê³¼ëª© ìš°í´ë¦­:', subjectName, 'in', slotId);
    
    // ê°„ë‹¨í•œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
    showContextMenu(e, subjectName, slotId);
}

// ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
function showContextMenu(e, subjectName, slotId) {
    // ê¸°ì¡´ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì œê±°
    const existingMenu = document.querySelector('.context-menu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.cssText = `
        position: fixed;
        top: ${e.clientY}px;
        left: ${e.clientX}px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        min-width: 150px;
    `;
    
    menu.innerHTML = `
        <div class="context-menu-item" onclick="removeSubjectFromSlot('${subjectName}', '${slotId}'); this.parentElement.remove();">
            <i class="fas fa-trash text-danger me-2"></i>
            ì œê±°
        </div>
        <div class="context-menu-item" onclick="this.parentElement.remove();">
            <i class="fas fa-times text-muted me-2"></i>
            ì·¨ì†Œ
        </div>
    `;
    
    document.body.appendChild(menu);
    
    // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        });
    }, 100);
}

// ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
function addDragEventListeners() {
    // ì¢Œì¸¡ ê³¼ëª© ëª©ë¡ì˜ ê³¼ëª©ë“¤
    const subjectItems = document.querySelectorAll('.subject-item');
    console.log('ê³¼ëª© ì•„ì´í…œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€:', subjectItems.length, 'ê°œ');
    
    subjectItems.forEach((item, index) => {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragend', handleDragEnd);
        
        // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        
        console.log(`ê³¼ëª© ${index}: ${item.dataset.subject}ì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€ë¨`);
    });
    
    // ì‹œê°„í‘œì— ë°°ì¹˜ëœ ê³¼ëª©ë“¤
    const assignedSubjects = document.querySelectorAll('.assigned-subject');
    console.log('ë°°ì¹˜ëœ ê³¼ëª© ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€:', assignedSubjects.length, 'ê°œ');
    
    assignedSubjects.forEach((item, index) => {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragend', handleDragEnd);
        item.removeEventListener('dblclick', handleSubjectDoubleClick);
        item.removeEventListener('contextmenu', handleSubjectRightClick);
        
        // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dblclick', handleSubjectDoubleClick);
        item.addEventListener('contextmenu', handleSubjectRightClick);
        
        console.log(`ë°°ì¹˜ëœ ê³¼ëª© ${index}: ${item.dataset.subject}ì— ì´ë²¤íŠ¸ ì¶”ê°€ë¨`);
    });
    
    console.log('ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
}

// ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
function addDropEventListeners() {
    const scheduleCells = document.querySelectorAll('.schedule-cell');
    
    console.log('ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì¤‘...', scheduleCells.length, 'ê°œ ì…€');
    
    scheduleCells.forEach((cell, index) => {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        cell.removeEventListener('dragover', handleDragOver);
        cell.removeEventListener('drop', handleDrop);
        cell.removeEventListener('dragleave', handleDragLeave);
        
        // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragleave', handleDragLeave);
        
        console.log(`ì…€ ${index}: ${cell.dataset.slot}ì— ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€ë¨`);
    });
    
    console.log('ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
}

// ì…€ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
function addCellClickListeners() {
    const scheduleCells = document.querySelectorAll('.schedule-cell');
    
    scheduleCells.forEach(cell => {
        cell.addEventListener('click', function() {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.schedule-cell').forEach(c => c.classList.remove('selected'));
            
            // í˜„ì¬ ì…€ ì„ íƒ
            cell.classList.add('selected');
            selectedSlot = cell.dataset.slot;
            
            // ì„ íƒëœ ìŠ¬ë¡¯ ì •ë³´ í‘œì‹œ
            showSelectedSlotInfo(selectedSlot);
        });
    });
}

// ë“œë˜ê·¸ ì‹œì‘
function handleDragStart(e) {
    console.log('ë“œë˜ê·¸ ì‹œì‘!');
    isDragging = true;
    const subjectName = e.target.dataset.subject;
    
    console.log('ë“œë˜ê·¸ ëŒ€ìƒ:', subjectName);
    
    e.dataTransfer.setData('text/plain', subjectName);
    e.target.classList.add('dragging');
    
    // ìœ íš¨í•œ ë“œë¡­ ì¡´ í•˜ì´ë¼ì´íŠ¸
    highlightValidDropZones(subjectName);
    
    console.log('ë“œë˜ê·¸ ì‹œì‘ ì™„ë£Œ');
}

// ë“œë˜ê·¸ ì¢…ë£Œ
function handleDragEnd(e) {
    isDragging = false;
    e.target.classList.remove('dragging');
    
    // ëª¨ë“  ë“œë¡­ ì¡´ í•˜ì´ë¼ì´íŠ¸ ì œê±°
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        cell.classList.remove('drop-zone', 'drop-zone-invalid', 'drop-zone-warning', 'drop-zone-recommended', 'date-burden-warning');
        cell.title = ''; // íˆ´íŒë„ ì œê±°
    });
    
    // í—¤ë”ì˜ ë‚ ì§œ í…Œë‘ë¦¬ë„ ì œê±°
    document.querySelectorAll('.schedule-grid th').forEach(header => {
        header.classList.remove('date-burden-warning');
        header.title = '';
    });
    
    // ìºì‹œ ì •ë¦¬ (ë©”ëª¨ë¦¬ ì ˆì•½)
    validationCache.clear();
}

// ë“œë˜ê·¸ ì˜¤ë²„
function handleDragOver(e) {
    e.preventDefault();
    
    const cell = e.currentTarget;
    if (cell.classList.contains('drop-zone')) {
        cell.style.borderColor = '#0ea5e9';
    }
}

// ë“œë˜ê·¸ ë¦¬ë¸Œ
function handleDragLeave(e) {
    const cell = e.currentTarget;
    if (cell.classList.contains('drop-zone-invalid')) {
        cell.style.borderColor = '#ef4444';
    } else if (cell.classList.contains('drop-zone')) {
        cell.style.borderColor = '#0ea5e9';
    }
}

// ë“œë¡­ ì²˜ë¦¬
function handleDrop(e) {
    e.preventDefault();
    
    console.log('ë“œë¡­ ì´ë²¤íŠ¸ ë°œìƒ!');
    
    const subjectName = e.dataTransfer.getData('text/plain');
    const cell = e.currentTarget;
    const slotId = cell.dataset.slot;
    
    console.log('ë“œë¡­ ì •ë³´:', { subjectName, slotId, cellClasses: cell.className });
    
    if (!subjectName) {
        console.error('ë“œë¡­ëœ ê³¼ëª© ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    if (!slotId) {
        console.error('ë“œë¡­ëœ ìŠ¬ë¡¯ IDê°€ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    console.log('ê³¼ëª© ë°°ì¹˜ ì‹œì‘:', subjectName, '->', slotId);
    
    // ìºì‹œì—ì„œ ê²€ì¦ ê²°ê³¼ ì¡°íšŒ (ë“œë˜ê·¸ ì‹œ ê³„ì‚°ëœ ê²°ê³¼ ì¬ì‚¬ìš©)
    let validationResult = validationCache.get(slotId);
    
    // ìºì‹œì— ì—†ëŠ” ê²½ìš°ì—ë§Œ ìƒˆë¡œ ê³„ì‚° (ì˜ˆì™¸ì  ìƒí™©)
    if (!validationResult) {
        console.log('ìºì‹œ ë¯¸ìŠ¤! ìƒˆë¡œ ê³„ì‚°:', slotId);
        validationResult = canPlaceSubjectInSlot(subjectName, slotId);
    } else {
        console.log('ìºì‹œ íˆíŠ¸! ì¬ì‚¬ìš©:', slotId);
    }
    
    // ë°°ì¹˜ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì¤‘ë‹¨
    if (!validationResult.canPlace) {
        console.log('ë°°ì¹˜ ë¶ˆê°€:', validationResult.reasons);
        const detailedReasons = validationResult.reasons.join('\n\n');
        showDetailedAlert('ë°°ì¹˜ ë¶ˆê°€', `${subjectName}ì„(ë¥¼) ${slotId}ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, detailedReasons, 'error');
        return;
    }
    
    // ë°°ì¹˜ ê°€ëŠ¥í•˜ì§€ë§Œ ê²½ê³ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    if (validationResult.warnings && validationResult.warnings.length > 0) {
        const detailedWarnings = validationResult.warnings.join('\n\n');
        showDetailedAlert('ë°°ì¹˜ ì™„ë£Œ (ì£¼ì˜ì‚¬í•­ ìˆìŒ)', 
                         `${subjectName}ì´(ê°€) ${slotId}ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 
                         detailedWarnings, 'warning');
    } else {
        showAlert(`${subjectName}ì´(ê°€) ${slotId}ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    }
    
    // ê³¼ëª© ë°°ì¹˜
    assignSubjectToSlot(subjectName, slotId);
    
    // UI ì—…ë°ì´íŠ¸
    renderScheduleGrid();
    renderSubjectList();
    updateStatistics();
    updateRecommendationBanner(); // ë°°ë„ˆ ì¶”ì²œ ì—…ë°ì´íŠ¸
    
    // í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì—…ë°ì´íŠ¸ (ì„¤ì • ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰)
    if (!document.getElementById('burdenPanelBody').classList.contains('collapsed')) {
        renderStudentBurdenAnalysis();
    }
    
    // ë°°ì¹˜ëœ ê³¼ëª©ë“¤ì— ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë‹¤ì‹œ ì¶”ê°€
    addDragEventListeners();
    
    console.log('ê³¼ëª© ë°°ì¹˜ ì™„ë£Œ!');
}

// ================== ì œì•½ì¡°ê±´ ê²€ì¦ í•¨ìˆ˜ë“¤ ==================

// ì „ì—­ ë³€ìˆ˜ë¡œ ì œì•½ì¡°ê±´ ë°ì´í„° ì €ì¥
let constraintData = {
    subjectConflicts: {},
    individualConflicts: [],
    sameGradeConflicts: [],
    teacherConflicts: [],
    subjectStats: {},
    listeningConflicts: [],
    subjectConstraints: {},
    teacherConstraints: {},
    studentBurdenConfig: {},
    hardSubjects: {}
};

// ì œì•½ì¡°ê±´ ë°ì´í„° ë¡œë“œ
async function loadConstraintData() {
    try {
        const responses = await Promise.all([
            fetch('/uploads/subject_conflicts.json'),
            fetch('/uploads/individual_conflicts.json'),
            fetch('/uploads/same_grade_conflicts.json'),
            fetch('/uploads/teacher_conflicts.json'),
            fetch('/uploads/subject_stats.json'),
            fetch('/uploads/custom_listening_conflicts.json'),
            fetch('/uploads/subject_constraints.json'),
            fetch('/uploads/custom_teacher_constraints.json'),
            fetch('/uploads/student_burden_config.json'),
            fetch('/uploads/hard_subjects_config.json')
        ]);
        
        const [
            subjectConflicts,
            individualConflicts,
            sameGradeConflicts,
            teacherConflicts,
            subjectStats,
            listeningConflicts,
            subjectConstraints,
            teacherConstraints,
            studentBurdenConfig,
            hardSubjects
        ] = await Promise.all(responses.map(r => r.ok ? r.json() : {}));
        
        constraintData = {
            subjectConflicts: subjectConflicts || {},
            individualConflicts: individualConflicts || [],
            sameGradeConflicts: sameGradeConflicts || [],
            teacherConflicts: teacherConflicts || [],
            subjectStats: subjectStats || {},
            listeningConflicts: listeningConflicts || [],
            subjectConstraints: subjectConstraints || {},
            teacherConstraints: teacherConstraints || {},
            studentBurdenConfig: studentBurdenConfig || {},
            hardSubjects: hardSubjects || {}
        };
        
        // í•™ìƒ ë¶€ë‹´ ì„¤ì •ê°’ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ì„¤ì •ê°’ë§Œ ì‚¬ìš©, ê¸°ë³¸ê°’ ì—†ìŒ)
        if (studentBurdenConfig && Object.keys(studentBurdenConfig).length > 0) {
            window.studentBurdenConfig = {};
            constraintData.studentBurdenConfig = {}; // constraintDataì—ë„ ë™ì¼í•˜ê²Œ ì €ì¥
            
            // max_exams_per_dayê°€ ì‹¤ì œë¡œ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ì‚¬ìš©
            if (studentBurdenConfig.max_exams_per_day !== null && studentBurdenConfig.max_exams_per_day !== undefined) {
                window.studentBurdenConfig.max_exams_per_day = studentBurdenConfig.max_exams_per_day;
                constraintData.studentBurdenConfig.max_exams_per_day = studentBurdenConfig.max_exams_per_day;
            }
            
            // max_hard_exams_per_dayê°€ ì‹¤ì œë¡œ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ì‚¬ìš©
            if (studentBurdenConfig.max_hard_exams_per_day !== null && studentBurdenConfig.max_hard_exams_per_day !== undefined) {
                window.studentBurdenConfig.max_hard_exams_per_day = studentBurdenConfig.max_hard_exams_per_day;
                constraintData.studentBurdenConfig.max_hard_exams_per_day = studentBurdenConfig.max_hard_exams_per_day;
            }
        } else {
            // íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹ˆ ê²½ìš°
            window.studentBurdenConfig = {};
            constraintData.studentBurdenConfig = {};
        }
        
        console.log('ì œì•½ì¡°ê±´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', constraintData);
    } catch (error) {
        console.error('ì œì•½ì¡°ê±´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ê³¼ëª©ì´ íŠ¹ì • ìŠ¬ë¡¯ì— ë°°ì¹˜ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
function canPlaceSubjectInSlot(subjectName, slotId, currentSchedule = scheduleData) {
    const result = {
        canPlace: true,
        reasons: [],
        warnings: []
    };
    
    // 1. ì‹œê°„ ì œí•œ í™•ì¸
    const timeCheck = checkTimeConstraint(subjectName, slotId);
    if (!timeCheck.valid) {
        result.canPlace = false;
        result.reasons.push(timeCheck.reason);
    }
    
    // 2. ê³¼ëª©ë³„ ì œì•½ì¡°ê±´ í™•ì¸
    if (!checkSubjectConstraints(subjectName, slotId)) {
        result.canPlace = false;
        result.reasons.push('ê³¼ëª©ë³„ ì œì•½ì¡°ê±´ì— ì˜í•´ í•´ë‹¹ ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // 3. êµì‚¬ ì œì•½ì¡°ê±´ í™•ì¸
    if (!checkTeacherConstraints(subjectName, slotId)) {
        result.canPlace = false;
        result.reasons.push('ë‹´ë‹¹ êµì‚¬ì˜ ì œì•½ì¡°ê±´ì— ì˜í•´ í•´ë‹¹ ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    // í˜„ì¬ ìŠ¬ë¡¯ì— ë°°ì¹˜ëœ ê³¼ëª©ë“¤ ê°€ì ¸ì˜¤ê¸°
    const existingSubjects = currentSchedule[slotId] || [];
    
    // 4. ê³¼ëª© ì¶©ëŒ í™•ì¸
    const subjectConflictResult = checkSubjectConflicts(subjectName, existingSubjects);
    if (!subjectConflictResult.canPlace) {
        result.canPlace = false;
        result.reasons.push(...subjectConflictResult.reasons);
    }
    
    // 5. êµì‚¬ ì¶©ëŒ í™•ì¸
    const teacherConflictResult = checkTeacherConflicts(subjectName, existingSubjects);
    if (!teacherConflictResult.canPlace) {
        result.canPlace = false;
        result.reasons.push(...teacherConflictResult.reasons);
    }
    
    // 6. í•™ìƒ ì¶©ëŒ í™•ì¸
    const studentConflictResult = checkStudentConflicts(subjectName, existingSubjects);
    if (!studentConflictResult.canPlace) {
        result.canPlace = false;
        result.reasons.push(...studentConflictResult.reasons);
    }
    
    // 7. ë“£ê¸°í‰ê°€ ì¶©ëŒ í™•ì¸
    const listeningConflictResult = checkListeningConflicts(subjectName, existingSubjects);
    if (!listeningConflictResult.canPlace) {
        result.canPlace = false;
        result.reasons.push(...listeningConflictResult.reasons);
    }
    
    // 8. ë‚ ì§œë³„ í•™ìƒ ë¶€ë‹´ í™•ì¸ (í•˜ë“œ ì œì•½ì¡°ê±´ - ì˜¤ë¥˜ë¡œ ì²˜ë¦¬)
    const burdenResult = checkStudentBurden(subjectName, slotId, currentSchedule);
    if (burdenResult.errors && burdenResult.errors.length > 0) {
        result.canPlace = false;
        result.reasons.push(...burdenResult.errors);
    }
    if (burdenResult.warnings && burdenResult.warnings.length > 0) {
        result.warnings.push(...burdenResult.warnings);
    }
    
    // 9. í•„ìˆ˜ ë™ë°˜ ê³¼ëª© í™•ì¸ (ê²½ê³ ë¡œë§Œ í‘œì‹œ - ê°œë³„ ë°°ì¹˜ ì‹œì—ëŠ” í—ˆìš©)
    const companionResult = checkRequiredCompanionSubjects(subjectName, existingSubjects, currentSchedule);
    if (companionResult.warnings && companionResult.warnings.length > 0) {
        result.warnings.push(...companionResult.warnings);
    }
    
    return result;
}

// 1. ì‹œê°„ ì œí•œ í™•ì¸
function checkTimeConstraint(subjectName, slotId) {
    const subject = subjectInfo[subjectName];
    if (!subject) return { valid: false, reason: `ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${subjectName}` };
    
    const subjectDuration = subject.ì‹œê°„ || 50;
    const timeInfo = getTimeSlotInfo(slotId);
    const slotDuration = timeInfo ? timeInfo.duration : 50;
    
    if (subjectDuration <= slotDuration) {
        return { valid: true };
    } else {
        return { 
            valid: false, 
            reason: `ì‹œí—˜ ì‹œê°„ì´ ìŠ¬ë¡¯ í—ˆìš© ì‹œê°„ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.\n${subjectName} ì‹œí—˜ ì‹œê°„: ${subjectDuration}ë¶„\n${slotId} í—ˆìš© ì‹œê°„: ${slotDuration}ë¶„`
        };
    }
}

// 2. ê³¼ëª©ë³„ ì œì•½ì¡°ê±´ í™•ì¸
function checkSubjectConstraints(subjectName, slotId) {
    const constraints = constraintData.subjectConstraints[subjectName];
    if (!constraints) return true;
    
    // í‘œì¤€í™”ëœ ìŠ¬ë¡¯ IDë¡œ ë³€í™˜í•˜ì—¬ í™•ì¸
    const standardizedSlotId = standardizeSlotId(slotId);
    return !constraints[standardizedSlotId];
}

// 3. êµì‚¬ ì œì•½ì¡°ê±´ í™•ì¸
function checkTeacherConstraints(subjectName, slotId) {
    const subject = subjectInfo[subjectName];
    if (!subject || !subject.ë‹´ë‹¹êµì‚¬) return true;
    
    const standardizedSlotId = standardizeSlotId(slotId);
    
    for (const teacher of subject.ë‹´ë‹¹êµì‚¬) {
        const teacherConstraints = constraintData.teacherConstraints[teacher];
        if (teacherConstraints && teacherConstraints[standardizedSlotId]) {
            return false;
        }
    }
    
    return true;
}

// 4. ê³¼ëª© ì¶©ëŒ í™•ì¸ (í”¼í•´ì•¼ í•˜ëŠ” ê³¼ëª©ê³¼ ê°™ì´ ë°°ì¹˜í•´ì•¼ í•˜ëŠ” ê³¼ëª© ëª¨ë‘ í™•ì¸)
function checkSubjectConflicts(subjectName, existingSubjects) {
    const result = { canPlace: true, reasons: [] };
    
    for (const existingSubject of existingSubjects) {
        // ê°™ì€ ê³¼ëª©ì€ ì œì™¸ (ìê¸° ìì‹ ê³¼ ë¹„êµ ë°©ì§€)
        if (existingSubject === subjectName) continue;
        
        // ì •ë ¬ëœ í‚¤ë¡œ ì¶©ëŒ í™•ì¸
        const conflictKey1 = [subjectName, existingSubject].sort().join('_');
        const conflictKey2 = [existingSubject, subjectName].sort().join('_');
        
        const conflict = constraintData.subjectConflicts[conflictKey1] || constraintData.subjectConflicts[conflictKey2];
        
        if (conflict) {
            if (conflict.type === 'avoid_same_time') {
                result.canPlace = false;
                result.reasons.push(`${subjectName}ê³¼ ${existingSubject}ëŠ” ê°™ì€ ì‹œê°„ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${conflict.reason})`);
            }
            // same_time íƒ€ì…ì€ ì—¬ê¸°ì„œëŠ” ì œì•½ì´ ì•„ë‹˜ (ì˜¤íˆë ¤ ê¶Œì¥)
        }
    }
    
    return result;
}

// 5. êµì‚¬ ì¶©ëŒ í™•ì¸
function checkTeacherConflicts(subjectName, existingSubjects) {
    const result = { canPlace: true, reasons: [] };
    const subject = subjectInfo[subjectName];
    
    if (!subject || !subject.ë‹´ë‹¹êµì‚¬) return result;
    
    for (const existingSubject of existingSubjects) {
        // ê°™ì€ ê³¼ëª©ì€ ì œì™¸ (ìê¸° ìì‹ ê³¼ ë¹„êµ ë°©ì§€)
        if (existingSubject === subjectName) continue;
        
        const existingSubjectInfo = subjectInfo[existingSubject];
        if (!existingSubjectInfo || !existingSubjectInfo.ë‹´ë‹¹êµì‚¬) continue;
        
        // ê³µí†µ êµì‚¬ í™•ì¸
        const commonTeachers = subject.ë‹´ë‹¹êµì‚¬.filter(teacher => 
            existingSubjectInfo.ë‹´ë‹¹êµì‚¬.includes(teacher)
        );
        
        if (commonTeachers.length > 0) {
            result.canPlace = false;
            result.reasons.push(`${subjectName}ê³¼ ${existingSubject}ëŠ” ê³µí†µ ë‹´ë‹¹êµì‚¬ë¡œ ì¸í•´ ê°™ì€ ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê³µí†µ ë‹´ë‹¹êµì‚¬: ${commonTeachers.join(', ')}`);
        }
    }
    
    return result;
}

// 6. í•™ìƒ ì¶©ëŒ í™•ì¸
function checkStudentConflicts(subjectName, existingSubjects) {
    const result = { canPlace: true, reasons: [] };
    
    for (const existingSubject of existingSubjects) {
        // ê°™ì€ ê³¼ëª©ì€ ì œì™¸ (ìê¸° ìì‹ ê³¼ ë¹„êµ ë°©ì§€)
        if (existingSubject === subjectName) continue;
        
        let hasConflict = false;
        let conflictReason = '';
        let commonStudents = [];
        
        // ë°©ë²• 1: individual_conflicts ë˜ëŠ” same_grade_conflicts ë°ì´í„° í™•ì¸
        if (constraintData.individualConflicts && Array.isArray(constraintData.individualConflicts) && constraintData.individualConflicts.length > 0) {
            // individual_conflicts.json ë°ì´í„° ì‚¬ìš©
            const conflict = constraintData.individualConflicts.find(c => 
                (c.subject1 === subjectName && c.subject2 === existingSubject) ||
                (c.subject1 === existingSubject && c.subject2 === subjectName)
            );
            if (conflict) {
                hasConflict = true;
                // ì‹¤ì œ ê³µí†µ í•™ìƒ ì •ë³´ë„ ì°¾ì•„ì„œ í‘œì‹œ
                if (constraintData.subjectStats) {
                    const subjectStudents = constraintData.subjectStats[subjectName]?.students || [];
                    const existingStudents = constraintData.subjectStats[existingSubject]?.students || [];
                    commonStudents = subjectStudents.filter(student => 
                        existingStudents.includes(student)
                    );
                    if (commonStudents.length > 0) {
                        const studentList = commonStudents.slice(0, 10).join(', ') + (commonStudents.length > 10 ? ` ì™¸ ${commonStudents.length - 10}ëª…` : '');
                        conflictReason = `ê°œë³„ í•™ìƒ ì¶©ëŒ (${commonStudents.length}ëª…): ${studentList}`;
                    } else {
                        conflictReason = `ê°œë³„ í•™ìƒ ì¶©ëŒ (individual_conflicts)`;
                    }
                } else {
                    conflictReason = `ê°œë³„ í•™ìƒ ì¶©ëŒ (individual_conflicts)`;
                }
            }
        } else if (constraintData.sameGradeConflicts && Array.isArray(constraintData.sameGradeConflicts)) {
            // same_grade_conflicts.json ë°ì´í„° ì‚¬ìš©
            const conflict = constraintData.sameGradeConflicts.find(c => 
                (c.subject1 === subjectName && c.subject2 === existingSubject) ||
                (c.subject1 === existingSubject && c.subject2 === subjectName)
            );
            if (conflict) {
                hasConflict = true;
                conflictReason = `ê°™ì€ í•™ë…„ ì¶©ëŒ (${conflict.common_grades?.join(', ')}í•™ë…„)`;
            }
        }
        
        // ë°©ë²• 2: í•™ìƒ ëª©ë¡ ì§ì ‘ ë¹„êµ (ê¸°ì¡´ ë°©ì‹, ë°±ì—…ìš©)
        if (!hasConflict && constraintData.subjectStats) {
            const subjectStudents = constraintData.subjectStats[subjectName]?.students || [];
            const existingStudents = constraintData.subjectStats[existingSubject]?.students || [];
            
            if (subjectStudents.length > 0 && existingStudents.length > 0) {
                // ê³µí†µ í•™ìƒ í™•ì¸
                commonStudents = subjectStudents.filter(student => 
                    existingStudents.includes(student)
                );
                
                if (commonStudents.length > 0) {
                    hasConflict = true;
                    const studentList = commonStudents.length > 0 ? 
                        (commonStudents.slice(0, 10).join(', ') + (commonStudents.length > 10 ? ` ì™¸ ${commonStudents.length - 10}ëª…` : '')) : 
                        '';
                    conflictReason = `ê³µí†µ ìˆ˜ê°• í•™ìƒ (${commonStudents.length}ëª…): ${studentList}`;
                }
            }
        }
        
        if (hasConflict) {
            result.canPlace = false;
            result.reasons.push(`${subjectName}ê³¼ ${existingSubject}ëŠ” ê°™ì€ ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n${conflictReason}`);
        }
    }
    
    return result;
}

// 7. ë“£ê¸°í‰ê°€ ì¶©ëŒ í™•ì¸
function checkListeningConflicts(subjectName, existingSubjects) {
    const result = { canPlace: true, reasons: [] };
    
    // í˜„ì¬ ê³¼ëª©ì´ ë“£ê¸°í‰ê°€ê°€ ìˆëŠ”ì§€ í™•ì¸
    const subjectInfo_current = subjectInfo[subjectName];
    const hasListening = subjectInfo_current?.ë“£ê¸°í‰ê°€ || false;
    
    if (!hasListening) return result;
    
    // ê¸°ì¡´ ê³¼ëª©ë“¤ ì¤‘ ë“£ê¸°í‰ê°€ê°€ ìˆëŠ” ê³¼ëª©ì´ ìˆëŠ”ì§€ í™•ì¸
    for (const existingSubject of existingSubjects) {
        // ê°™ì€ ê³¼ëª©ì€ ì œì™¸ (ìê¸° ìì‹ ê³¼ ë¹„êµ ë°©ì§€)
        if (existingSubject === subjectName) continue;
        
        const existingSubjectInfo = subjectInfo[existingSubject];
        if (existingSubjectInfo?.ë“£ê¸°í‰ê°€) {
            result.canPlace = false;
            result.reasons.push(`${subjectName}ê³¼ ${existingSubject}ëŠ” ëª¨ë‘ ë“£ê¸°í‰ê°€ê°€ ìˆì–´ ê°™ì€ ìŠ¬ë¡¯ì— ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
        }
    }
    
    return result;
}

// 8. ë‚ ì§œë³„ í•™ìƒ ë¶€ë‹´ í™•ì¸
function checkStudentBurden(subjectName, slotId, currentSchedule) {
    const result = { errors: [], warnings: [] };
    const day = getDateFromSlotId(slotId);
    const config = constraintData.studentBurdenConfig;
    
    // ì„¤ì •ì´ ì—†ìœ¼ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
    if (!config || (!config.max_exams_per_day && !config.max_hard_exams_per_day)) {
        console.log(`DEBUG: í•™ìƒ ë¶€ë‹´ ì„¤ì • ì—†ìŒ. config:`, config);
        return result;
    }
    
    console.log(`DEBUG: ${day}ì— ${subjectName} ë°°ì¹˜ ì‹œ í•™ìƒ ë¶€ë‹´ ì²´í¬`);
    
    // ê³µí†µ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ìƒ ìŠ¤ì¼€ì¤„ì—ì„œ í•™ìƒ ë¶€ë‹´ ê³„ì‚°
    const dayBurden = calculateDayStudentBurden(day, currentSchedule, subjectName, slotId);
    
    console.log(`DEBUG: í•™ìƒë³„ ì‹œí—˜ ìˆ˜:`, dayBurden.studentExamCounts);
    console.log(`DEBUG: í•™ìƒë³„ ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜:`, dayBurden.studentHardExamCounts);
    
    // ì¼ë°˜ ì‹œí—˜ ìˆ˜ ì œí•œ í™•ì¸
    if (config.max_exams_per_day) {
        const overloadedStudents = Object.entries(dayBurden.studentExamCounts)
            .filter(([student, count]) => count > config.max_exams_per_day);
        
        if (overloadedStudents.length > 0) {
            const overloadedStudentList = overloadedStudents
                .map(([student, count]) => `${student}(${count}ê°œ)`)
                .slice(0, 10);
            const displayList = overloadedStudentList.join(', ') + (overloadedStudents.length > 10 ? ` ì™¸ ${overloadedStudents.length - 10}ëª…` : '');
            result.errors.push(`${overloadedStudents.length}ëª…ì˜ í•™ìƒì´ í•˜ë£¨ ìµœëŒ€ ì‹œí—˜ ìˆ˜(${config.max_exams_per_day}ê°œ)ë¥¼ ì´ˆê³¼í•˜ë¯€ë¡œ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ˆê³¼ í•™ìƒ: ${displayList}`);
        }
    }
    
    // ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜ ì œí•œ í™•ì¸
    if (config.max_hard_exams_per_day) {
        const hardOverloadedStudents = Object.entries(dayBurden.studentHardExamCounts)
            .filter(([student, count]) => count > config.max_hard_exams_per_day);
        
        if (hardOverloadedStudents.length > 0) {
            const hardOverloadedStudentList = hardOverloadedStudents
                .map(([student, count]) => `${student}(${count}ê°œ)`)
                .slice(0, 10);
            const displayList = hardOverloadedStudentList.join(', ') + (hardOverloadedStudents.length > 10 ? ` ì™¸ ${hardOverloadedStudents.length - 10}ëª…` : '');
            result.errors.push(`${hardOverloadedStudents.length}ëª…ì˜ í•™ìƒì´ í•˜ë£¨ ìµœëŒ€ ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜(${config.max_hard_exams_per_day}ê°œ)ë¥¼ ì´ˆê³¼í•˜ë¯€ë¡œ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ˆê³¼ í•™ìƒ: ${displayList}`);
        }
    }
    
    return result;
}

// 9. í•„ìˆ˜ ë™ë°˜ ê³¼ëª© í™•ì¸ (ê°™ì´ ë°°ì¹˜í•´ì•¼ í•˜ëŠ” ê³¼ëª©ë“¤)
function checkRequiredCompanionSubjects(subjectName, existingSubjects, currentSchedule) {
    const result = { errors: [], warnings: [] };
    
    // í˜„ì¬ ê³¼ëª©ê³¼ same_time ê´€ê³„ì¸ ê³¼ëª©ë“¤ í™•ì¸
    Object.values(constraintData.subjectConflicts).forEach(conflict => {
        if (conflict.type === 'same_time') {
            let companionSubject = null;
            
            if (conflict.subject1 === subjectName) {
                companionSubject = conflict.subject2;
            } else if (conflict.subject2 === subjectName) {
                companionSubject = conflict.subject1;
            }
            
            if (companionSubject) {
                // ë™ë°˜ ê³¼ëª©ì´ ê°™ì€ ìŠ¬ë¡¯ì— ìˆëŠ”ì§€ í™•ì¸
                if (existingSubjects.includes(companionSubject)) {
                    // ì´ë¯¸ ê°™ì€ ìŠ¬ë¡¯ì— ìˆìŒ - ì™„ë²½í•œ ìƒíƒœ
                    return;
                }
                
                // ë™ë°˜ ê³¼ëª©ì´ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ë°°ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                let companionSlot = null;
                for (const [slotId, subjects] of Object.entries(currentSchedule)) {
                    if (subjects && subjects.includes(companionSubject)) {
                        companionSlot = slotId;
                        break;
                    }
                }
                
                if (companionSlot) {
                    // ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì´ë¯¸ ë°°ì¹˜ë˜ì–´ ìˆìŒ - ê°•í•œ ê²½ê³ 
                    result.warnings.push(`${companionSubject}ì´(ê°€) ì´ë¯¸ ${companionSlot}ì— ë°°ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ${subjectName}ê³¼ í•¨ê»˜ ê°™ì€ ìŠ¬ë¡¯ì— ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.`);
                } else {
                    // ì•„ì§ ë°°ì¹˜ë˜ì§€ ì•ŠìŒ - ê¶Œì¥ì‚¬í•­
                    result.warnings.push(`${subjectName}ê³¼ ${companionSubject}ì€(ëŠ”) í•¨ê»˜ ë°°ì¹˜í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.`);
                }
            }
        }
    });
    
    return result;
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function standardizeSlotId(slotId) {
    // "ì œ1ì¼1êµì‹œ" -> "ì œ1ì¼_1êµì‹œ" í˜•íƒœë¡œ ë³€í™˜
    return slotId.replace(/(\d)êµì‹œ/, '_$1êµì‹œ');
}

function getDateFromSlotId(slotId) {
    // "ì œ1ì¼1êµì‹œ" -> "ì œ1ì¼" ì¶”ì¶œ
    const match = slotId.match(/^(ì œ\d+ì¼)/);
    return match ? match[1] : null;
}

// ìºì‹±ì„ í™œìš©í•œ ìœ íš¨í•œ ë“œë¡­ ì¡´ í•˜ì´ë¼ì´íŠ¸ í•¨ìˆ˜
function highlightValidDropZones(subjectName) {
    // ìºì‹œ ì´ˆê¸°í™”
    validationCache.clear();
    
    // ë™ë°˜ ê³¼ëª©ì´ ë°°ì¹˜ëœ ìŠ¬ë¡¯ ì°¾ê¸°
    const companionSlots = findCompanionSubjectSlots(subjectName);
    const dateIssues = new Set(); // ë‚ ì§œë³„ ë¶€ë‹´ ë¬¸ì œê°€ ìˆëŠ” ë‚ ì§œë“¤
    
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        // disabled ì…€ì€ ì œì™¸
        if (cell.classList.contains('disabled')) {
            return;
        }
        
        const slotId = cell.dataset.slot;
        if (!slotId) return; // slotIdê°€ ì—†ëŠ” ì…€ì€ ì œì™¸
        
        // ê²€ì¦ ìˆ˜í–‰ ë° ìºì‹œì— ì €ì¥
        const validationResult = canPlaceSubjectInSlot(subjectName, slotId);
        validationCache.set(slotId, validationResult); // ìºì‹œì— ì €ì¥
        
        if (validationResult.canPlace) {
            cell.classList.add('drop-zone');
            
            // ë™ë°˜ ê³¼ëª©ì´ ìˆëŠ” ìŠ¬ë¡¯ì¸ì§€ í™•ì¸
            if (companionSlots.includes(slotId)) {
                cell.classList.add('drop-zone-recommended');
                cell.title = `ê¶Œì¥ ìŠ¬ë¡¯: ë™ë°˜ ê³¼ëª©ì´ ì´ë¯¸ ë°°ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n${validationResult.warnings.join('\n')}`;
            } else if (validationResult.warnings.length > 0) {
                cell.classList.add('drop-zone-warning');
                cell.title = validationResult.warnings.join('\n');
            }
        } else {
            // ìŠ¬ë¡¯ë³„ ë¬¸ì œì™€ ë‚ ì§œë³„ ë¬¸ì œ êµ¬ë¶„
            const hasSlotDirectIssue = validationResult.reasons.some(reason => 
                reason.includes('êµì‚¬ ì¶©ëŒ') || 
                reason.includes('í•™ìƒ ì¶©ëŒ') || 
                reason.includes('ì¤‘ë³µ ë°°ì¹˜') ||
                reason.includes('ë“£ê¸°í‰ê°€') ||
                reason.includes('ë™ë°˜ ê³¼ëª©')
            );
            
            const hasDateBurdenIssue = validationResult.reasons.some(reason => 
                reason.includes('í•˜ë£¨ ìµœëŒ€ ì‹œí—˜ ìˆ˜') || 
                reason.includes('ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜')
            );
            
            if (hasSlotDirectIssue) {
                // ìŠ¬ë¡¯ ì§ì ‘ ë¬¸ì œ - ê¸°ì¡´ ë°©ì‹ (ë¹¨ê°„ ë°°ê²½)
                cell.classList.add('drop-zone-invalid');
                cell.title = validationResult.reasons.join('\n');
            } else if (hasDateBurdenIssue) {
                // ë‚ ì§œ ë¶€ë‹´ ë¬¸ì œë§Œ ìˆëŠ” ê²½ìš° - ë‚ ì§œ ì „ì²´ í…Œë‘ë¦¬ìš©ìœ¼ë¡œ ë¶„ë¥˜
                const dayLabel = getDateFromSlotId(slotId);
                dateIssues.add(dayLabel);
            } else {
                // ê¸°íƒ€ ë¬¸ì œ
                cell.classList.add('drop-zone-invalid');
                cell.title = validationResult.reasons.join('\n');
            }
        }
    });
    
    // ë‚ ì§œë³„ ë¶€ë‹´ ë¬¸ì œê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ ë‚ ì§œ ì „ì²´ì— í…Œë‘ë¦¬ ì ìš©
    dateIssues.forEach(dayLabel => {
        // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì…€ê³¼ í—¤ë”ì— í…Œë‘ë¦¬ í´ë˜ìŠ¤ ì¶”ê°€
        document.querySelectorAll('.schedule-cell').forEach(cell => {
            const slotId = cell.dataset.slot;
            if (slotId && getDateFromSlotId(slotId) === dayLabel) {
                cell.classList.add('date-burden-warning');
                if (!cell.title) {
                    cell.title = `âš ï¸ ${dayLabel}: í•™ìƒ ë¶€ë‹´ ì´ˆê³¼ë¡œ ë°°ì¹˜ ë¶ˆê°€`;
                }
            }
        });
        
        // í—¤ë”ì—ë„ í…Œë‘ë¦¬ ì ìš© (ë‚ ì§œ í—¤ë” ì°¾ê¸°)
        document.querySelectorAll('.schedule-grid th').forEach(header => {
            if (header.textContent.includes(dayLabel)) {
                header.classList.add('date-burden-warning');
                header.title = `âš ï¸ ${dayLabel}: í•™ìƒ ë¶€ë‹´ ì´ˆê³¼ë¡œ ë°°ì¹˜ ë¶ˆê°€`;
            }
        });
    });
}

// ë™ë°˜ ê³¼ëª©ì´ ë°°ì¹˜ëœ ìŠ¬ë¡¯ë“¤ ì°¾ê¸°
function findCompanionSubjectSlots(subjectName) {
    const companionSlots = [];
    
    Object.values(constraintData.subjectConflicts).forEach(conflict => {
        if (conflict.type === 'same_time') {
            let companionSubject = null;
            
            if (conflict.subject1 === subjectName) {
                companionSubject = conflict.subject2;
            } else if (conflict.subject2 === subjectName) {
                companionSubject = conflict.subject1;
            }
            
            if (companionSubject) {
                // ë™ë°˜ ê³¼ëª©ì´ ë°°ì¹˜ëœ ìŠ¬ë¡¯ ì°¾ê¸°
                for (const [slotId, subjects] of Object.entries(scheduleData)) {
                    if (subjects && subjects.includes(companionSubject)) {
                        companionSlots.push(slotId);
                    }
                }
            }
        }
    });
    
    return companionSlots;
}

// ================== ì™„ì„±ëœ ì‹œê°„í‘œ ìœ íš¨ì„± ê²€ì¦ ==================

// ì „ì²´ ì‹œê°„í‘œì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ëŠ” í•¨ìˆ˜
function validateCompleteSchedule(schedule = scheduleData) {
    const validationResult = {
        isValid: true,
        errors: [],
        warnings: [],
        statistics: {
            totalSubjects: Object.keys(subjectInfo).length,
            assignedSubjects: Object.values(schedule).flat().length,
            unassignedSubjects: [],
            conflictCount: 0,
            overloadedStudents: 0
        }
    };
    
    // 1. ë¯¸ë°°ì • ê³¼ëª© í™•ì¸
    const assignedSubjects = new Set(Object.values(schedule).flat());
    const allSubjects = Object.keys(subjectInfo);
    validationResult.statistics.unassignedSubjects = allSubjects.filter(subject => !assignedSubjects.has(subject));
    
    if (validationResult.statistics.unassignedSubjects.length > 0) {
        validationResult.errors.push(`ë¯¸ë°°ì • ê³¼ëª©ì´ ${validationResult.statistics.unassignedSubjects.length}ê°œ ìˆìŠµë‹ˆë‹¤: ${validationResult.statistics.unassignedSubjects.join(', ')}`);
        validationResult.isValid = false;
    }
    
    // 2. ê° ìŠ¬ë¡¯ë³„ ì œì•½ì¡°ê±´ ê²€ì¦
    let totalConflicts = 0;
    for (const [slotId, subjects] of Object.entries(schedule)) {
        if (!subjects || subjects.length === 0) continue;
        
        // ê° ê³¼ëª©ì— ëŒ€í•´ í•´ë‹¹ ìŠ¬ë¡¯ì— ë°°ì¹˜ ê°€ëŠ¥í•œì§€ í™•ì¸
        for (const subject of subjects) {
            const validation = canPlaceSubjectInSlot(subject, slotId, schedule);
            
            if (!validation.canPlace) {
                validationResult.errors.push(`${slotId}ì˜ ${subject}: ${validation.reasons.join(', ')}`);
                validationResult.isValid = false;
                totalConflicts++;
            }
            
            if (validation.warnings.length > 0) {
                validationResult.warnings.push(`${slotId}ì˜ ${subject}: ${validation.warnings.join(', ')}`);
            }
        }
    }
    
    // 3. ì „ì²´ ì‹œê°„í‘œì—ì„œ same_time ì œì•½ì¡°ê±´ í™•ì¸
    const sameTimeViolations = checkGlobalSameTimeConstraints(schedule);
    if (sameTimeViolations.length > 0) {
        validationResult.errors.push(...sameTimeViolations);
        validationResult.isValid = false;
        totalConflicts += sameTimeViolations.length;
    }
    
    validationResult.statistics.conflictCount = totalConflicts;
    
    // 3. ì „ì²´ í•™ìƒ ë¶€ë‹´ ë¶„ì„
    const studentBurdenAnalysis = analyzeStudentBurden(schedule);
    validationResult.statistics.overloadedStudents = studentBurdenAnalysis.overloadedStudents;
    
    if (studentBurdenAnalysis.errors.length > 0) {
        validationResult.errors.push(...studentBurdenAnalysis.errors);
        validationResult.isValid = false;
    }
    
    if (studentBurdenAnalysis.warnings.length > 0) {
        validationResult.warnings.push(...studentBurdenAnalysis.warnings);
    }
    
    return validationResult;
}

// ì „ì²´ ì‹œê°„í‘œì—ì„œ same_time ì œì•½ì¡°ê±´ í™•ì¸
function checkGlobalSameTimeConstraints(schedule) {
    const violations = [];
    
    // ëª¨ë“  same_time ì œì•½ì¡°ê±´ í™•ì¸
    Object.values(constraintData.subjectConflicts).forEach(conflict => {
        if (conflict.type === 'same_time') {
            const subject1 = conflict.subject1;
            const subject2 = conflict.subject2;
            
            // ë‘ ê³¼ëª©ì´ ëª¨ë‘ ë°°ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            let subject1Slot = null;
            let subject2Slot = null;
            
            for (const [slotId, subjects] of Object.entries(schedule)) {
                if (subjects.includes(subject1)) subject1Slot = slotId;
                if (subjects.includes(subject2)) subject2Slot = slotId;
            }
            
            // ë‘˜ ë‹¤ ë°°ì¹˜ë˜ì–´ ìˆì§€ë§Œ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ìˆëŠ” ê²½ìš°
            if (subject1Slot && subject2Slot && subject1Slot !== subject2Slot) {
                violations.push(`${subject1}ê³¼ ${subject2}ëŠ” ê°™ì€ ì‹œê°„ì— ë°°ì¹˜ë˜ì–´ì•¼ í•˜ì§€ë§Œ ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ìˆìŠµë‹ˆë‹¤ (${subject1}: ${subject1Slot}, ${subject2}: ${subject2Slot})`);
            }
            
            // í•˜ë‚˜ë§Œ ë°°ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš° (ê²½ê³  ìˆ˜ì¤€)
            else if ((subject1Slot && !subject2Slot) || (!subject1Slot && subject2Slot)) {
                const placedSubject = subject1Slot ? subject1 : subject2;
                const unplacedSubject = subject1Slot ? subject2 : subject1;
                violations.push(`${placedSubject}ì´ ë°°ì¹˜ë˜ì—ˆì§€ë§Œ í•¨ê»˜ ë°°ì¹˜ë˜ì–´ì•¼ í•˜ëŠ” ${unplacedSubject}ì´ ë°°ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤`);
            }
        }
    });
    
    return violations;
}

// ì „ì²´ í•™ìƒ ë¶€ë‹´ ë¶„ì„
function analyzeStudentBurden(schedule) {
    const result = { errors: [], warnings: [], overloadedStudents: 0 };
    const config = constraintData.studentBurdenConfig;
    
    // ì„¤ì •ì´ ì—†ìœ¼ë©´ ì²´í¬í•˜ì§€ ì•ŠìŒ
    if (!config || (!config.max_exams_per_day && !config.max_hard_exams_per_day)) {
        return result;
    }
    
    // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    const dateGroups = {};
    for (const [slotId, subjects] of Object.entries(schedule)) {
        const date = getDateFromSlotId(slotId);
        if (!date) continue;
        
        if (!dateGroups[date]) dateGroups[date] = [];
        dateGroups[date].push(...subjects);
    }
    
    // ê° ë‚ ì§œë³„ë¡œ í•™ìƒ ë¶€ë‹´ í™•ì¸
    let totalOverloadedStudents = new Set();
    
    for (const [date, subjects] of Object.entries(dateGroups)) {
        // ê° í•™ìƒë³„ ì‹¤ì œ ì‘ì‹œ ê³¼ëª© ìˆ˜ ê³„ì‚° (ì¤‘ë³µ ì œê±°)
        const studentSubjects = {}; // í•™ìƒë³„ ì‘ì‹œ ê³¼ëª© ëª©ë¡
        const studentExamCounts = {};
        const studentHardExamCounts = {};
        
        // ë¨¼ì € ê° í•™ìƒì´ ì‹¤ì œë¡œ ì‘ì‹œí•˜ëŠ” ê³¼ëª©ë“¤ì„ ìˆ˜ì§‘
        for (const subject of subjects) {
            const students = constraintData.subjectStats[subject]?.students || [];
            
            for (const student of students) {
                if (!studentSubjects[student]) {
                    studentSubjects[student] = new Set();
                }
                studentSubjects[student].add(subject);
            }
        }
        
        // ê° í•™ìƒë³„ë¡œ ì‹¤ì œ ì‹œí—˜ ìˆ˜ ê³„ì‚°
        for (const [student, subjectSet] of Object.entries(studentSubjects)) {
            studentExamCounts[student] = subjectSet.size;
            
            // ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜ ê³„ì‚°
            studentHardExamCounts[student] = 0;
            for (const subject of subjectSet) {
                if (constraintData.hardSubjects && constraintData.hardSubjects[subject]) {
                    studentHardExamCounts[student]++;
                }
            }
        }
        
        // ì œí•œ ì´ˆê³¼ í•™ìƒ í™•ì¸
        let dayOverloadedStudents = 0;
        let dayHardOverloadedStudents = 0;
        
        // ì¼ë°˜ ì‹œí—˜ ìˆ˜ ì œí•œ í™•ì¸
        if (config.max_exams_per_day) {
            Object.entries(studentExamCounts).forEach(([student, count]) => {
                if (count > config.max_exams_per_day) {
                    dayOverloadedStudents++;
                    totalOverloadedStudents.add(student);
                }
            });
            
            if (dayOverloadedStudents > 0) {
                result.warnings.push(`${date}: ${dayOverloadedStudents}ëª…ì˜ í•™ìƒì´ í•˜ë£¨ ìµœëŒ€ ì‹œí—˜ ìˆ˜(${config.max_exams_per_day}ê°œ)ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`);
            }
        }
        
        // ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜ ì œí•œ í™•ì¸
        if (config.max_hard_exams_per_day) {
            Object.entries(studentHardExamCounts).forEach(([student, count]) => {
                if (count > config.max_hard_exams_per_day) {
                    dayHardOverloadedStudents++;
                    totalOverloadedStudents.add(student);
                }
            });
            
            if (dayHardOverloadedStudents > 0) {
                result.warnings.push(`${date}: ${dayHardOverloadedStudents}ëª…ì˜ í•™ìƒì´ í•˜ë£¨ ìµœëŒ€ ì–´ë ¤ìš´ ì‹œí—˜ ìˆ˜(${config.max_hard_exams_per_day}ê°œ)ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`);
            }
        }
    }
    
    result.overloadedStudents = totalOverloadedStudents.size;
    
    return result;
}

// ì‹œê°„í‘œ ê²€ì¦ ê²°ê³¼ë¥¼ UIì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function displayValidationResult(validationResult) {
    const { isValid, errors, warnings, statistics } = validationResult;
    
    let message = '=== ì‹œê°„í‘œ ê²€ì¦ ê²°ê³¼ ===\n\n';
    
    // í†µê³„ ì •ë³´
    message += `ğŸ“Š í†µê³„:\n`;
    message += `- ì „ì²´ ê³¼ëª©: ${statistics.totalSubjects}ê°œ\n`;
    message += `- ë°°ì •ëœ ê³¼ëª©: ${statistics.assignedSubjects}ê°œ\n`;
    message += `- ë¯¸ë°°ì • ê³¼ëª©: ${statistics.unassignedSubjects.length}ê°œ\n`;
    message += `- ì¶©ëŒ ìˆ˜: ${statistics.conflictCount}ê°œ\n`;
    message += `- ë¶€ë‹´ ì´ˆê³¼ í•™ìƒ: ${statistics.overloadedStudents}ëª…\n\n`;
    
    // ì „ì²´ ìƒíƒœ
    if (isValid) {
        message += 'âœ… ì‹œê°„í‘œê°€ ìœ íš¨í•©ë‹ˆë‹¤!\n\n';
    } else {
        message += 'âŒ ì‹œê°„í‘œì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n\n';
    }
    
    // ì˜¤ë¥˜ ëª©ë¡
    if (errors.length > 0) {
        message += `ğŸš« ì˜¤ë¥˜ (${errors.length}ê°œ):\n`;
        errors.forEach((error, index) => {
            message += `${index + 1}. ${error}\n`;
        });
        message += '\n';
    }
    
    // ê²½ê³  ëª©ë¡
    if (warnings.length > 0) {
        message += `âš ï¸ ê²½ê³  (${warnings.length}ê°œ):\n`;
        warnings.forEach((warning, index) => {
            message += `${index + 1}. ${warning}\n`;
        });
        message += '\n';
    }
    
    // ë¯¸ë°°ì • ê³¼ëª© ëª©ë¡
    if (statistics.unassignedSubjects.length > 0) {
        message += `ğŸ“ ë¯¸ë°°ì • ê³¼ëª©:\n`;
        statistics.unassignedSubjects.forEach((subject, index) => {
            message += `${index + 1}. ${subject}\n`;
        });
    }
    
    // ê²°ê³¼ë¥¼ ì½˜ì†”ê³¼ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
    console.log(message);
    
    // ê°„ë‹¨í•œ ìš”ì•½ì„ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
    const summaryMessage = isValid 
        ? `ì‹œê°„í‘œê°€ ìœ íš¨í•©ë‹ˆë‹¤! (${statistics.assignedSubjects}/${statistics.totalSubjects} ê³¼ëª© ë°°ì •)`
        : `ì‹œê°„í‘œì— ${errors.length}ê°œì˜ ì˜¤ë¥˜ì™€ ${warnings.length}ê°œì˜ ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤.`;
    
    showAlert(summaryMessage, isValid ? 'success' : 'warning');
}

// ìƒì„¸ ê²€ì¦ ê²°ê³¼ë¥¼ ëª¨ë‹¬ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function displayDetailedValidationResult(validationResult) {
    const { isValid, errors, warnings, statistics } = validationResult;
    
    // ìš”ì•½ ì •ë³´ ìƒì„±
    let summaryHtml = `
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card ${isValid ? 'border-success' : 'border-danger'}">
                    <div class="card-body text-center">
                        <h4 class="${isValid ? 'text-success' : 'text-danger'}">
                            <i class="fas fa-${isValid ? 'check-circle' : 'exclamation-triangle'}"></i>
                            ${isValid ? 'ìœ íš¨í•œ ì‹œê°„í‘œ' : 'ë¬¸ì œê°€ ìˆëŠ” ì‹œê°„í‘œ'}
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>í†µê³„</h6>
                        <small>
                            â€¢ ì „ì²´ ê³¼ëª©: ${statistics.totalSubjects}ê°œ<br>
                            â€¢ ë°°ì •ëœ ê³¼ëª©: ${statistics.assignedSubjects}ê°œ<br>
                            â€¢ ë¯¸ë°°ì • ê³¼ëª©: ${statistics.unassignedSubjects.length}ê°œ<br>
                            â€¢ ì¶©ëŒ ìˆ˜: ${statistics.conflictCount}ê°œ<br>
                            â€¢ ë¶€ë‹´ ì´ˆê³¼ í•™ìƒ: ${statistics.overloadedStudents}ëª…
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ì˜¤ë¥˜ ëª©ë¡
    let errorsHtml = '';
    if (errors.length > 0) {
        errorsHtml = `
            <div class="card border-danger mb-3">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        ì˜¤ë¥˜ (${errors.length}ê°œ) - ë°˜ë“œì‹œ í•´ê²°í•´ì•¼ í•¨
                    </h6>
                </div>
                <div class="card-body">
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${errors.map((error, index) => `
                            <div class="alert alert-danger py-2 mb-2">
                                <strong>${index + 1}.</strong> ${error.replace(/\n/g, '<br>')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ê²½ê³  ëª©ë¡
    let warningsHtml = '';
    if (warnings.length > 0) {
        warningsHtml = `
            <div class="card border-warning mb-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-circle"></i>
                        ê²½ê³  (${warnings.length}ê°œ) - ê²€í†  ê¶Œì¥
                    </h6>
                </div>
                <div class="card-body">
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${warnings.map((warning, index) => `
                            <div class="alert alert-warning py-2 mb-2">
                                <strong>${index + 1}.</strong> ${warning.replace(/\n/g, '<br>')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ë¯¸ë°°ì • ê³¼ëª© ëª©ë¡
    let unassignedHtml = '';
    if (statistics.unassignedSubjects.length > 0) {
        unassignedHtml = `
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-list"></i>
                        ë¯¸ë°°ì • ê³¼ëª© (${statistics.unassignedSubjects.length}ê°œ)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        ${statistics.unassignedSubjects.map(subject => `
                            <span class="badge bg-secondary">${subject}</span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ì„±ê³µ ë©”ì‹œì§€
    let successHtml = '';
    if (isValid && errors.length === 0 && warnings.length === 0) {
        successHtml = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle"></i> ì™„ë²½í•œ ì‹œê°„í‘œì…ë‹ˆë‹¤!</h5>
                <p>ëª¨ë“  ì œì•½ì¡°ê±´ì„ ë§Œì¡±í•˜ë©° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    }
    
    const fullContent = summaryHtml + successHtml + errorsHtml + warningsHtml + unassignedHtml;
    
    showDetailedAlert(
        'ì‹œê°„í‘œ ê²€ì¦ ê²°ê³¼',
        `${isValid ? 'âœ…' : 'âŒ'} ê²€ì¦ ì™„ë£Œ: ${errors.length}ê°œ ì˜¤ë¥˜, ${warnings.length}ê°œ ê²½ê³ `,
        fullContent,
        isValid ? 'info' : 'error',
        'modal-xl'  // ë” í° ëª¨ë‹¬ ì‚¬ìš©
    );
}

// ê³¼ëª©ì„ ìŠ¬ë¡¯ì— ë°°ì¹˜
function assignSubjectToSlot(subjectName, slotId) {
    console.log('assignSubjectToSlot í˜¸ì¶œ:', { subjectName, slotId, currentScheduleData: scheduleData });
    
    // ê¸°ì¡´ì— ë°°ì¹˜ëœ ê³³ì—ì„œ ì œê±°
    for (const slot of Object.keys(scheduleData)) {
        if (scheduleData[slot] && Array.isArray(scheduleData[slot])) {
            scheduleData[slot] = scheduleData[slot].filter(subject => subject !== subjectName);
            if (scheduleData[slot].length === 0) {
                delete scheduleData[slot];
            }
        }
    }
    
    // ìƒˆ ìŠ¬ë¡¯ì— ë°°ì¹˜ (ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±)
    if (!scheduleData[slotId]) {
        scheduleData[slotId] = [];
    }
    
    // ì¤‘ë³µ ì²´í¬
    if (!scheduleData[slotId].includes(subjectName)) {
        scheduleData[slotId].push(subjectName);
        console.log('ê³¼ëª© ë°°ì¹˜ ì™„ë£Œ:', { slotId, assignedSubjects: scheduleData[slotId] });
        
        // ìë™ ì €ì¥
        saveManualSchedule();
    } else {
        console.log('ì´ë¯¸ ë°°ì¹˜ëœ ê³¼ëª©ì…ë‹ˆë‹¤:', subjectName);
    }
}

// ì„ íƒëœ ìŠ¬ë¡¯ ì •ë³´ í‘œì‹œ (í˜„ì¬ëŠ” ì½˜ì†”ì—ë§Œ ë¡œê·¸ ì¶œë ¥)
function showSelectedSlotInfo(slotId) {
    // ìš°ì¸¡ íŒ¨ë„ì´ ì œê±°ë˜ì–´ ì •ë³´ í‘œì‹œ ì˜ì—­ì´ ì—†ìœ¼ë¯€ë¡œ ì½˜ì†”ì— ë¡œê·¸ë§Œ ì¶œë ¥
    const timeInfo = getTimeSlotInfo(slotId);
    const assignedSubjects = scheduleData[slotId] || [];
    
    console.log('ì„ íƒëœ ìŠ¬ë¡¯:', slotId);
    if (timeInfo) {
        console.log('ì‹œê°„ ì •ë³´:', `${timeInfo.start} - ${timeInfo.end} (${timeInfo.duration}ë¶„)`);
    }
    if (assignedSubjects.length > 0) {
        console.log('ë°°ì •ëœ ê³¼ëª©:', assignedSubjects.join(', '));
    } else {
        console.log('ë°°ì •ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // TODO: ë‚˜ì¤‘ì— ëª¨ë‹¬ì´ë‚˜ íˆ´íŒìœ¼ë¡œ ì •ë³´ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€ ê°€ëŠ¥
}

// ================== í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì‹œìŠ¤í…œ ==================

// í•™ìƒ ë¶€ë‹´ ì„¤ì •ê°’ ì €ì¥ (ê¸°ë³¸ê°’ ì—†ìŒ, ì‹¤ì œ ì„¤ì •ëœ ê°’ë§Œ ì‚¬ìš©)
let studentBurdenConfig = {};

// ê³µí†µ í•¨ìˆ˜: ë‚ ì§œë³„ í•™ìƒ ë¶€ë‹´ ê³„ì‚°
function calculateDayStudentBurden(dayLabel, currentScheduleData = null, additionalSubject = null, additionalSlotId = null) {
    const result = {
        studentExamCounts: {},
        studentHardExamCounts: {},
        examCountDistribution: {},
        hardExamCountDistribution: {}
    };
    
    // ìŠ¤ì¼€ì¤„ ë°ì´í„° ê²°ì • (í˜„ì¬ ìŠ¤ì¼€ì¤„ ë˜ëŠ” ì „ì—­ ìŠ¤ì¼€ì¤„)
    const targetSchedule = currentScheduleData || scheduleData;
    
    // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ìŠ¬ë¡¯ ì°¾ê¸°
    const daySlots = [];
    Object.keys(targetSchedule).forEach(slotId => {
        if (slotId.includes(dayLabel)) {
            daySlots.push(slotId);
        }
    });
    
    // ì¶”ê°€ ìŠ¬ë¡¯ì´ ìˆë‹¤ë©´ í¬í•¨ (ì²´í¬ ëª©ì )
    if (additionalSlotId && additionalSlotId.includes(dayLabel)) {
        if (!daySlots.includes(additionalSlotId)) {
            daySlots.push(additionalSlotId);
        }
    }
    
    // ëª¨ë“  í•™ìƒ ëª©ë¡ ìˆ˜ì§‘
    const allStudents = new Set();
    if (constraintData.subjectStats) {
        Object.values(constraintData.subjectStats).forEach(subjectStat => {
            if (subjectStat.students) {
                subjectStat.students.forEach(student => allStudents.add(student));
            }
        });
    }
    
    // í•™ìƒë³„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
    allStudents.forEach(student => {
        result.studentExamCounts[student] = 0;
        result.studentHardExamCounts[student] = 0;
    });
    
    // í•™ìƒë³„ ì‹¤ì œ ì‘ì‹œ ê³¼ëª© ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°ìš©)
    const studentSubjects = {};
    allStudents.forEach(student => {
        studentSubjects[student] = new Set();
    });
    
    // ê° ìŠ¬ë¡¯ì˜ ê³¼ëª©ë“¤ì„ í™•ì¸í•˜ì—¬ í•™ìƒë³„ ê³¼ëª© ìˆ˜ì§‘
    daySlots.forEach(slotId => {
        let subjects = targetSchedule[slotId] || [];
        
        // ì¶”ê°€ ê³¼ëª©ì´ ìˆë‹¤ë©´ í¬í•¨ (ì²´í¬ ëª©ì )
        if (additionalSubject && slotId === additionalSlotId) {
            subjects = [...subjects, additionalSubject];
        }
        
        subjects.forEach(subjectName => {
            const subjectStudents = constraintData.subjectStats[subjectName]?.students || [];
            const isHardSubject = constraintData.hardSubjects && constraintData.hardSubjects[subjectName];
            
            subjectStudents.forEach(student => {
                if (allStudents.has(student)) {
                    studentSubjects[student].add(subjectName);
                }
            });
        });
    });
    
    // í•™ìƒë³„ ì‹¤ì œ ì‹œí—˜ ìˆ˜ ê³„ì‚° (ì¤‘ë³µ ì œê±°ëœ ê³¼ëª©ìœ¼ë¡œ)
    allStudents.forEach(student => {
        const uniqueSubjects = Array.from(studentSubjects[student]);
        result.studentExamCounts[student] = uniqueSubjects.length;
        
        // ì–´ë ¤ìš´ ê³¼ëª© ìˆ˜ ê³„ì‚°
        result.studentHardExamCounts[student] = uniqueSubjects.filter(subject => 
            constraintData.hardSubjects && constraintData.hardSubjects[subject]
        ).length;
    });
    
    // ê³¼ëª© ìˆ˜ë³„ í•™ìƒ ìˆ˜ ì§‘ê³„ (ì¼ë°˜ ê³¼ëª©)
    Object.values(result.studentExamCounts).forEach(count => {
        if (count > 0) { // 0ê°œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
            result.examCountDistribution[count] = (result.examCountDistribution[count] || 0) + 1;
        }
    });
    
    // ê³¼ëª© ìˆ˜ë³„ í•™ìƒ ìˆ˜ ì§‘ê³„ (ì–´ë ¤ìš´ ê³¼ëª©)
    Object.values(result.studentHardExamCounts).forEach(count => {
        if (count > 0) { // 0ê°œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
            result.hardExamCountDistribution[count] = (result.hardExamCountDistribution[count] || 0) + 1;
        }
    });
    
    return result;
}

// í•™ìƒ ë¶€ë‹´ ë¶„ì„ ê³„ì‚°
function calculateStudentBurden() {
    const result = {
        general: {},  // ì¼ë°˜ ê³¼ëª© ë¶€ë‹´ ë¶„ì„
        hard: {}      // ì–´ë ¤ìš´ ê³¼ëª© ë¶€ë‹´ ë¶„ì„
    };
    
    console.log('í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì‹œì‘...');
    
    // ë‚ ì§œë³„ ë¶„ì„
    const examDates = getValidExamDates();
    
    examDates.forEach(([dayLabel, date]) => {
        console.log(`${dayLabel} ë¶„ì„ ì‹œì‘...`);
        
        // ê³µí†µ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚ ì§œë³„ ë¶€ë‹´ ê³„ì‚°
        const dayBurden = calculateDayStudentBurden(dayLabel);
        
        result.general[dayLabel] = dayBurden.examCountDistribution;
        result.hard[dayLabel] = dayBurden.hardExamCountDistribution;
        
        console.log(`${dayLabel} ì¼ë°˜ ê³¼ëª© ë¶„í¬:`, dayBurden.examCountDistribution);
        console.log(`${dayLabel} ì–´ë ¤ìš´ ê³¼ëª© ë¶„í¬:`, dayBurden.hardExamCountDistribution);
    });
    
    return result;
}

// ìœ íš¨í•œ ì‹œí—˜ ë‚ ì§œ ëª©ë¡ ë°˜í™˜
function getValidExamDates() {
    const examDates = examInfo.ì‹œí—˜ë‚ ì§œ || {};
    return Object.entries(examDates)
        .filter(([day, date]) => date && date !== 'nan' && date.trim() !== '')
        .sort((a, b) => {
            const numA = parseInt(a[0].match(/\d+/)?.[0] || '0');
            const numB = parseInt(b[0].match(/\d+/)?.[0] || '0');
            return numA - numB;
        });
}

// í•™ìƒ ë¶€ë‹´ ë¶„ì„ ê²°ê³¼ë¥¼ í…Œì´ë¸”ë¡œ ë Œë”ë§
function renderStudentBurdenAnalysis() {
    console.log('í•™ìƒ ë¶€ë‹´ ë¶„ì„ ë Œë”ë§ ì‹œì‘...');
    
    // ì„¤ì •ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
    const maxExamsElement = document.getElementById('maxExamsPerDay');
    const maxHardExamsElement = document.getElementById('maxHardExamsPerDay');
    
    if (window.studentBurdenConfig && window.studentBurdenConfig.max_exams_per_day !== undefined) {
        maxExamsElement.textContent = window.studentBurdenConfig.max_exams_per_day;
    } else {
        maxExamsElement.textContent = 'ì„¤ì • ì—†ìŒ';
    }
    
    if (window.studentBurdenConfig && window.studentBurdenConfig.max_hard_exams_per_day !== undefined) {
        maxHardExamsElement.textContent = window.studentBurdenConfig.max_hard_exams_per_day;
    } else {
        maxHardExamsElement.textContent = 'ì„¤ì • ì—†ìŒ';
    }
    
    const burdenData = calculateStudentBurden();
    const examDates = getValidExamDates();
    
    // ì¼ë°˜ ê³¼ëª© í…Œì´ë¸” ë Œë”ë§
    const generalMaxAllowed = window.studentBurdenConfig ? window.studentBurdenConfig.max_exams_per_day : undefined;
    renderBurdenTable('general', burdenData.general, examDates, generalMaxAllowed);
    
    // ì–´ë ¤ìš´ ê³¼ëª© í…Œì´ë¸” ë Œë”ë§  
    const hardMaxAllowed = window.studentBurdenConfig ? window.studentBurdenConfig.max_hard_exams_per_day : undefined;
    renderBurdenTable('hard', burdenData.hard, examDates, hardMaxAllowed);
}

// ë¶€ë‹´ ë¶„ì„ í…Œì´ë¸” ë Œë”ë§
function renderBurdenTable(type, data, examDates, maxAllowed) {
    console.log(`renderBurdenTable í˜¸ì¶œ: type=${type}, maxAllowed=${maxAllowed}`);
    console.log('data:', data);
    console.log('examDates:', examDates);
    
    const tableId = type === 'general' ? 'generalBurdenTable' : 'hardBurdenTable';
    const table = document.getElementById(tableId);
    console.log(`í…Œì´ë¸” ìš”ì†Œ ì°¾ê¸°: ${tableId}`, table);
    
    if (!table) {
        console.error(`í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${tableId}`);
        return;
    }
    
    const thead = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    console.log('thead:', thead, 'tbody:', tbody);
    
    // í—¤ë” ìƒì„±
    thead.innerHTML = '<th class="burden-header">ê³¼ëª© ìˆ˜</th>';
    examDates.forEach(([dayLabel, date]) => {
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        thead.innerHTML += `
            <th class="text-center">
                <div class="fw-bold">${dayLabel}</div>
                <small class="text-muted">${formattedDate}</small>
            </th>
        `;
    });
    
    // ëª¨ë“  ê³¼ëª© ìˆ˜ ìˆ˜ì§‘ (ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬)
    const allExamCounts = new Set();
    Object.values(data).forEach(dayData => {
        Object.keys(dayData).forEach(count => allExamCounts.add(parseInt(count)));
    });
    const sortedExamCounts = Array.from(allExamCounts).sort((a, b) => b - a);
    console.log('sortedExamCounts:', sortedExamCounts);
    
    // ë°”ë”” ìƒì„±
    tbody.innerHTML = '';
    console.log('í…Œì´ë¸” ë°”ë”” ì´ˆê¸°í™” ì™„ë£Œ');
    
    // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    if (sortedExamCounts.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `<td colspan="${examDates.length + 1}" class="text-center text-muted py-3">ê³¼ëª©ì„ ë°°ì¹˜í•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</td>`;
        tbody.appendChild(emptyRow);
        console.log(`${type} í…Œì´ë¸”ì— ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€`);
        return;
    }
    
    sortedExamCounts.forEach(examCount => {
        console.log(`í–‰ ìƒì„± ì¤‘: ${examCount}ê°œ`);
        const row = document.createElement('tr');
        row.innerHTML = `<td class="burden-header">${examCount}ê°œ</td>`;
        
        examDates.forEach(([dayLabel, date]) => {
            const studentCount = data[dayLabel][examCount] || 0;
            
            if (studentCount > 0) {
                // maxAllowedê°€ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ìƒ‰ìƒ ì½”ë”© ì ìš©
                let cellClass = '';
                if (maxAllowed !== undefined && maxAllowed !== null) {
                    cellClass = getBurdenCellClass(examCount, maxAllowed);
                }
                
                row.innerHTML += `
                    <td class="burden-cell ${cellClass}" 
                        onclick="showBurdenDetail('${type}', '${dayLabel}', ${examCount})"
                        title="í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ ë³´ê¸°">
                        ${studentCount}ëª…
                    </td>
                `;
            } else {
                row.innerHTML += '<td class="text-muted">-</td>';
            }
        });
        
        console.log(`í–‰ ì¶”ê°€: ${examCount}ê°œ`, row.innerHTML);
        tbody.appendChild(row);
    });
    
    console.log(`${type} í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ`);
    console.log(`${type} í…Œì´ë¸” í˜„ì¬ ìƒíƒœ:`, table.style.display, table.offsetHeight, table.offsetWidth);
}

// ë¶€ë‹´ ìˆ˜ì¤€ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜
function getBurdenCellClass(examCount, maxAllowed) {
    if (examCount <= maxAllowed - 2) {
        return 'normal';
    } else if (examCount === maxAllowed - 1) {
        return 'warning';
    } else {
        return 'danger';
    }
}

// ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
function showBurdenDetail(type, dayLabel, examCount) {
    console.log(`ìƒì„¸ ì •ë³´ í‘œì‹œ: ${type}, ${dayLabel}, ${examCount}ê°œ`);
    
    const modalTitle = document.getElementById('burdenDetailTitle');
    const modalContent = document.getElementById('burdenDetailContent');
    
    // ì œëª© ì„¤ì •
    const typeLabel = type === 'general' ? 'ì¼ë°˜ ê³¼ëª©' : 'ì–´ë ¤ìš´ ê³¼ëª©';
    modalTitle.innerHTML = `
        <i class="fas fa-users me-2"></i>
        ${dayLabel} - ${examCount}ê°œ ${typeLabel} ìˆ˜ê°• í•™ìƒ
    `;
    
    // ìƒì„¸ ì •ë³´ ìƒì„±
    const detailData = getBurdenDetailData(type, dayLabel, examCount);
    
    if (detailData.length === 0) {
        modalContent.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    } else {
        let html = `
            <div class="mb-3">
                <h6 class="text-secondary">
                    <i class="fas fa-chart-pie me-2"></i>
                    ê³¼ëª© ì¡°í•©ë³„ í•™ìƒ ë¶„í¬
                </h6>
                <p class="text-muted small">ì´ ${detailData.reduce((sum, item) => sum + item.students.length, 0)}ëª…ì´ í•˜ë£¨ì— ${examCount}ê°œ ${typeLabel}ì„ ìˆ˜ê°•í•©ë‹ˆë‹¤.</p>
            </div>
        `;
        
        detailData.forEach((item, index) => {
            const subjectList = item.subjects.join(' + ');
            const studentList = item.students.slice(0, 20).join(', ');
            const remainingCount = item.students.length - 20;
            
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-books me-2"></i>
                            ${subjectList}
                            <span class="badge bg-primary ms-2">${item.students.length}ëª…</span>
                        </h6>
                        <div class="card-text">
                            <small class="text-muted">ìˆ˜ê°• í•™ìƒ:</small><br>
                            <span class="text-dark">${studentList}</span>
                            ${remainingCount > 0 ? `<span class="text-muted"> ì™¸ ${remainingCount}ëª…</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        modalContent.innerHTML = html;
    }
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('burdenDetailModal'));
    modal.show();
}

// ìƒì„¸ ì •ë³´ ë°ì´í„° ìƒì„±
function getBurdenDetailData(type, dayLabel, examCount) {
    const result = [];
    
    // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ìŠ¬ë¡¯ ìˆ˜ì§‘
    const daySlots = [];
    Object.keys(scheduleData).forEach(slotId => {
        if (slotId.includes(dayLabel)) {
            daySlots.push(slotId);
        }
    });
    
    // ëª¨ë“  í•™ìƒ ëª©ë¡ ìˆ˜ì§‘
    const allStudents = new Set();
    if (constraintData.subjectStats) {
        Object.values(constraintData.subjectStats).forEach(subjectStat => {
            if (subjectStat.students) {
                subjectStat.students.forEach(student => allStudents.add(student));
            }
        });
    }
    
    // ê° í•™ìƒë³„ë¡œ í•´ë‹¹ ë‚ ì§œì˜ ì‹œí—˜ ê³¼ëª© ëª©ë¡ ê³„ì‚°
    const studentSubjects = {};
    allStudents.forEach(student => {
        studentSubjects[student] = [];
    });
    
    daySlots.forEach(slotId => {
        const subjects = scheduleData[slotId] || [];
        
        subjects.forEach(subjectName => {
            const subjectStudents = constraintData.subjectStats[subjectName]?.students || [];
            const isHardSubject = constraintData.hardSubjects && constraintData.hardSubjects[subjectName];
            
            subjectStudents.forEach(student => {
                if (allStudents.has(student)) {
                    // ì¼ë°˜ ê³¼ëª© ë˜ëŠ” ì–´ë ¤ìš´ ê³¼ëª© í•„í„°ë§
                    if (type === 'general' || (type === 'hard' && isHardSubject)) {
                        studentSubjects[student].push(subjectName);
                    }
                }
            });
        });
    });
    
    // ì •í™•íˆ examCountê°œ ê³¼ëª©ì„ ìˆ˜ê°•í•˜ëŠ” í•™ìƒë“¤ í•„í„°ë§
    const targetStudents = [];
    Object.entries(studentSubjects).forEach(([student, subjects]) => {
        if (subjects.length === examCount) {
            targetStudents.push({ student, subjects: subjects.sort() });
        }
    });
    
    // ê³¼ëª© ì¡°í•©ë³„ë¡œ ê·¸ë£¹í™”
    const subjectCombinations = {};
    targetStudents.forEach(({ student, subjects }) => {
        const key = subjects.join('|');
        if (!subjectCombinations[key]) {
            subjectCombinations[key] = {
                subjects: subjects,
                students: []
            };
        }
        subjectCombinations[key].students.push(student);
    });
    
    // ê²°ê³¼ ë°°ì—´ë¡œ ë³€í™˜ (í•™ìƒ ìˆ˜ê°€ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬)
    Object.values(subjectCombinations).forEach(combination => {
        result.push({
            subjects: combination.subjects,
            students: combination.students.sort()
        });
    });
    
    result.sort((a, b) => b.students.length - a.students.length);
    
    return result;
}

// íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥
function initializeBurdenPanelToggle() {
    const toggleButton = document.getElementById('toggleBurdenPanel');
    const panelBody = document.getElementById('burdenPanelBody');
    const panelIcon = document.getElementById('burdenPanelIcon');
    
    if (toggleButton && panelBody && panelIcon) {
        toggleButton.addEventListener('click', function() {
            if (panelBody.classList.contains('collapsed')) {
                // í¼ì¹˜ê¸°
                panelBody.classList.remove('collapsed');
                panelIcon.className = 'fas fa-chevron-up';
                
                // í¼ì¹  ë•Œ ë°ì´í„° ì—…ë°ì´íŠ¸
                renderStudentBurdenAnalysis();
            } else {
                // ì ‘ê¸°
                panelBody.classList.add('collapsed');
                panelIcon.className = 'fas fa-chevron-down';
            }
        });
    }
}

// ================== ê³¼ëª© ì¶”ì²œ ì‹œìŠ¤í…œ ==================

// ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ ì„¤ì •ê°’ë“¤ (ì¡°ì • ê°€ëŠ¥)
const RECOMMENDATION_CONFIG = {
    weights: {
        constraint: 0.4,    // ì œì•½ë°€ë„ ê°€ì¤‘ì¹˜ (40%)
        domain: 0.3,        // ë„ë©”ì¸í¬ê¸° ê°€ì¤‘ì¹˜ (30%)
        difficulty: 0.2,    // ì–´ë ¤ìš´ê³¼ëª© ê°€ì¤‘ì¹˜ (20%)
        duration: 0.1       // ì‹œí—˜ì‹œê°„ ê°€ì¤‘ì¹˜ (10%)
    },
    scores: {
        conflictMultiplier: 10,     // ì¶©ëŒ 1ê°œë‹¹ ì ìˆ˜
        hardSubjectBonus: 25,       // ì–´ë ¤ìš´ ê³¼ëª© ë³´ë„ˆìŠ¤ ì ìˆ˜
        maxDomainScore: 50,         // ë„ë©”ì¸ ì ìˆ˜ ìµœëŒ€ê°’
        impossiblePenalty: 100,     // ë°°ì¹˜ ë¶ˆê°€ëŠ¥ ì‹œ í˜ë„í‹°
        period2OnlyBonus: 15        // 2êµì‹œ ì „ìš© ê³¼ëª© ë³´ë„ˆìŠ¤
    },
    thresholds: {
        conflictRatio: 0.2,         // ì „ì²´ ê³¼ëª©ì˜ ëª‡ %ì´ìƒ ì¶©ëŒ ì‹œ í‘œì‹œ
        minConflictCount: 3,        // ìµœì†Œ ì¶©ëŒ í‘œì‹œ ê°œìˆ˜
        lowSlotThreshold: 3         // ìŠ¬ë¡¯ì´ ì ë‹¤ê³  í‘œì‹œí•  ê¸°ì¤€
    }
};

// ì‹œí—˜ ì‹œê°„ ê¸°ì¤€ê°’ë“¤ (ë™ì ìœ¼ë¡œ ê³„ì‚°ë¨)
let timeThresholds = {
    short: 50,      // ì§§ì€ ì‹œí—˜ ê¸°ì¤€ (ê¸°ë³¸ê°’)
    medium: 80,     // ì¤‘ê°„ ì‹œê°„ ê¸°ì¤€ (ê¸°ë³¸ê°’)
    long: 100,      // ê¸´ ì‹œí—˜ ê¸°ì¤€ (ê¸°ë³¸ê°’)
    maxDuration: 100, // ì •ê·œí™” ê¸°ì¤€ (ê¸°ë³¸ê°’)
    periods: {},    // êµì‹œë³„ ì‹œê°„ ì œí•œ (ë™ì ìœ¼ë¡œ ì±„ì›Œì§)
    shortestPeriod: 50  // ê°€ì¥ ì§§ì€ êµì‹œì˜ ì‹œê°„ (ë™ì ìœ¼ë¡œ ê³„ì‚°ë¨)
};

// custom_exam_info.jsonì—ì„œ êµì‹œë³„ ì‹œê°„ ì œí•œ ë¡œë“œ
async function loadPeriodLimitsFromExamInfo() {
    try {
        console.log('custom_exam_info.jsonì—ì„œ êµì‹œ ì •ë³´ ë¡œë“œ ì¤‘...');
        
        const response = await fetch('/uploads/custom_exam_info.json');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const examInfo = await response.json();
        
        if (!examInfo.date_periods) {
            console.log('date_periods ì •ë³´ê°€ ì—†ìŒ');
            return;
        }
        
        const allDurations = [];
        const periodLimits = {};
        
        // ëª¨ë“  ë‚ ì§œì™€ êµì‹œì˜ duration ìˆ˜ì§‘
        for (const dayKey in examInfo.date_periods) {
            const dayPeriods = examInfo.date_periods[dayKey];
            for (const periodKey in dayPeriods) {
                const periodInfo = dayPeriods[periodKey];
                if (periodInfo.duration) {
                    const duration = parseInt(periodInfo.duration);
                    if (!isNaN(duration) && duration > 0) {
                        allDurations.push(duration);
                        
                        // êµì‹œë³„ ì œí•œ ì‹œê°„ ìˆ˜ì§‘
                        if (!periodLimits[periodKey]) {
                            periodLimits[periodKey] = [];
                        }
                        periodLimits[periodKey].push(duration);
                    }
                }
            }
        }
        
        if (allDurations.length === 0) {
            console.log('ìœ íš¨í•œ êµì‹œ ì‹œê°„ ì •ë³´ê°€ ì—†ìŒ');
            return;
        }
        
        // êµì‹œë³„ ì‹œê°„ ì œí•œ ì„¤ì • (ê° êµì‹œì˜ ìµœì†Œê°’ ì‚¬ìš©)
        timeThresholds.periods = {};
        for (const period in periodLimits) {
            timeThresholds.periods[period] = Math.min(...periodLimits[period]);
        }
        
        // ê°€ì¥ ì§§ì€ êµì‹œ ì‹œê°„ ì°¾ê¸°
        const allPeriodLimits = Object.values(timeThresholds.periods);
        if (allPeriodLimits.length > 0) {
            timeThresholds.shortestPeriod = Math.min(...allPeriodLimits);
        }
        
        console.log('ë¡œë“œëœ êµì‹œë³„ ì‹œê°„ ì œí•œ:', timeThresholds.periods);
        console.log(`ê°€ì¥ ì§§ì€ êµì‹œ: ${timeThresholds.shortestPeriod}ë¶„`);
        
        // ì „ì²´ êµì‹œ ì‹œê°„ í†µê³„
        console.log('êµì‹œ ì‹œê°„ í†µê³„:', {
            'ì „ì²´ ë²”ìœ„': `${Math.min(...allDurations)}-${Math.max(...allDurations)}ë¶„`,
            'êµì‹œ ê°œìˆ˜': Object.keys(timeThresholds.periods).length + 'ê°œ',
            'í‰ê·  ì‹œê°„': Math.round(allDurations.reduce((a, b) => a + b, 0) / allDurations.length) + 'ë¶„'
        });
        
    } catch (error) {
        console.error('êµì‹œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        console.log('ê¸°ë³¸ê°’ ì‚¬ìš©');
    }
}

// ì‹œí—˜ ì‹œê°„ ê¸°ì¤€ê°’ë“¤ì„ ë™ì ìœ¼ë¡œ ê³„ì‚°
async function calculateTimeThresholds() {
    console.log('ì‹œí—˜ ì‹œê°„ ê¸°ì¤€ê°’ ê³„ì‚° ì‹œì‘...');
    
    // ê³¼ëª©ë³„ ì‹œí—˜ ì‹œê°„ ìˆ˜ì§‘
    const durations = [];
    for (const subject in subjectInfo) {
        const duration = subjectInfo[subject]?.ì‹œê°„;
        if (duration && duration > 0) {
            durations.push(duration);
        }
    }
    
    if (durations.length === 0) {
        console.log('ì‹œí—˜ ì‹œê°„ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ê°’ ì‚¬ìš©');
        return;
    }
    
    // í†µê³„ ê³„ì‚°
    durations.sort((a, b) => a - b);
    const min = durations[0];
    const max = durations[durations.length - 1];
    const median = durations[Math.floor(durations.length / 2)];
    const q1 = durations[Math.floor(durations.length * 0.25)];
    const q3 = durations[Math.floor(durations.length * 0.75)];
    
    // ê¸°ì¤€ê°’ ì—…ë°ì´íŠ¸ (ì‚¬ë¶„ìœ„ìˆ˜ ê¸°ë°˜)
    timeThresholds.short = q1;           // í•˜ìœ„ 25% ê¸°ì¤€
    timeThresholds.medium = median;      // ì¤‘ê°„ê°’ ê¸°ì¤€  
    timeThresholds.long = q3;           // ìƒìœ„ 25% ê¸°ì¤€
    timeThresholds.maxDuration = max;   // ì •ê·œí™”ìš© ìµœëŒ€ê°’
    
    // custom_exam_info.jsonì—ì„œ êµì‹œë³„ ì‹œê°„ ì œí•œ ë¡œë“œ
    await loadPeriodLimitsFromExamInfo();
    
    console.log('ê³„ì‚°ëœ ì‹œí—˜ ì‹œê°„ ê¸°ì¤€ê°’:', {
        'ì§§ì€ ì‹œí—˜ (Q1)': timeThresholds.short + 'ë¶„',
        'ì¤‘ê°„ ì‹œí—˜ (Median)': timeThresholds.medium + 'ë¶„', 
        'ê¸´ ì‹œí—˜ (Q3)': timeThresholds.long + 'ë¶„',
        'ìµœëŒ€ ì‹œê°„': timeThresholds.maxDuration + 'ë¶„',
        '2êµì‹œ ìµœëŒ€': timeThresholds.period2Max + 'ë¶„',
        'ì „ì²´ ë²”ìœ„': `${min}-${max}ë¶„ (${durations.length}ê°œ ê³¼ëª©)`
    });
}

// ê³¼ëª© ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ (ë¹ ë¥´ê³  ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)
function calculateSubjectRecommendations() {
    const unassignedSubjects = getUnassignedSubjects();
    const recommendations = [];
    
    console.log('ì¶”ì²œ ê³„ì‚° ì‹œì‘. ë¯¸ë°°ì¹˜ ê³¼ëª©:', unassignedSubjects.length);
    console.log('constraintData ìƒíƒœ:', constraintData);
    console.log('constraintData keys:', constraintData ? Object.keys(constraintData) : 'null');
    
    // ì œì•½ì¡°ê±´ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê¸°ë³¸ ì¶”ì²œ ì œê³µ
    if (!constraintData || Object.keys(constraintData).length === 0) {
        console.log('ì œì•½ì¡°ê±´ ë°ì´í„°ê°€ ì—†ìŒ. ê¸°ë³¸ ì¶”ì²œ ì‚¬ìš©');
        return getBasicRecommendations(unassignedSubjects);
    }
    
    for (const subjectName of unassignedSubjects) {
        let score = 0;
        let reasons = [];
        
        // 1. ì œì•½ ë°€ë„ - ì¶©ëŒì´ ë§ì€ ê³¼ëª© ìš°ì„ 
        const conflicts = getSubjectConflicts(subjectName);
        console.log(`[ë©”ì¸ì¶”ì²œ] ${subjectName} ì´ ì¶©ëŒ ê³„ì‚°:`, conflicts);
        console.log(`[ë©”ì¸ì¶”ì²œ] constraintData.individualConflicts ê¸¸ì´:`, constraintData.individualConflicts?.length || 0);
        console.log(`[ë©”ì¸ì¶”ì²œ] constraintData.teacherConflicts ê¸¸ì´:`, constraintData.teacherConflicts?.length || 0);
        
        const conflictScore = conflicts.length * RECOMMENDATION_CONFIG.scores.conflictMultiplier;
        score += conflictScore * RECOMMENDATION_CONFIG.weights.constraint;
        
        // ë™ì  ì„ê³„ê°’: ì „ì²´ ê³¼ëª©ì˜ ì¼ì • ë¹„ìœ¨ ì´ìƒ ì¶©ëŒ ì‹œ í‘œì‹œ
        const totalSubjects = Object.keys(subjectInfo).length;
        const conflictThreshold = Math.max(
            RECOMMENDATION_CONFIG.thresholds.minConflictCount, 
            Math.floor(totalSubjects * RECOMMENDATION_CONFIG.thresholds.conflictRatio)
        );
        if (conflicts.length >= conflictThreshold) {
            reasons.push(`${conflicts.length}ê°œ ê³¼ëª©ê³¼ ì¶©ëŒ`);
        }
        
        // 2. ë„ë©”ì¸ í¬ê¸° - ë°°ì¹˜ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ì´ ì ì€ ê³¼ëª© ìš°ì„ 
        const availableSlots = getAvailableSlots(subjectName);
        const totalSlots = getAllSlots().length;
        const domainScore = availableSlots.length > 0 ? 
            (totalSlots - availableSlots.length) * (RECOMMENDATION_CONFIG.scores.maxDomainScore / totalSlots) : 
            RECOMMENDATION_CONFIG.scores.impossiblePenalty;
        score += domainScore * RECOMMENDATION_CONFIG.weights.domain;
        if (availableSlots.length <= RECOMMENDATION_CONFIG.thresholds.lowSlotThreshold) {
            reasons.push(`ë°°ì¹˜ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ ${availableSlots.length}ê°œ`);
        }
        
        // 3. ì–´ë ¤ìš´ ê³¼ëª© ë³´ë„ˆìŠ¤
        const isHard = constraintData.hardSubjects && constraintData.hardSubjects[subjectName];
        if (isHard) {
            score += RECOMMENDATION_CONFIG.scores.hardSubjectBonus * RECOMMENDATION_CONFIG.weights.difficulty;
            reasons.push('ì–´ë ¤ìš´ ê³¼ëª©');
        }
        
        // 4. ì‹œí—˜ ì‹œê°„ - ê¸´ ì‹œí—˜ ìš°ì„ 
        const duration = subjectInfo[subjectName]?.ì‹œê°„ || timeThresholds.short;
        const timeScore = (duration / timeThresholds.maxDuration) * 10; // ë™ì  ì •ê·œí™”
        score += timeScore * RECOMMENDATION_CONFIG.weights.duration;
        if (duration > timeThresholds.long) {
            reasons.push('ê¸´ ì‹œí—˜ ì‹œê°„');
        }
        
        // 5. ë³´ë„ˆìŠ¤: ê°€ì¥ ì§§ì€ êµì‹œì—ë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê³¼ëª©
        if (duration <= timeThresholds.shortestPeriod) {
            // ê°€ì¥ ì§§ì€ êµì‹œì—ë§Œ ë°°ì¹˜ ê°€ëŠ¥í•œì§€ í™•ì¸
            const shortPeriodSlots = availableSlots.filter(slot => {
                // ê°€ì¥ ì§§ì€ ì‹œê°„ ì œí•œì„ ê°€ì§„ êµì‹œ ìŠ¬ë¡¯ì¸ì§€ í™•ì¸
                return Object.keys(timeThresholds.periods).some(period => {
                    return slot.includes(`${period}êµì‹œ`) && timeThresholds.periods[period] === timeThresholds.shortestPeriod;
                });
            });
            
            if (shortPeriodSlots.length > 0 && availableSlots.length === shortPeriodSlots.length) {
                score += RECOMMENDATION_CONFIG.scores.period2OnlyBonus;
                reasons.push('ì§§ì€ êµì‹œ ì „ìš©');
            }
        }
        
        recommendations.push({
            subject: subjectName,
            score: score,
            reasons: reasons,
            availableSlots: availableSlots.length,
            conflicts: conflicts.length
        });
    }
    
    // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
    recommendations.sort((a, b) => b.score - a.score);
    
    console.log('ì¶”ì²œ ê²°ê³¼ (ìƒìœ„ 5ê°œ):', recommendations.slice(0, 5));
    
    return recommendations;
}

// ì œì•½ì¡°ê±´ ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ì¶”ì²œ (ì‹œí—˜ ì‹œê°„ê³¼ ê°€ëŠ¥ ìŠ¬ë¡¯ë§Œ ê³ ë ¤)
function getBasicRecommendations(unassignedSubjects) {
    const recommendations = [];
    
    for (const subjectName of unassignedSubjects) {
        let score = 0;
        let reasons = [];
        
        // 1. ì‹œí—˜ ì‹œê°„ ê¸°ì¤€ (ê¸´ ì‹œí—˜ ìš°ì„ )
        const duration = subjectInfo[subjectName]?.ì‹œê°„ || timeThresholds.short;
        score += duration * 0.5; // ì‹œê°„ì— ë¹„ë¡€í•œ ì ìˆ˜
        
        if (duration > timeThresholds.long) {
            reasons.push('ê¸´ ì‹œí—˜ ì‹œê°„');
        } else if (duration <= timeThresholds.shortestPeriod) {
            reasons.push('ì§§ì€ êµì‹œ ê°€ëŠ¥');
        }
        
        // 2. ë°°ì¹˜ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ ìˆ˜ (ì ì„ìˆ˜ë¡ ìš°ì„ )
        const availableSlots = getAvailableSlots(subjectName);
        const totalSlots = getAllSlots().length; // ì‹¤ì œ ì „ì²´ ìŠ¬ë¡¯ ìˆ˜ ë™ì  ê³„ì‚°
        const domainScore = availableSlots.length > 0 ? 
            (totalSlots - availableSlots.length) * (30 / totalSlots) : 50;
        score += domainScore;
        
        if (availableSlots.length <= 3) {
            reasons.push(`ê°€ëŠ¥ ìŠ¬ë¡¯ ${availableSlots.length}ê°œ`);
        }
        
        // ê¸°ë³¸ ì´ìœ ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (reasons.length === 0) {
            reasons.push('ë°°ì¹˜ ê¶Œì¥');
        }
        
        // 3. ì¶©ëŒ ì •ë³´ ê³„ì‚° (ê°€ëŠ¥í•œ ê²½ìš°)
        const conflicts = getSubjectConflicts(subjectName);
        let conflictScore = 0;
        
        console.log(`[ê¸°ë³¸ì¶”ì²œ] ${subjectName} ì¶©ëŒ ê³„ì‚°:`, conflicts);
        
        if (conflicts.length > 0) {
            conflictScore = conflicts.length * 5; // ì¶©ëŒë‹¹ 5ì 
            score += conflictScore;
            
            if (conflicts.length >= 3) {
                reasons.push(`${conflicts.length}ê°œ ê³¼ëª©ê³¼ ì¶©ëŒ`);
            }
        }
        
        recommendations.push({
            subject: subjectName,
            score: score,
            reasons: reasons,
            availableSlots: availableSlots.length,
            conflicts: conflicts.length // ì‹¤ì œ ì¶©ëŒ ìˆ˜ ë°˜ì˜
        });
    }
    
    // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
    recommendations.sort((a, b) => b.score - a.score);
    
    console.log('ê¸°ë³¸ ì¶”ì²œ ê²°ê³¼ (ìƒìœ„ 5ê°œ):', recommendations.slice(0, 5));
    
    return recommendations;
}

// ê³¼ëª©ì˜ ì¶©ëŒ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
function getSubjectConflicts(subjectName) {
    const conflicts = new Set();
    
    console.log(`[getSubjectConflicts] ${subjectName} ì‹œì‘`);
    
    // ì œì•½ì¡°ê±´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
    if (!constraintData) {
        console.log(`[getSubjectConflicts] constraintDataê°€ null/undefined`);
        return [];
    }
    
    // í•™ìƒ ì¶©ëŒ (ê°ì²´ì˜ í‚¤ì—ì„œ í•´ë‹¹ ê³¼ëª©ì´ í¬í•¨ëœ í•­ëª© ì°¾ê¸°)
    let studentConflictSubjects = [];
    if (constraintData.subjectConflicts) {
        Object.keys(constraintData.subjectConflicts).forEach(conflictKey => {
            const conflict = constraintData.subjectConflicts[conflictKey];
            if (conflict.subject1 === subjectName) {
                studentConflictSubjects.push(conflict.subject2);
            } else if (conflict.subject2 === subjectName) {
                studentConflictSubjects.push(conflict.subject1);
            }
        });
    }
    console.log(`[getSubjectConflicts] ${subjectName} ì‚¬ìš©ì ì„¤ì • ì¶©ëŒ:`, studentConflictSubjects);
    studentConflictSubjects.forEach(conflict => conflicts.add(conflict));
    
    // ê°œë³„ í•™ìƒ ì¶©ëŒ (individual_conflicts.json ë˜ëŠ” same_grade_conflicts.json)
    let individualConflictSubjects = [];
    
    // individual_conflicts.jsonì´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ì‚¬ìš©
    if (constraintData.individualConflicts && Array.isArray(constraintData.individualConflicts) && constraintData.individualConflicts.length > 0) {
        constraintData.individualConflicts.forEach(conflict => {
            if (conflict.subject1 === subjectName) {
                individualConflictSubjects.push(conflict.subject2);
            } else if (conflict.subject2 === subjectName) {
                individualConflictSubjects.push(conflict.subject1);
            }
        });
        console.log(`[getSubjectConflicts] ${subjectName} individual_conflicts ì‚¬ìš©:`, individualConflictSubjects);
    } 
    // individual_conflictsê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ same_grade_conflicts ì‚¬ìš©
    else if (constraintData.sameGradeConflicts && Array.isArray(constraintData.sameGradeConflicts)) {
        constraintData.sameGradeConflicts.forEach(conflict => {
            if (conflict.subject1 === subjectName) {
                individualConflictSubjects.push(conflict.subject2);
            } else if (conflict.subject2 === subjectName) {
                individualConflictSubjects.push(conflict.subject1);
            }
        });
        console.log(`[getSubjectConflicts] ${subjectName} same_grade_conflicts ì‚¬ìš©:`, individualConflictSubjects);
    }
    
    individualConflictSubjects.forEach(conflict => conflicts.add(conflict));
    
    // êµì‚¬ ì¶©ëŒ (ë°°ì—´ì—ì„œ subject1, subject2ë¡œ ì €ì¥ëœ í•­ëª© ì°¾ê¸°)
    let teacherConflictSubjects = [];
    if (constraintData.teacherConflicts && Array.isArray(constraintData.teacherConflicts)) {
        constraintData.teacherConflicts.forEach(conflict => {
            if (conflict.subject1 === subjectName) {
                teacherConflictSubjects.push(conflict.subject2);
            } else if (conflict.subject2 === subjectName) {
                teacherConflictSubjects.push(conflict.subject1);
            }
        });
    }
    console.log(`[getSubjectConflicts] ${subjectName} êµì‚¬ ì¶©ëŒ:`, teacherConflictSubjects);
    teacherConflictSubjects.forEach(conflict => conflicts.add(conflict));
    
    // ë“£ê¸° ì¶©ëŒ (êµì‚¬ ì¶©ëŒê³¼ ê°™ì€ êµ¬ì¡°ë¡œ ê°€ì •)
    let listeningConflictSubjects = [];
    if (constraintData.listeningConflicts && Array.isArray(constraintData.listeningConflicts)) {
        constraintData.listeningConflicts.forEach(conflict => {
            if (conflict.subject1 === subjectName) {
                listeningConflictSubjects.push(conflict.subject2);
            } else if (conflict.subject2 === subjectName) {
                listeningConflictSubjects.push(conflict.subject1);
            }
        });
    }
    console.log(`[getSubjectConflicts] ${subjectName} ë“£ê¸° ì¶©ëŒ:`, listeningConflictSubjects);
    listeningConflictSubjects.forEach(conflict => conflicts.add(conflict));
    
    const result = Array.from(conflicts);
    console.log(`[getSubjectConflicts] ${subjectName} ìµœì¢… ì¶©ëŒ:`, result);
    
    return result;
}

// ê³¼ëª©ì´ ë°°ì¹˜ ê°€ëŠ¥í•œ ìŠ¬ë¡¯ ë°˜í™˜
function getAvailableSlots(subjectName) {
    const allSlots = getAllSlots();
    const availableSlots = [];
    
    for (const slotId of allSlots) {
        const canPlace = canPlaceSubjectInSlot(subjectName, slotId);
        if (canPlace.canPlace) {
            availableSlots.push(slotId);
        }
    }
    
    return availableSlots;
}

// ëª¨ë“  ìŠ¬ë¡¯ ID ë°˜í™˜
function getAllSlots() {
    const slots = [];
    const scheduleGrid = document.querySelector('.schedule-grid');
    if (scheduleGrid) {
        const cells = scheduleGrid.querySelectorAll('[data-slot]');
        cells.forEach(cell => {
            if (cell.dataset.slot) {
                slots.push(cell.dataset.slot);
            }
        });
    }
    return slots;
}

// ë¯¸ë°°ì¹˜ ê³¼ëª© ë°˜í™˜
function getUnassignedSubjects() {
    const allSubjects = Object.keys(subjectInfo);
    const assignedSubjects = new Set();
    
    Object.values(scheduleData).forEach(subjectList => {
        if (Array.isArray(subjectList)) {
            subjectList.forEach(subject => assignedSubjects.add(subject));
        }
    });
    
    return allSubjects.filter(subject => !assignedSubjects.has(subject));
}

// ìƒë‹¨ ë°°ë„ˆ ì¶”ì²œ ì—…ë°ì´íŠ¸
function updateRecommendationBanner() {
    const container = document.getElementById('bannerRecommendations');
    
    // ê³¼ëª© ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¡œë”© í‘œì‹œ
    if (!subjectInfo || Object.keys(subjectInfo).length === 0) {
        container.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ê³¼ëª© ì •ë³´ ë¡œë”© ì¤‘...';
        return;
    }
    
    // ì‹œê°„ ê¸°ì¤€ê°’ì´ ê¸°ë³¸ê°’ì´ë©´ ë‹¤ì‹œ ê³„ì‚°
    if (timeThresholds.maxDuration === 100 && Object.keys(subjectInfo).length > 0) {
        calculateTimeThresholds().catch(error => {
            console.error('ì‹œê°„ ê¸°ì¤€ê°’ ê³„ì‚° ì‹¤íŒ¨:', error);
        });
    }
    
    const recommendations = calculateSubjectRecommendations();
    
    if (recommendations.length === 0) {
        container.innerHTML = '<i class="fas fa-check-circle me-2"></i>ëª¨ë“  ê³¼ëª©ì´ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!';
        return;
    }
    
    // ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
    const topRecommendations = recommendations.slice(0, 3);
    
    let html = '';
    topRecommendations.forEach((rec, index) => {
        const priorityNum = index + 1;
        const priorityText = priorityNum + 'ìˆœìœ„';
        
        html += `
            <span class="banner-recommendation-item" 
                  data-subject="${rec.subject}"
                  title="${rec.reasons.join(', ')} (ì ìˆ˜: ${rec.score.toFixed(1)})">
                <span class="priority-badge priority-${priorityNum}">${priorityNum}</span>
                ${rec.subject}
            </span>
        `;
    });
    
    container.innerHTML = html;
}

// ì¶”ì²œ UI ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì‚¬ì´ë“œë°”ìš© - ìˆ¨ê¹€)
function updateRecommendationUI() {
    const container = document.getElementById('recommendedSubjects');
    
    // ê³¼ëª© ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¡œë”© í‘œì‹œ
    if (!subjectInfo || Object.keys(subjectInfo).length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-2">
                <i class="fas fa-spinner fa-spin"></i>
                <small>ê³¼ëª© ì •ë³´ ë¡œë”© ì¤‘...</small>
            </div>
        `;
        return;
    }
    
    // ì‹œê°„ ê¸°ì¤€ê°’ì´ ê¸°ë³¸ê°’ì´ë©´ ë‹¤ì‹œ ê³„ì‚°
    if (timeThresholds.maxDuration === 100 && Object.keys(subjectInfo).length > 0) {
        calculateTimeThresholds().catch(error => {
            console.error('ì‹œê°„ ê¸°ì¤€ê°’ ê³„ì‚° ì‹¤íŒ¨:', error);
        });
    }
    
    const recommendations = calculateSubjectRecommendations();
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center text-success py-2">
                <i class="fas fa-check-circle"></i>
                <small>ëª¨ë“  ê³¼ëª©ì´ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!</small>
            </div>
        `;
        return;
    }
    
    // ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
    const topRecommendations = recommendations.slice(0, 3);
    
    let html = '';
    
    // ì œì•½ì¡°ê±´ ë°ì´í„° ìƒíƒœ í‘œì‹œ
    const hasConstraintData = constraintData && Object.keys(constraintData).length > 0;
    if (!hasConstraintData) {
        html += `
            <div class="alert alert-warning py-1 px-2 mb-2" style="font-size: 11px;">
                <i class="fas fa-exclamation-triangle"></i>
                <small>ì œì•½ì¡°ê±´ ë°ì´í„° ì—†ìŒ (ê¸°ë³¸ ì¶”ì²œ)</small>
            </div>
        `;
    }
    
    topRecommendations.forEach((rec, index) => {
        const priority = index === 0 ? 'high' : index === 1 ? 'medium' : 'low';
        const priorityText = index === 0 ? '1ìˆœìœ„' : index === 1 ? '2ìˆœìœ„' : '3ìˆœìœ„';
        
        html += `
            <div class="recommended-item" 
                 data-subject="${rec.subject}"
                 title="${rec.reasons.join(', ')}"
                 onclick="highlightRecommendedSubject('${rec.subject}')">
                <div>
                    <div class="subject-name">${rec.subject}</div>
                    <small class="text-muted">${rec.reasons.slice(0, 2).join(', ')}</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="priority-badge priority-${priority}">${priorityText}</span>
                    <i class="fas fa-info-circle reason-icon" 
                       title="ì ìˆ˜: ${rec.score.toFixed(1)}, ê°€ëŠ¥ ìŠ¬ë¡¯: ${rec.availableSlots}ê°œ${hasConstraintData ? ', ì¶©ëŒ: ' + rec.conflicts + 'ê°œ' : ''}"></i>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ì¶”ì²œ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
function showRecommendationDetails() {
    const recommendations = calculateSubjectRecommendations();
    
    if (recommendations.length === 0) {
        showAlert('í‘œì‹œí•  ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        return;
    }
    
    let modalContent = `
        <div class="modal fade" id="recommendationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-lightbulb me-2"></i>
                            ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ìƒì„¸ ì •ë³´
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12">
                                <h6 class="mb-3">
                                    <i class="fas fa-chart-line me-2"></i>
                                    ì¶”ì²œ ìˆœìœ„ ë° ì´ìœ 
                                </h6>
    `;
    
    recommendations.slice(0, 5).forEach((rec, index) => {
        const priorityNum = index + 1;
        const priorityColor = priorityNum === 1 ? 'danger' : priorityNum === 2 ? 'warning' : 'success';
        
        modalContent += `
            <div class="card mb-3 border-${priorityColor}">
                <div class="card-header bg-${priorityColor} bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <span class="badge bg-${priorityColor} me-2">${priorityNum}ìˆœìœ„</span>
                            ${rec.subject}
                        </h6>
                        <span class="text-muted">ì ìˆ˜: ${rec.score.toFixed(1)}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ì¶”ì²œ ì´ìœ :</strong>
                            <ul class="mt-2">
                                ${rec.reasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>í†µê³„ ì •ë³´:</strong>
                            <ul class="mt-2">
                                <li>ì¶©ëŒ ê³¼ëª©: ${rec.conflicts}ê°œ</li>
                                <li>ë°°ì¹˜ ê°€ëŠ¥ ìŠ¬ë¡¯: ${rec.availableSlots}ê°œ</li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-outline-${priorityColor} btn-sm mt-2 modal-subject-find-btn" 
                            data-subject="${rec.subject}">
                        <i class="fas fa-search me-1"></i>ê³¼ëª© ì°¾ê¸°
                    </button>
                </div>
            </div>
        `;
    });
    
    modalContent += `
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('recommendationModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€ ë° í‘œì‹œ
    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
    modal.show();
    
    // ëª¨ë‹¬ ë‚´ "ê³¼ëª© ì°¾ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.modal-subject-find-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const subjectName = this.getAttribute('data-subject');
            if (subjectName) {
                highlightRecommendedSubject(subjectName);
                modal.hide();
                console.log('ëª¨ë‹¬ì—ì„œ ê³¼ëª© ì°¾ê¸°:', subjectName);
            }
        });
    });
}

// ì¶”ì²œ ê³¼ëª© í•˜ì´ë¼ì´íŠ¸
function highlightRecommendedSubject(subjectName) {
    console.log('highlightRecommendedSubject í˜¸ì¶œë¨:', subjectName);
    
    // ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ì œê±°
    document.querySelectorAll('.subject-item').forEach(item => {
        item.classList.remove('border-warning', 'bg-warning-subtle');
    });
    
    // í•´ë‹¹ ê³¼ëª© í•˜ì´ë¼ì´íŠ¸ (ì—¬ëŸ¬ ê°€ëŠ¥í•œ ì„ íƒì ì‹œë„)
    let subjectItem = null;
    
    // 1ì°¨ ì‹œë„: ê³¼ëª© ëª©ë¡ì—ì„œ ì •í™•í•œ data-subject ì†ì„±ìœ¼ë¡œ ì°¾ê¸°
    try {
        subjectItem = document.querySelector(`.subject-item[data-subject="${subjectName}"]`);
        console.log('1ì°¨ ì‹œë„ (subject-item + data-subject):', subjectItem);
    } catch (e) {
        console.log('1ì°¨ ì‹œë„ ì‹¤íŒ¨ (CSS ì„ íƒì ì˜¤ë¥˜):', e);
    }
    
    // 2ì°¨ ì‹œë„: ëª¨ë“  ê³¼ëª© ì•„ì´í…œì„ ìˆœíšŒí•˜ë©° data-subject ë¹„êµ
    if (!subjectItem) {
        const allItems = document.querySelectorAll('.subject-item');
        for (let item of allItems) {
            const dataSubject = item.getAttribute('data-subject');
            if (dataSubject === subjectName) {
                subjectItem = item;
                console.log('2ì°¨ ì‹œë„ ì„±ê³µ (data-subject ë¹„êµ):', subjectItem);
                break;
            }
        }
    }
    
    // 3ì°¨ ì‹œë„: í…ìŠ¤íŠ¸ ë‚´ìš©ìœ¼ë¡œ ì°¾ê¸°
    if (!subjectItem) {
        const allItems = document.querySelectorAll('.subject-item');
        for (let item of allItems) {
            const nameElement = item.querySelector('.subject-name');
            if (nameElement && nameElement.textContent.trim() === subjectName.trim()) {
                subjectItem = item;
                console.log('3ì°¨ ì‹œë„ ì„±ê³µ (í…ìŠ¤íŠ¸ ë¹„êµ):', subjectItem);
                break;
            }
        }
    }
    
    // 4ì°¨ ì‹œë„: ë¶€ë¶„ ì¼ì¹˜ë¡œ ì°¾ê¸° (ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ë¬¸ì œ ëŒ€ì‘)
    if (!subjectItem) {
        const allItems = document.querySelectorAll('.subject-item');
        for (let item of allItems) {
            const dataSubject = item.getAttribute('data-subject');
            const nameElement = item.querySelector('.subject-name');
            const nameText = nameElement?.textContent?.trim();
            
            // ê³µë°± ì œê±° í›„ ë¹„êµ
            if ((dataSubject && dataSubject.replace(/\s+/g, '') === subjectName.replace(/\s+/g, '')) ||
                (nameText && nameText.replace(/\s+/g, '') === subjectName.replace(/\s+/g, ''))) {
                subjectItem = item;
                console.log('4ì°¨ ì‹œë„ ì„±ê³µ (ê³µë°± ì œê±° ë¹„êµ):', subjectItem);
                break;
            }
        }
    }
    
    if (subjectItem) {
        // ë°°ì¹˜ëœ ê³¼ëª©ì´ë¼ë„ í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
        subjectItem.classList.add('border-warning', 'bg-warning-subtle');
        subjectItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // ë°°ì¹˜ëœ ê³¼ëª©ì¸ì§€ í™•ì¸
        const isAssigned = subjectItem.classList.contains('opacity-50');
        const message = isAssigned ? 
            `${subjectName} ê³¼ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! (ì´ë¯¸ ë°°ì¹˜ë¨)` : 
            `${subjectName} ê³¼ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!`;
        
        showAlert(message, 'info');
        
        // 3ì´ˆ í›„ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        setTimeout(() => {
            subjectItem.classList.remove('border-warning', 'bg-warning-subtle');
        }, 3000);
    } else {
        console.log('ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', subjectName);
        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ê³¼ëª©ë“¤:', Array.from(document.querySelectorAll('.subject-item')).map(item => {
            return {
                dataSubject: item.getAttribute('data-subject'),
                nameText: item.querySelector('.subject-name')?.textContent?.trim(),
                isAssigned: item.classList.contains('opacity-50')
            };
        }));
        showAlert(`${subjectName} ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'warning');
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics() {
    const totalSubjects = Object.keys(subjectInfo).length;
    const assignedSubjects = Object.values(scheduleData).flat().length;
    const usedSlots = Object.keys(scheduleData).length;
    
    // ë™ì ìœ¼ë¡œ ì´ ìŠ¬ë¡¯ ìˆ˜ ê³„ì‚° (ë¬´ì œí•œ ë‚ ì§œ, ë™ì  êµì‹œ ì§€ì›)
    const examDates = examInfo.ì‹œí—˜ë‚ ì§œ || {};
    const validDatesCount = Object.entries(examDates)
        .filter(([day, date]) => date && date !== 'nan' && date.trim() !== '')
        .length;
    
    // ì‚¬ìš© ê°€ëŠ¥í•œ êµì‹œ ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ê³„ì‚°
    const availablePeriods = new Set();
    const datePeriods = examInfo.date_periods || {};
    Object.values(datePeriods).forEach(dayPeriods => {
        Object.keys(dayPeriods).forEach(periodNum => {
            const periodData = dayPeriods[periodNum];
            if (!periodData._deleted) {
                availablePeriods.add(parseInt(periodNum));
            }
        });
    });
    const periodsCount = availablePeriods.size; // ì™„ì „ ë™ì  ì²˜ë¦¬
    
    const totalSlots = validDatesCount * periodsCount; // ì™„ì „ ë™ì  ì²˜ë¦¬ (í•˜ë“œì½”ë”© ì œê±°)
    
    const progressPercentage = totalSubjects > 0 ? (assignedSubjects / totalSubjects * 100) : 0;
    
    // ìƒë‹¨ ë°” ì—…ë°ì´íŠ¸ëŠ” ë” ì´ìƒ í•˜ì§€ ì•ŠìŒ (UIì—ì„œ ì œê±°ë¨)
    
    // ì¶©ëŒ í‘œì‹œ ì œê±°ë¨
    
    // ì¢Œì¸¡ ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    document.getElementById('sidebarAssignedCount').textContent = assignedSubjects;
    document.getElementById('sidebarTotalCount').textContent = totalSubjects;
}

// í†µí•© ìë™ìƒì„± ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸
document.addEventListener('click', function(e) {
    if (e.target.matches('.dropdown-item[data-time]')) {
        e.preventDefault();
        
        const timeValue = e.target.getAttribute('data-time');
        const timeText = e.target.getAttribute('data-text');
        
        // ë°°ì§€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById('timeBadge').textContent = timeText;
        
        // ì‚¬ìš©ì ì„¤ì • ì…ë ¥ í‘œì‹œ/ìˆ¨ê¹€
        const customInput = document.getElementById('customTimeInput');
        if (timeValue === 'custom') {
            customInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
            // ì„ íƒëœ ì˜µì…˜ì´ ì•„ë‹Œ ê²½ìš° ìë™ìƒì„± ì‹¤í–‰
            if (timeValue !== 'custom') {
                executeAutoGenerate(timeValue);
            }
        }
        
        // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('autoGenerateDropdown'));
        if (dropdown) {
            dropdown.hide();
        }
    }
});

// ìë™ìƒì„± ì‹¤í–‰ í•¨ìˆ˜
function executeAutoGenerate(timeValue) {
    const message = 'ìˆ˜ë™ ë°°ì¹˜ëœ ê³¼ëª©ì„ ìœ ì§€í•˜ê³  ë‚˜ë¨¸ì§€ ê³¼ëª©ë§Œ ìë™ ë°°ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    
    if (confirm(message)) {
        const timeLimit = parseInt(timeValue);
        autoGenerateSchedule(true, timeLimit); // í•­ìƒ ìˆ˜ë™ ë°°ì¹˜ ìœ ì§€
    }
}

// ì‚¬ìš©ì ì„¤ì • ì…ë ¥ ì´ë²¤íŠ¸
document.addEventListener('DOMContentLoaded', function() {
    const customTimeInput = document.getElementById('customTimeValue');
    if (customTimeInput) {
        customTimeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const customValue = parseInt(this.value);
                if (customValue >= 5 && customValue <= 300) {
                    executeAutoGenerate(customValue.toString());
                } else {
                    alert('ì‹œê°„ì€ 5ì´ˆì—ì„œ 300ì´ˆ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                }
            }
        });
    }
});

// ê²€ì¦ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('validateBtn').addEventListener('click', function() {
    const validationResult = validateCompleteSchedule();
    displayDetailedValidationResult(validationResult);
});


// ì‹œê°„ ì œí•œì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
function getTimeLimitText(timeLimit) {
    if (timeLimit <= 10) return 'ë¹ ë¦„';
    if (timeLimit <= 60) return 'ê· í˜•';
    if (timeLimit <= 120) return 'ê³ í’ˆì§ˆ';
    return 'ì‚¬ìš©ì ì„¤ì •';
}

// ìë™ ìƒì„± ì‹¤í–‰
async function autoGenerateSchedule(keepManualAssignments = true, timeLimit = 120) {
    try {
        const timeText = getTimeLimitText(timeLimit);
        showLoading('ìë™ ìƒì„±', `${timeText} ëª¨ë“œë¡œ ìµœì ì˜ ì‹œí—˜ ì‹œê°„í‘œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, true);
        
        // ì„¤ì •
        const config = {
            solve_time_limit: timeLimit,
            keep_manual_assignments: keepManualAssignments
        };
        
        // ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í´ë§ ì‹œì‘
        let statusInterval = setInterval(async () => {
            try {
                const statusResponse = await fetch('/api/schedule-status');
                const statusData = await statusResponse.json();
                
                // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                updateProgress(statusData.progress || 0, statusData.step || 'ì²˜ë¦¬ ì¤‘...');
            } catch (error) {
                console.error('Status polling error:', error);
            }
        }, 1000); // 1ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        
        // ì„œë²„ì— ìš”ì²­ ì „ì†¡
        const response = await fetch('/api/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config: config, time_limit: config.solve_time_limit })
        });
        
        const result = await response.json();
        
        // í´ë§ ì¤‘ì§€
        clearInterval(statusInterval);
        
        if (result.success) {
            // ì„œë²„ ì‘ë‹µì—ì„œ ì§ì ‘ ê²°ê³¼ ì²˜ë¦¬
            await handleScheduleSuccess(result.slot_assignments);
        } else {
            hideLoading();
            showAlert('ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
        }
    } catch (error) {
        console.error('ìë™ ìƒì„± ì˜¤ë¥˜:', error);
        hideLoading();
        showAlert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

// ìŠ¤ì¼€ì¤„ ìƒì„± ì„±ê³µ ì²˜ë¦¬
async function handleScheduleSuccess(slotAssignments) {
    try {
        updateProgress(90, 'ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘...');
        
        // ì„œë²„ ì‘ë‹µì—ì„œ ë°›ì€ ë°ì´í„°ë¥¼ scheduleDataì— ì €ì¥
        scheduleData = slotAssignments;
        
        updateProgress(95, 'ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...');
        
        // ìë™ ìƒì„± ê²°ê³¼ë¥¼ manual_schedule.jsonì— ì €ì¥
        await saveManualSchedule('automatic');
        
        updateProgress(98, 'UI ì—…ë°ì´íŠ¸ ì¤‘...');
        
        // UI ì—…ë°ì´íŠ¸
        renderScheduleGrid();
        renderSubjectList();
        updateStatistics();
        updateRecommendationBanner(); // ë°°ë„ˆ ì¶”ì²œ ì—…ë°ì´íŠ¸
        
        // í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì—…ë°ì´íŠ¸ (ì„¤ì • ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰)
        if (!document.getElementById('burdenPanelBody').classList.contains('collapsed')) {
            renderStudentBurdenAnalysis();
        }
        
        updateProgress(100, 'ì™„ë£Œ!');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        hideLoading();
        showAlert('ì‹œí—˜ ì‹œê°„í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ê³  ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ì„±ê³µ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        hideLoading();
        showAlert('ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

// ì €ì¥ ë²„íŠ¼ ì œê±°ë¨ (ìë™ ì €ì¥ ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´)

// ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('clearAllBtn').addEventListener('click', function() {
    if (confirm('ëª¨ë“  ë°°ì¹˜ëœ ê³¼ëª©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        scheduleData = {};
        
        // ìë™ ì €ì¥ (ë¹ˆ ìŠ¤ì¼€ì¤„ë¡œ)
        saveManualSchedule();
        
        renderScheduleGrid();
        renderSubjectList();
        updateStatistics();
        updateRecommendationBanner(); // ë°°ë„ˆ ì¶”ì²œë„ ì´ˆê¸°í™”
        
        // í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì—…ë°ì´íŠ¸ (ì„¤ì • ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰)
        if (!document.getElementById('burdenPanelBody').classList.contains('collapsed')) {
            renderStudentBurdenAnalysis();
        }
        showAlert('ì‹œê°„í‘œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
});

// ìƒë‹¨ ë°°ë„ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ë“¤
document.getElementById('bannerDetailsBtn').addEventListener('click', function() {
    showRecommendationDetails();
});

// ìë™ìƒì„± ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ì¡°ì •
document.getElementById('autoGenerateDropdown').addEventListener('show.bs.dropdown', function() {
    const button = this;
    const dropdown = button.nextElementSibling;
    const buttonRect = button.getBoundingClientRect();
    
    // ë“œë¡­ë‹¤ìš´ì„ ë²„íŠ¼ ì•„ë˜ìª½ì— ê³ ì • ìœ„ì¹˜ë¡œ ì„¤ì •
    dropdown.style.position = 'fixed';
    dropdown.style.top = (buttonRect.bottom + 5) + 'px';
    dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
    dropdown.style.left = 'auto';
    dropdown.style.zIndex = '9999999';
});

// ë°°ë„ˆ ê³¼ëª© í´ë¦­ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
document.getElementById('bannerRecommendations').addEventListener('click', function(e) {
    console.log('ë°°ë„ˆ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ:', e.target);
    
    const recommendationItem = e.target.closest('.banner-recommendation-item');
    console.log('ì°¾ì€ ì¶”ì²œ ì•„ì´í…œ:', recommendationItem);
    
    if (recommendationItem) {
        const subjectName = recommendationItem.getAttribute('data-subject');
        console.log('í´ë¦­í•œ ê³¼ëª©ëª…:', subjectName);
        
        if (subjectName) {
            // í˜„ì¬ DOMì— ìˆëŠ” ëª¨ë“  ê³¼ëª© ì•„ì´í…œ í™•ì¸
            const allSubjectItems = document.querySelectorAll('.subject-item');
            console.log('DOMì— ìˆëŠ” ê³¼ëª© ì•„ì´í…œ ìˆ˜:', allSubjectItems.length);
            console.log('DOMì— ìˆëŠ” ê³¼ëª©ë“¤:', Array.from(allSubjectItems).map(item => ({
                dataSubject: item.getAttribute('data-subject'),
                subjectName: item.querySelector('.subject-name')?.textContent?.trim()
            })));
            
            highlightRecommendedSubject(subjectName);
        }
    }
});

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function showLoading(title, message, showProgress = false) {
    document.getElementById('loadingTitle').textContent = title;
    document.getElementById('loadingMessage').textContent = message;
    
    // ì§„í–‰ë¥  ë°”ì™€ ë‹¨ê³„ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
    const progressContainer = document.getElementById('progressContainer');
    const stepContainer = document.getElementById('stepContainer');
    
    if (showProgress) {
        progressContainer.style.display = 'block';
        stepContainer.style.display = 'block';
        updateProgress(0, 'ì¤€ë¹„ ì¤‘...');
    } else {
        progressContainer.style.display = 'none';
        stepContainer.style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function updateProgress(percentage, stepMessage) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentStep = document.getElementById('currentStep');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
    }
    
    if (progressText) {
        progressText.textContent = Math.round(percentage) + '%';
    }
    
    if (currentStep && stepMessage) {
        currentStep.textContent = stepMessage;
    }
}

function hideLoading() {
    try {
        console.log('hideLoading í˜¸ì¶œë¨');
        const modalElement = document.getElementById('loadingModal');
        if (!modalElement) {
            console.error('loadingModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            console.log('ê¸°ì¡´ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìˆ¨ê¸°ê¸°');
            modal.hide();
        } else {
            console.log('ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ì–´ì„œ ì§ì ‘ ìˆ¨ê¸°ê¸°');
            modalElement.style.display = 'none';
            // ë°±ë“œë¡­ ì œê±°
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            // body í´ë˜ìŠ¤ ì œê±°
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    } catch (error) {
        console.error('hideLoading ì˜¤ë¥˜:', error);
        // ê°•ì œë¡œ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        const modalElement = document.getElementById('loadingModal');
        if (modalElement) {
            modalElement.style.display = 'none';
        }
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
}

function showAlert(message, type) {
    // ê¸°ì¡´ showAlert í•¨ìˆ˜ ì‚¬ìš© ë˜ëŠ” ê°„ë‹¨í•œ ì•Œë¦¼ êµ¬í˜„
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// ìƒì„¸ ì •ë³´ë¥¼ í¬í•¨í•œ ì•Œë¦¼ í•¨ìˆ˜
function showDetailedAlert(title, message, details, type, modalSize = 'modal-lg') {
    // ëª¨ë‹¬ ìƒì„±
    const modalId = 'detailedAlertModal';
    let existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1" role="dialog">
            <div class="modal-dialog ${modalSize}" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                            ${title}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>${message}</strong>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">ìƒì„¸ ì •ë³´:</h6>
                            </div>
                            <div class="card-body">
                                <div style="font-family: inherit; margin: 0;">${details}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
    
    // ëª¨ë‹¬ì´ ë‹«íŒ í›„ DOMì—ì„œ ì œê±°
    document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ================== ìˆ˜ë™ ë°°ì¹˜ ì €ì¥/ë¡œë“œ ê¸°ëŠ¥ ==================

// ìˆ˜ë™ ë°°ì¹˜ ì‹œê°„í‘œ ì €ì¥
async function saveManualSchedule(createdBy = 'manual') {
    try {
        const response = await fetch('/api/manual-schedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                slot_assignments: scheduleData,
                created_by: createdBy
            })
        });
        
        const result = await response.json();
        if (!result.success) {
            console.error('ë°°ì¹˜ ì €ì¥ ì‹¤íŒ¨:', result.error);
        } else {
            console.log('ë°°ì¹˜ ì €ì¥ ì™„ë£Œ:', createdBy);
        }
    } catch (error) {
        console.error('ë°°ì¹˜ ì €ì¥ ì˜¤ë¥˜:', error);
    }
}

// ìˆ˜ë™ ë°°ì¹˜ ì‹œê°„í‘œ ë¡œë“œ
async function loadManualSchedule() {
    try {
        const response = await fetch('/api/manual-schedule');
        const result = await response.json();
        
        if (result.success && result.data && result.data.slot_assignments) {
            scheduleData = result.data.slot_assignments;
            
            // UI ì—…ë°ì´íŠ¸
            renderScheduleGrid();
            renderSubjectList();
            updateStatistics();
            
            // í•™ìƒ ë¶€ë‹´ ë¶„ì„ ì—…ë°ì´íŠ¸
            if (!document.getElementById('burdenPanelBody').classList.contains('collapsed')) {
                renderStudentBurdenAnalysis();
            }
            
            console.log('ìˆ˜ë™ ë°°ì¹˜ ë¡œë“œ ì™„ë£Œ:', result.data.metadata);
            return true;
        } else {
            console.log('ì €ì¥ëœ ìˆ˜ë™ ë°°ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }
    } catch (error) {
        console.error('ìˆ˜ë™ ë°°ì¹˜ ë¡œë“œ ì˜¤ë¥˜:', error);
        return false;
    }
}

// ìˆ˜ë™ ë°°ì¹˜ ì‹œê°„í‘œ ì‚­ì œ
async function clearManualSchedule() {
    if (!confirm('ì €ì¥ëœ ìˆ˜ë™ ë°°ì¹˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/manual-schedule', {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            scheduleData = {};
            renderScheduleGrid();
            renderSubjectList();
            updateStatistics();
            showAlert('ì €ì¥ëœ ìˆ˜ë™ ë°°ì¹˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
            showAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
    } catch (error) {
        console.error('ìˆ˜ë™ ë°°ì¹˜ ì‚­ì œ ì˜¤ë¥˜:', error);
        showAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
    }
}

</script>
{% endblock %}
