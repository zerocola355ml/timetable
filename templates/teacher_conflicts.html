{% extends "base.html" %}

{% block title %}교사 충돌 정보 편집{% endblock %}

{% block extra_css %}
<style>
    .warning-section {
        display: none;
    }
    
    .main-content {
        display: none;
    }
    
    /* 폼 섹션 스타일 */
    .form-section {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .conflicts-list {
        max-height: 500px;
        overflow-y: auto;
    }
    
    /* 다중 선택 드롭다운 스타일 */
    .multi-select-dropdown {
        position: relative;
    }
    
    .dropdown-input {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        width: 100%;
        cursor: pointer;
        min-height: 38px;
        background-color: white;
    }
    
    .dropdown-input:focus-within {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .dropdown-menu-custom {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        margin-top: 2px;
    }
    
    .dropdown-item-custom {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f8f9fa;
        user-select: none; /* 텍스트 선택 방지 */
    }
    
    .dropdown-item-custom:last-child {
        border-bottom: none;
    }
    
    .dropdown-item-custom:hover:not(.highlighted) {
        background-color: #f8f9fa;
    }
    
    .search-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
        background: transparent;
    }
    
    .selected-teachers-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .teacher-tag {
        background-color: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .teacher-tag .remove-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        margin-left: 0.25rem;
        font-size: 0.75rem;
    }
    
    .teacher-tag .remove-btn:hover {
        color: #ccc;
    }
    
    /* 검색 가능한 단일 선택 드롭다운 스타일 */
    .searchable-select {
        position: relative;
        width: 100%;
    }
    
    .searchable-select .select-input {
        width: 100%;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
        cursor: pointer;
    }
    
    .searchable-select .select-input:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .searchable-select .dropdown-arrow {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: #6c757d;
    }
    
    .searchable-select .dropdown-menu-custom {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .searchable-select .dropdown-item-custom {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .searchable-select .dropdown-item-custom:hover {
        background-color: #f8f9fa;
    }
    
    .searchable-select .dropdown-item-custom:last-child {
        border-bottom: none;
    }
    
    .searchable-select .no-results {
        padding: 0.5rem 0.75rem;
        color: #6c757d;
        font-style: italic;
        text-align: center;
    }
    
    .searchable-select .dropdown-item-custom.highlighted {
        background-color: #0d6efd !important;
        color: white !important;
    }
    
    /* 교사 드롭다운 하이라이트 스타일 */
    .multi-select-dropdown .dropdown-item-custom.highlighted,
    .multi-select-dropdown .dropdown-item-custom.highlighted:hover,
    .dropdown-item-custom.highlighted,
    .dropdown-item-custom.highlighted:hover {
        background-color: #0d6efd !important;
        color: white !important;
        border: 2px solid #0a58ca !important;
    }
    
    /* 하이라이트된 항목의 체크박스와 텍스트 색상 */
    .dropdown-item-custom.highlighted span {
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 경고 메시지 섹션 -->
    <div id="warningSection" class="warning-section">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4 id="warningTitle">경고</h4>
                    <p id="warningMessage" class="mb-3">필요한 파일이 없습니다.</p>
                    <a id="warningAction" href="#" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-2"></i>해당 설정 페이지로 이동
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div id="mainContent" class="main-content">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-chalkboard-teacher text-primary me-2"></i>
                        교사 충돌 편집
                    </h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-danger" onclick="resetTeacherConflicts()">
                <i class="fas fa-undo me-2"></i>원본으로 초기화
            </button>
                        <button class="btn btn-primary" onclick="generateConflicts()" id="generateBtn">
                            <i class="fas fa-magic me-2"></i>자동생성
            </button>
            <a href="{{ url_for('data_review') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>돌아가기
            </a>
        </div>
    </div>
                
                <!-- 교사 충돌 추가 폼 -->
                <div class="form-section">
                    <h5 class="mb-3">
                        <i class="fas fa-plus-circle text-primary me-2"></i>
                        새로운 교사 충돌 추가
                    </h5>
    
    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="subject1SearchableSelect" class="form-label">첫 번째 과목</label>
                            <div class="searchable-select" id="subject1SearchableSelect">
                                <input type="text" class="select-input" id="subject1SearchInput" 
                                       placeholder="과목을 선택하세요" onclick="openSubject1Dropdown()" 
                                       onfocus="openSubject1Dropdown()">
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                <div class="dropdown-menu-custom" id="subject1DropdownMenu">
                                    <div id="subject1DropdownList"></div>
                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="subject2SearchableSelect" class="form-label">두 번째 과목</label>
                            <div class="searchable-select" id="subject2SearchableSelect">
                                <input type="text" class="select-input" id="subject2SearchInput" 
                                       placeholder="과목을 선택하세요" onclick="openSubject2Dropdown()" 
                                       onfocus="openSubject2Dropdown()">
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                <div class="dropdown-menu-custom" id="subject2DropdownMenu">
                                    <div id="subject2DropdownList"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="teacherMultiSelect" class="form-label">공통 담당 교사</label>
                            <div class="multi-select-dropdown" id="teacherMultiSelect">
                                <div class="dropdown-input" onclick="toggleTeacherDropdown()">
                                    <div class="d-flex flex-wrap align-items-center gap-1">
                                        <div id="selectedTeachersContainer" class="selected-teachers-container"></div>
                                        <input type="text" class="search-input" placeholder="교사 검색..." 
                                               oninput="onTeacherSearchInput(this.value)" onclick="event.stopPropagation()" 
                                               onfocus="openTeacherDropdown()" onkeydown="handleTeacherKeyboardNavigation(event)" 
                                               id="teacherSearchInput">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div id="teacherDropdownMenu" class="dropdown-menu-custom">
                                    <div id="teacherDropdownList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
    
    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="addConflict()">
                                <i class="fas fa-plus me-2"></i>
                                충돌 추가
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 기존 충돌 목록 -->
                <div class="form-section">
                    <h5 class="mb-3">
                        <i class="fas fa-list text-info me-2"></i>
                        설정된 교사 충돌 목록
                        <span class="badge bg-secondary ms-2" id="conflictCount">0개</span>
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="subjectFilter" class="form-label">과목 검색:</label>
                            <input type="text" id="subjectFilter" class="form-control" placeholder="과목명을 입력하세요">
                        </div>
                        <div class="col-md-4">
                            <label for="teacherFilter" class="form-label">교사 검색:</label>
                            <input type="text" id="teacherFilter" class="form-control" placeholder="교사명을 입력하세요">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-danger" onclick="removeSelectedConflicts()" id="removeBtn" disabled>
                                <i class="fas fa-trash me-2"></i>선택된 충돌 삭제
                            </button>
                        </div>
                    </div>
                    
                    <div class="conflicts-list">
                        <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="teacherTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>과목 1</th>
                                    <th>과목 2</th>
                                    <th>공통 교사</th>
                                    <th>충돌 유형</th>
                                    <th>설명</th>
                                        <th>삭제</th>
                                </tr>
                            </thead>
                            <tbody id="teacherTableBody">
                                <!-- 데이터가 여기에 로드됩니다 -->
                            </tbody>
                        </table>
        </div>
    </div>
    
                    <div id="noConflictsMessage" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p>설정된 교사 충돌이 없습니다.</p>
                        <p class="small">위의 "자동생성" 버튼을 클릭하여 과목 정보를 바탕으로 교사 충돌을 자동으로 생성하거나,<br>
                        위의 폼에서 수동으로 충돌을 추가해보세요.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let conflictData = [];
let subjects = [];
let selectedSubject1 = '';
let selectedSubject2 = '';
let currentHighlightedIndex1 = -1; // 첫 번째 과목 하이라이트 인덱스
let currentHighlightedIndex2 = -1; // 두 번째 과목 하이라이트 인덱스

// 데이터 로드
async function loadData() {
    try {
        const response = await fetch('/api/teacher-conflicts');
        const data = await response.json();
        
        if (data.success) {
            conflictData = data.conflicts;
            subjects = data.subjects;
            
            // 충돌 수 업데이트
            document.getElementById('conflictCount').textContent = data.conflicts.length + '개';
            
            renderTable();
            updateFilters();
            showMainContent();
            
            // 폼 초기화 (처음 로드 시에만)
            if (!window.formInitialized) {
                await initializeForm();
                window.formInitialized = true;
            }
        } else {
            if (data.error === 'no_exam_scope') {
                showWarning('과목 정보 파일이 없습니다', 
                    '과목 정보를 먼저 설정해주세요.', 
                    '/exam-scope');
            } else {
                showWarning('오류 발생', 
                    data.error || '데이터 로드 중 오류가 발생했습니다.', 
                    '/data-review');
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
        showWarning('오류 발생', 
            '데이터 로드 중 오류가 발생했습니다.', 
            '/data-review');
    }
}

// 자동생성 함수
async function generateConflicts() {
    try {
        // 자동생성 버튼 비활성화
        const generateBtn = document.getElementById('generateBtn');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>생성 중...';
        
        const response = await fetch('/api/generate-teacher-conflicts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            conflictData = data.conflicts;
            subjects = data.subjects;
            
            // 충돌 수 업데이트
            document.getElementById('conflictCount').textContent = data.conflicts.length + '개';
            
            renderTable();
            updateFilters();
            
            // 성공 메시지 표시
            alert(`과목 정보를 바탕으로 ${data.conflicts.length}개의 교사 충돌이 생성되었습니다.`);
        } else {
            alert('자동생성 실패: ' + data.error);
        }
    } catch (error) {
        console.error('Error generating conflicts:', error);
        alert('자동생성 중 오류가 발생했습니다.');
    } finally {
        // 자동생성 버튼 복원
        const generateBtn = document.getElementById('generateBtn');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>자동생성';
    }
}

// 경고 메시지 표시
function showWarning(title, message, actionUrl) {
    document.getElementById('warningTitle').textContent = title;
    document.getElementById('warningMessage').textContent = message;
    document.getElementById('warningAction').href = actionUrl;
    document.getElementById('warningSection').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
}

// 메인 콘텐츠 표시
function showMainContent() {
    document.getElementById('warningSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
}

// 테이블 렌더링
function renderTable() {
    const tbody = document.getElementById('teacherTableBody');
    const noConflictsMessage = document.getElementById('noConflictsMessage');
    const teacherTable = document.getElementById('teacherTable');
    
    tbody.innerHTML = '';
    
    if (conflictData.length === 0) {
        // 테이블 숨기고 빈 상태 메시지 표시
        teacherTable.style.display = 'none';
        noConflictsMessage.style.display = 'block';
        return;
    } else {
        // 테이블 표시하고 빈 상태 메시지 숨기기
        teacherTable.style.display = 'table';
        noConflictsMessage.style.display = 'none';
    }
    
    conflictData.forEach((conflict, index) => {
        const row = document.createElement('tr');
        
        // 체크박스
        const checkboxCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input conflict-checkbox';
        checkbox.onchange = updateRemoveButton;
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);
        
        // 과목 1
        const subject1Cell = document.createElement('td');
        subject1Cell.textContent = conflict.subject1;
        subject1Cell.style.fontWeight = 'bold';
        row.appendChild(subject1Cell);
        
        // 과목 2
        const subject2Cell = document.createElement('td');
        subject2Cell.textContent = conflict.subject2;
        subject2Cell.style.fontWeight = 'bold';
        row.appendChild(subject2Cell);
        
        // 공통 교사
        const teachersCell = document.createElement('td');
        teachersCell.textContent = conflict.common_teachers.join(', ');
        teachersCell.style.fontSize = '0.8rem';
        teachersCell.style.color = '#dc3545';
        row.appendChild(teachersCell);
        
        // 충돌 유형
        const typeCell = document.createElement('td');
        typeCell.textContent = conflict.type;
        typeCell.className = 'text-center';
        typeCell.style.color = '#dc3545';
        row.appendChild(typeCell);
        
        // 설명
        const descCell = document.createElement('td');
        descCell.textContent = conflict.description;
        descCell.style.fontSize = '0.8rem';
        row.appendChild(descCell);
        
        // 작업 버튼
        const actionCell = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-outline-danger';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = () => removeConflict(index);
        actionCell.appendChild(removeBtn);
        row.appendChild(actionCell);
        
        tbody.appendChild(row);
    });
    
    updateRemoveButton();
}

// 필터 업데이트
function updateFilters() {
    const subjectFilter = document.getElementById('subjectFilter');
    const teacherFilter = document.getElementById('teacherFilter');
    
    subjectFilter.addEventListener('input', filterTable);
    teacherFilter.addEventListener('input', filterTable);
}

// 테이블 필터링
function filterTable() {
    const subjectFilter = document.getElementById('subjectFilter').value.toLowerCase();
    const teacherFilter = document.getElementById('teacherFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#teacherTableBody tr');
    
    rows.forEach(row => {
        const subject1 = row.cells[1].textContent.toLowerCase();
        const subject2 = row.cells[2].textContent.toLowerCase();
        const teachers = row.cells[3].textContent.toLowerCase();
        
        const subjectMatch = subject1.includes(subjectFilter) || subject2.includes(subjectFilter);
        const teacherMatch = teachers.includes(teacherFilter);
        
        row.style.display = (subjectMatch && teacherMatch) ? '' : 'none';
    });
}

// 선택된 충돌 제거 버튼 업데이트
function updateRemoveButton() {
    const checkboxes = document.querySelectorAll('.conflict-checkbox:checked');
    const removeBtn = document.getElementById('removeBtn');
    removeBtn.disabled = checkboxes.length === 0;
}

// 개별 충돌 제거
function removeConflict(index) {
    if (confirm('이 교사 충돌을 제거하시겠습니까?')) {
        const conflict = conflictData[index];
        removeConflicts([conflict]);
    }
}

// 선택된 충돌들 제거
async function removeSelectedConflicts() {
    const checkboxes = document.querySelectorAll('.conflict-checkbox:checked');
    const selectedConflicts = [];
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);
        selectedConflicts.push(conflictData[rowIndex]);
    });
    
    if (selectedConflicts.length === 0) {
        alert('제거할 충돌을 선택해주세요.');
        return;
    }
    
    if (confirm(`${selectedConflicts.length}개의 교사 충돌을 제거하시겠습니까?`)) {
        await removeConflicts(selectedConflicts);
    }
}

// 충돌 제거 실행
async function removeConflicts(conflictsToRemove) {
    try {
        const response = await fetch('/api/update-teacher-conflicts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conflicts_to_remove: conflictsToRemove
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            loadData(); // 테이블 새로고침
        } else {
            alert('제거 실패: ' + data.error);
        }
    } catch (error) {
        console.error('Error removing conflicts:', error);
        alert('제거 중 오류가 발생했습니다.');
    }
}

// 페이지 초기화 시 폼 데이터 로드
async function initializeForm() {
    // 과목 목록 로드
    loadSubjectsForForm();
    // 교사 목록 로드
    await loadTeachersForForm();
}

// 폼용 과목 목록 로드
function loadSubjectsForForm() {
    initSubject1Dropdown();
    initSubject2Dropdown();
}

// 첫 번째 과목 드롭다운 초기화
function initSubject1Dropdown() {
    const dropdownList = document.getElementById('subject1DropdownList');
    dropdownList.innerHTML = '';
    
    const availableSubjects = [...new Set(subjects)];
    availableSubjects.forEach(subject => {
        const item = document.createElement('div');
        item.className = 'dropdown-item-custom';
        item.textContent = subject;
        item.addEventListener('click', () => selectSubject1(subject));
        dropdownList.appendChild(item);
    });
}

// 두 번째 과목 드롭다운 초기화
function initSubject2Dropdown() {
    const dropdownList = document.getElementById('subject2DropdownList');
    dropdownList.innerHTML = '';
    
    const availableSubjects = [...new Set(subjects)];
    availableSubjects.forEach(subject => {
        const item = document.createElement('div');
        item.className = 'dropdown-item-custom';
        item.textContent = subject;
        item.addEventListener('click', () => selectSubject2(subject));
        dropdownList.appendChild(item);
    });
}

// 첫 번째 과목 선택
function selectSubject1(subject) {
    selectedSubject1 = subject;
    const searchInput = document.getElementById('subject1SearchInput');
    searchInput.value = subject;
    closeSubject1Dropdown();
}

// 두 번째 과목 선택
function selectSubject2(subject) {
    selectedSubject2 = subject;
    const searchInput = document.getElementById('subject2SearchInput');
    searchInput.value = subject;
    closeSubject2Dropdown();
}

// 첫 번째 과목 드롭다운 토글
function toggleSubject1Dropdown() {
    const menu = document.getElementById('subject1DropdownMenu');
    const isVisible = menu.style.display === 'block';
    
    if (isVisible) {
        closeSubject1Dropdown();
    } else {
        openSubject1Dropdown();
    }
}

// 두 번째 과목 드롭다운 토글
function toggleSubject2Dropdown() {
    const menu = document.getElementById('subject2DropdownMenu');
    const isVisible = menu.style.display === 'block';
    
    if (isVisible) {
        closeSubject2Dropdown();
    } else {
        openSubject2Dropdown();
    }
}

// 첫 번째 과목 드롭다운 열기
function openSubject1Dropdown() {
    const menu = document.getElementById('subject1DropdownMenu');
    const searchInput = document.getElementById('subject1SearchInput');
    
    menu.style.display = 'block';
    searchInput.focus();
    currentHighlightedIndex1 = -1; // 하이라이트 초기화
    
    // 검색 기능 활성화
    searchInput.oninput = function() {
        filterSubjects1(this.value);
        currentHighlightedIndex1 = -1; // 검색 시 하이라이트 초기화
        clearHighlight1();
    };
    
    // 키보드 이벤트 리스너 추가
    searchInput.onkeydown = function(e) {
        handleKeyboardNavigation1(e);
    };
}

// 두 번째 과목 드롭다운 열기
function openSubject2Dropdown() {
    const menu = document.getElementById('subject2DropdownMenu');
    const searchInput = document.getElementById('subject2SearchInput');
    
    menu.style.display = 'block';
    searchInput.focus();
    currentHighlightedIndex2 = -1; // 하이라이트 초기화
    
    // 검색 기능 활성화
    searchInput.oninput = function() {
        filterSubjects2(this.value);
        currentHighlightedIndex2 = -1; // 검색 시 하이라이트 초기화
        clearHighlight2();
    };
    
    // 키보드 이벤트 리스너 추가
    searchInput.onkeydown = function(e) {
        handleKeyboardNavigation2(e);
    };
}

// 첫 번째 과목 드롭다운 닫기
function closeSubject1Dropdown() {
    const menu = document.getElementById('subject1DropdownMenu');
    const searchInput = document.getElementById('subject1SearchInput');
    
    menu.style.display = 'none';
    searchInput.oninput = null;
    searchInput.onkeydown = null;
    currentHighlightedIndex1 = -1;
}

// 두 번째 과목 드롭다운 닫기
function closeSubject2Dropdown() {
    const menu = document.getElementById('subject2DropdownMenu');
    const searchInput = document.getElementById('subject2SearchInput');
    
    menu.style.display = 'none';
    searchInput.oninput = null;
    searchInput.onkeydown = null;
    currentHighlightedIndex2 = -1;
}

// 첫 번째 과목 필터링
function filterSubjects1(searchTerm) {
    const dropdownList = document.getElementById('subject1DropdownList');
    const availableSubjects = [...new Set(subjects)];
    const filteredSubjects = availableSubjects.filter(subject => 
        subject.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    dropdownList.innerHTML = '';
    
    if (filteredSubjects.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = '검색 결과가 없습니다';
        dropdownList.appendChild(noResults);
    } else {
        filteredSubjects.forEach(subject => {
            const item = document.createElement('div');
            item.className = 'dropdown-item-custom';
            item.textContent = subject;
            item.addEventListener('click', () => selectSubject1(subject));
            dropdownList.appendChild(item);
        });
    }
}

// 두 번째 과목 필터링
function filterSubjects2(searchTerm) {
    const dropdownList = document.getElementById('subject2DropdownList');
    const availableSubjects = [...new Set(subjects)];
    const filteredSubjects = availableSubjects.filter(subject => 
        subject.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    dropdownList.innerHTML = '';
    
    if (filteredSubjects.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = '검색 결과가 없습니다';
        dropdownList.appendChild(noResults);
    } else {
        filteredSubjects.forEach(subject => {
            const item = document.createElement('div');
            item.className = 'dropdown-item-custom';
            item.textContent = subject;
            item.addEventListener('click', () => selectSubject2(subject));
            dropdownList.appendChild(item);
        });
    }
}

// 첫 번째 과목 키보드 네비게이션 처리
function handleKeyboardNavigation1(e) {
    const items = document.querySelectorAll('#subject1DropdownList .dropdown-item-custom:not(.no-results)');
    
    if (items.length === 0) return;
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            currentHighlightedIndex1 = Math.min(currentHighlightedIndex1 + 1, items.length - 1);
            updateHighlight1(items);
            break;
        case 'ArrowUp':
            e.preventDefault();
            currentHighlightedIndex1 = Math.max(currentHighlightedIndex1 - 1, 0);
            updateHighlight1(items);
            break;
        case 'Enter':
            e.preventDefault();
            if (currentHighlightedIndex1 >= 0 && currentHighlightedIndex1 < items.length) {
                const selectedText = items[currentHighlightedIndex1].textContent;
                selectSubject1(selectedText);
            }
            break;
        case 'Escape':
            e.preventDefault();
            closeSubject1Dropdown();
            break;
    }
}

// 두 번째 과목 키보드 네비게이션 처리
function handleKeyboardNavigation2(e) {
    const items = document.querySelectorAll('#subject2DropdownList .dropdown-item-custom:not(.no-results)');
    
    if (items.length === 0) return;
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            currentHighlightedIndex2 = Math.min(currentHighlightedIndex2 + 1, items.length - 1);
            updateHighlight2(items);
            break;
        case 'ArrowUp':
            e.preventDefault();
            currentHighlightedIndex2 = Math.max(currentHighlightedIndex2 - 1, 0);
            updateHighlight2(items);
            break;
        case 'Enter':
            e.preventDefault();
            if (currentHighlightedIndex2 >= 0 && currentHighlightedIndex2 < items.length) {
                const selectedText = items[currentHighlightedIndex2].textContent;
                selectSubject2(selectedText);
            }
            break;
        case 'Escape':
            e.preventDefault();
            closeSubject2Dropdown();
            break;
    }
}

// 첫 번째 과목 하이라이트 업데이트
function updateHighlight1(items) {
    clearHighlight1();
    if (currentHighlightedIndex1 >= 0 && currentHighlightedIndex1 < items.length) {
        items[currentHighlightedIndex1].classList.add('highlighted');
        items[currentHighlightedIndex1].scrollIntoView({ block: 'nearest' });
    }
}

// 두 번째 과목 하이라이트 업데이트
function updateHighlight2(items) {
    clearHighlight2();
    if (currentHighlightedIndex2 >= 0 && currentHighlightedIndex2 < items.length) {
        items[currentHighlightedIndex2].classList.add('highlighted');
        items[currentHighlightedIndex2].scrollIntoView({ block: 'nearest' });
    }
}

// 첫 번째 과목 하이라이트 제거
function clearHighlight1() {
    const items = document.querySelectorAll('#subject1DropdownList .dropdown-item-custom');
    items.forEach(item => item.classList.remove('highlighted'));
}

// 두 번째 과목 하이라이트 제거
function clearHighlight2() {
    const items = document.querySelectorAll('#subject2DropdownList .dropdown-item-custom');
    items.forEach(item => item.classList.remove('highlighted'));
}

// 교사 목록 변수
let availableTeachers = [];
let selectedTeachers = new Set();
let currentHighlightedTeacherIndex = -1; // 교사 드롭다운 하이라이트 인덱스

// 폼용 교사 목록 로드
async function loadTeachersForForm() {
    try {
        const response = await fetch('/api/teachers-list');
        const data = await response.json();
        
        if (data.success) {
            availableTeachers = data.teachers;
            selectedTeachers.clear();
            initTeacherDropdown();
            updateSelectedTeachersDisplay();
        } else {
            console.error('교사 목록 로드 실패:', data.error);
            alert('교사 목록을 불러오는데 실패했습니다: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading teachers:', error);
        alert('교사 목록을 불러오는 중 오류가 발생했습니다.');
    }
}

// 교사 드롭다운 초기화
function initTeacherDropdown() {
    const dropdownList = document.getElementById('teacherDropdownList');
    dropdownList.innerHTML = '';
    
    availableTeachers.forEach(teacher => {
        const item = document.createElement('div');
        item.className = 'dropdown-item-custom';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.checked = selectedTeachers.has(teacher);
        checkbox.addEventListener('change', (e) => {
            e.stopPropagation();
            toggleTeacherSelection(teacher);
        });
        
        const span = document.createElement('span');
        span.textContent = teacher;
        
        // 행 클릭 시 체크박스 토글
        item.addEventListener('click', (e) => {
            if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                toggleTeacherSelection(teacher);
            }
        });
        
        item.appendChild(checkbox);
        item.appendChild(span);
        dropdownList.appendChild(item);
    });
}

// 교사 드롭다운 토글
function toggleTeacherDropdown() {
    const menu = document.getElementById('teacherDropdownMenu');
    const isVisible = menu.style.display === 'block';
    
    if (isVisible) {
        closeTeacherDropdown();
    } else {
        openTeacherDropdown();
    }
}

// 교사 드롭다운 열기
function openTeacherDropdown() {
    const menu = document.getElementById('teacherDropdownMenu');
    const searchInput = document.getElementById('teacherSearchInput');
    
    menu.style.display = 'block';
    searchInput.focus();
    currentHighlightedTeacherIndex = -1; // 하이라이트 초기화
    clearTeacherHighlight(); // 하이라이트 제거
}

// 교사 검색 입력 처리
function onTeacherSearchInput(searchTerm) {
    // 입력이 있으면 자동으로 드롭다운 열기
    if (searchTerm.length > 0) {
        openTeacherDropdown();
    }
    // 검색 필터링 실행 (하이라이트는 filterTeachersInModal에서 자동 처리)
    filterTeachersInModal(searchTerm);
}

// 교사 선택/해제
function toggleTeacherSelection(teacher) {
    if (selectedTeachers.has(teacher)) {
        selectedTeachers.delete(teacher);
    } else {
        selectedTeachers.add(teacher);
    }
    
    // 교사를 선택하거나 해제할 때마다 검색창 비우기
    const searchInput = document.getElementById('teacherSearchInput');
    if (searchInput && searchInput.value.trim() !== '') {
        searchInput.value = '';
        // 검색 필터도 초기화하여 모든 교사 표시
        filterTeachersInModal('');
        // 검색창에 포커스 유지
        searchInput.focus();
    }
    
    updateSelectedTeachersDisplay();
    // 체크박스 상태도 업데이트
    updateCheckboxState(teacher);
}

// 체크박스 상태 업데이트
function updateCheckboxState(teacher) {
    const items = document.querySelectorAll('#teacherDropdownList .dropdown-item-custom');
    items.forEach(item => {
        const span = item.querySelector('span');
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (span && span.textContent === teacher && checkbox) {
            checkbox.checked = selectedTeachers.has(teacher);
        }
    });
}

// 선택된 교사 표시 업데이트
function updateSelectedTeachersDisplay() {
    const container = document.getElementById('selectedTeachersContainer');
    container.innerHTML = '';
    
    selectedTeachers.forEach(teacher => {
        const tag = document.createElement('span');
        tag.className = 'teacher-tag';
        tag.innerHTML = `
            ${teacher}
            <button class="remove-btn" onclick="removeTeacherSelection('${teacher}')" type="button">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(tag);
    });
}

// 교사 선택 제거
function removeTeacherSelection(teacher) {
    selectedTeachers.delete(teacher);
    updateSelectedTeachersDisplay();
    initTeacherDropdown(); // 체크박스 상태 업데이트
}

// 교사 검색 필터링
function filterTeachersInModal(searchTerm) {
    const items = document.querySelectorAll('#teacherDropdownList .dropdown-item-custom');
    let visibleCount = 0;
    
    items.forEach(item => {
        const span = item.querySelector('span').textContent;
        const isVisible = span.toLowerCase().includes(searchTerm.toLowerCase());
        item.style.display = isVisible ? 'flex' : 'none';
        if (isVisible) visibleCount++;
    });
    
    // 필터링 후 첫 번째 보이는 항목을 하이라이트
    if (visibleCount > 0) {
        currentHighlightedTeacherIndex = 0;
        const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
        updateTeacherHighlight(visibleItems);
    } else {
        currentHighlightedTeacherIndex = -1;
        clearTeacherHighlight();
    }
}

 // 충돌 추가
 async function addConflict() {
     const subject1 = selectedSubject1;
     const subject2 = selectedSubject2;
     
     if (!subject1 || !subject2) {
         alert('두 과목을 모두 선택해주세요.');
         return;
     }
     
     if (subject1 === subject2) {
         alert('서로 다른 과목을 선택해주세요.');
         return;
     }
     
    if (selectedTeachers.size === 0) {
        alert('공통 담당 교사를 최소 1명 이상 선택해주세요.');
        return;
    }
    
    const commonTeachers = Array.from(selectedTeachers);
     
     try {
         const response = await fetch('/api/add-teacher-conflict', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify({
                 subject1: subject1,
                 subject2: subject2,
                 common_teachers: commonTeachers
             })
         });
         
         const data = await response.json();
         
         if (data.success) {
             alert(data.message);
            // 폼 초기화
            selectedSubject1 = '';
            selectedSubject2 = '';
            document.getElementById('subject1SearchInput').value = '';
            document.getElementById('subject2SearchInput').value = '';
            selectedTeachers.clear();
            updateSelectedTeachersDisplay();
            document.getElementById('teacherSearchInput').value = '';
             // 테이블 새로고침
             loadData();
         } else {
             alert('추가 실패: ' + data.error);
         }
     } catch (error) {
         console.error('Error adding conflict:', error);
         alert('충돌 추가 중 오류가 발생했습니다.');
     }
 }

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 초기 상태 설정
    document.getElementById('warningSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'none';
    
    // 데이터 로드
    loadData();
    
    // 외부 클릭 시 드롭다운 닫기
    document.addEventListener('click', function(e) {
        const subject1Select = document.getElementById('subject1SearchableSelect');
        const subject2Select = document.getElementById('subject2SearchableSelect');
        const teacherSelect = document.getElementById('teacherMultiSelect');
        
        if (subject1Select && !subject1Select.contains(e.target)) {
            closeSubject1Dropdown();
        }
        if (subject2Select && !subject2Select.contains(e.target)) {
            closeSubject2Dropdown();
        }
        if (teacherSelect && !teacherSelect.contains(e.target)) {
            closeTeacherDropdown();
        }
    });
});

// 교사 충돌 초기화 함수
async function resetTeacherConflicts() {
    if (confirm('모든 교사 충돌을 제거하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        try {
            const response = await fetch('/api/reset-teacher-conflicts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const data = await response.json();

            if (data.success) {
                alert('교사 충돌이 원본 엑셀 파일로 초기화되었습니다.');
                loadData(); // 테이블 새로고침
            } else {
                alert('교사 충돌 초기화에 실패했습니다: ' + data.error);
            }
        } catch (error) {
            console.error('Error resetting teacher conflicts:', error);
            alert('교사 충돌 초기화 중 오류가 발생했습니다.');
        }
    }
}

// 전체 선택/해제
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.conflict-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateRemoveButton();
});

// 교사 키보드 네비게이션 처리
function handleTeacherKeyboardNavigation(e) {
    // 필터링된(보이는) 항목들만 선택
    const allItems = document.querySelectorAll('#teacherDropdownList .dropdown-item-custom:not(.no-results)');
    const visibleItems = Array.from(allItems).filter(item => item.style.display !== 'none');
    
    debugInfo('Key pressed:', e.key, 'Visible items found:', visibleItems.length); // 디버깅용
    
    if (visibleItems.length === 0) return;
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            currentHighlightedTeacherIndex = Math.min(currentHighlightedTeacherIndex + 1, visibleItems.length - 1);
            debugInfo('ArrowDown - Index:', currentHighlightedTeacherIndex); // 디버깅용
            updateTeacherHighlight(visibleItems);
            break;
        case 'ArrowUp':
            e.preventDefault();
            currentHighlightedTeacherIndex = Math.max(currentHighlightedTeacherIndex - 1, 0);
            debugInfo('ArrowUp - Index:', currentHighlightedTeacherIndex); // 디버깅용
            updateTeacherHighlight(visibleItems);
            break;
        case 'Enter':
            e.preventDefault();
            if (currentHighlightedTeacherIndex >= 0 && currentHighlightedTeacherIndex < visibleItems.length) {
                const selectedItem = visibleItems[currentHighlightedTeacherIndex];
                const teacherName = selectedItem.querySelector('span').textContent;
                debugInfo('Enter - Selected teacher:', teacherName); // 디버깅용
                toggleTeacherSelection(teacherName);
                updateCheckboxState(teacherName);
                // 선택 후 포커스 유지하고 검색창 클리어
                const searchInput = document.getElementById('teacherSearchInput');
                searchInput.value = '';
                filterTeachersInModal('');
                searchInput.focus();
                // 하이라이트 초기화
                currentHighlightedTeacherIndex = -1;
                clearTeacherHighlight();
            }
            break;
        case 'Escape':
            e.preventDefault();
            closeTeacherDropdown();
            break;
        case 'Tab':
            // Tab 키로 드롭다운에서 나가기 (선택 완료)
            closeTeacherDropdown();
            break;
    }
}

// 교사 하이라이트 업데이트
function updateTeacherHighlight(items) {
    clearTeacherHighlight();
    if (currentHighlightedTeacherIndex >= 0 && currentHighlightedTeacherIndex < items.length) {
        const item = items[currentHighlightedTeacherIndex];
        item.classList.add('highlighted');
        debugInfo('Highlighted item:', item, 'Classes:', item.className); // 디버깅용
        item.scrollIntoView({ block: 'nearest' });
    }
}

// 교사 하이라이트 제거
function clearTeacherHighlight() {
    const items = document.querySelectorAll('#teacherDropdownList .dropdown-item-custom');
    items.forEach(item => item.classList.remove('highlighted'));
}

// 교사 드롭다운 닫기
function closeTeacherDropdown() {
    const menu = document.getElementById('teacherDropdownMenu');
    const searchInput = document.getElementById('teacherSearchInput');
    
    menu.style.display = 'none';
    currentHighlightedTeacherIndex = -1;
    clearTeacherHighlight();
    
    // 키보드 이벤트 리스너는 유지 (한 번만 등록하고 재사용)
}

// 외부 클릭 시 드롭다운 닫기
document.addEventListener('click', function(e) {
    if (!e.target.closest('.multi-select-dropdown')) {
        closeTeacherDropdown();
    }
    
    // 과목 드롭다운도 닫기
    if (!e.target.closest('#subject1SearchableSelect')) {
        closeSubject1Dropdown();
    }
    if (!e.target.closest('#subject2SearchableSelect')) {
        closeSubject2Dropdown();
    }
});
</script>

<style>
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

#teacherTable th {
    font-size: 0.8rem;
    white-space: nowrap;
    color: #ffffff !important;
    font-weight: bold !important;
    text-align: center;
    background-color: #343a40 !important;
    border-color: #495057 !important;
}

#teacherTable td {
    font-size: 0.8rem;
    vertical-align: middle;
    padding: 0.5rem 0.25rem;
}

.form-check-input {
    margin: 0;
}
</style>
{% endblock %} 