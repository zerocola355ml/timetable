{% extends "base.html" %}

{% block title %}과목 충돌 정보 편집{% endblock %}

{% block extra_css %}
<style>
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .editable-cell {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .editable-cell:hover {
        background-color: #e9ecef;
    }
    .editing {
        background-color: #fff3cd !important;
    }
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    
    /* 드래그 앤 드롭 영역 스타일 */
    .upload-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 20px;
    }
    
    .upload-drop-zone:hover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .upload-drop-zone.dragover {
        border-color: #28a745;
        background-color: #d4edda;
        transform: scale(1.02);
    }
    
    .upload-drop-content {
        pointer-events: none;
    }
    
    .upload-drop-zone:hover .upload-drop-content {
        pointer-events: auto;
    }
    
    .upload-drop-zone.dragover .upload-drop-content {
        pointer-events: auto;
    }
    
    .upload-drop-zone .btn {
        pointer-events: auto;
    }
    
    /* 테이블 스타일 개선 */
    #conflictTable th {
        font-size: 0.9rem;
        white-space: nowrap;
        color: #495057 !important;
        font-weight: 600 !important;
        text-align: center;
        background-color: #f8f9fa !important;
        border-color: #dee2e6 !important;
        padding: 0.75rem 0.5rem;
    }
    
    #conflictTable td {
        font-size: 0.9rem;
        vertical-align: middle;
        padding: 0.5rem 0.5rem;
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1020;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3><i class="fas fa-users me-2"></i>학생 배정 정보 업로드</h3>
                <div>
                    <button class="btn btn-danger me-2" onclick="completeResetStudentConflicts()">
                        <i class="fas fa-undo me-2"></i>파일 제거
                    </button>
                    <a href="{{ url_for('conflict_selection') }}" class="btn btn-outline-info me-2">
                        <i class="fas fa-list me-2"></i>유형 선택으로
                    </a>
                    <a href="{{ url_for('data_review') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>돌아가기
                    </a>
                </div>
            </div>
            <hr>
        </div>
    </div>
    
    <p class="text-muted">수강 학생이 겹치는 과목은 서로 충돌합니다. 충돌하는 과목은 같은 시간에 배정되지 않습니다.</p>
    
    <!-- 과목 정보 파일 업로드 필요 메시지 -->
    {% if show_upload_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                    <div>
                        <h5 class="alert-heading mb-2">과목 정보 파일이 필요합니다!</h5>
                        <p class="mb-2">먼저 다음 파일을 업로드해야 합니다.</p>
                        <ul class="mb-2">
                            <li><strong>과목 정보.xlsx</strong></li>
                        </ul>
                        <a href="{{ url_for('exam_scope') }}" class="btn btn-warning">
                            <i class="fas fa-upload me-2"></i>과목 정보 업로드로 이동
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 숨겨진 input으로 show_upload_message 값 전달 -->
    <input type="hidden" id="showUploadMessage" value="{% if show_upload_message %}true{% else %}false{% endif %}">
    
    <!-- 파일 업로드 섹션 -->
    <div class="row mb-4" id="uploadSection">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>학생배정정보 파일 업로드
                    </h5>
                    <p class="mb-0">엑셀 파일로 학생 수강 과목 정보를 업로드하면 충돌 정보가 자동 생성됩니다.</p>
                </div>
                <div class="card-body">
                    <!-- 드래그 앤 드롭 영역 -->
                    <div class="upload-drop-zone" id="uploadDropZone">
                        <div class="upload-drop-content">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>파일을 여기에 드래그하거나 클릭하여 선택하세요</h5>
                            <p class="text-muted">지원 형식: .xlsx, .xls (최대 10MB)</p>
                            <button class="btn btn-outline-primary" onclick="document.getElementById('enrollmentFile').click()">
                                <i class="fas fa-folder-open me-2"></i>파일 선택
                            </button>
                        </div>
                    </div>
                    
                    <!-- 숨겨진 파일 입력 -->
                    <input type="file" id="enrollmentFile" class="form-control d-none" accept=".xlsx,.xls" onchange="handleFileSelect(this)">
                    
                    <!-- 양식 다운로드 버튼 -->
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button class="btn btn-outline-secondary" onclick="downloadEnrollmentTemplate()">
                                <i class="fas fa-download me-2"></i>양식 다운로드
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div id="uploadStatus" class="alert" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 충돌 정보 편집 테이블 -->
    <div class="row" id="dataTable">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>학생 충돌 정보
                    </h5>
                    <p class="mb-0">수정이 필요하면 파일 제거 후 새로 업로드 하세요.</p>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="subjectFilter" class="form-label">과목 검색:</label>
                            <input type="text" id="subjectFilter" class="form-control" placeholder="과목명을 입력하세요">
                        </div>
                        <div class="col-md-6">
                            <label for="studentCountFilter" class="form-label">공통 학생 수 필터:</label>
                            <select id="studentCountFilter" class="form-control">
                                <option value="">전체</option>
                                <option value="1">1명</option>
                                <option value="2">2명</option>
                                <option value="3">3명</option>
                                <option value="5">5명 이상</option>
                                <option value="10">10명 이상</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover" id="conflictTable">
                            <thead class="sticky-top">
                                <tr>
                                    <th>과목 1</th>
                                    <th>과목 2</th>
                                    <th>공통 학생 수</th>
                                    <th>공통 학생 목록</th>
                                </tr>
                            </thead>
                            <tbody id="conflictTableBody">
                                <!-- 데이터가 여기에 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <!-- 버튼들이 제거되었습니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 알림 모달 -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalTitle">알림</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    <!-- 메시지가 여기에 표시됩니다 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let conflictData = [];
let subjects = [];
let showUploadMessage = false; // 기본값

// 페이지 로드 시 showUploadMessage 값 설정 및 초기 상태 설정
document.addEventListener('DOMContentLoaded', function() {
    const hiddenInput = document.getElementById('showUploadMessage');
    if (hiddenInput) {
        showUploadMessage = hiddenInput.value === 'true';
    }
    
    // 과목 정보 파일이 없으면 업로드 섹션만 표시
    if (showUploadMessage) {
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('dataTable').style.display = 'none';
    } else {
        // 과목 정보 파일이 있으면 데이터 로드 시도
        loadData();
    }
});

// 데이터 로드
async function loadData() {
    // 과목 정보 파일이 없으면 데이터 로드 시도하지 않음
    if (showUploadMessage) {
        console.log('과목 정보 파일이 없어 데이터 로드를 건너뜁니다.');
        return;
    }
    
    try {
        const response = await fetch('/api/conflict-data');
        const data = await response.json();
        
        if (data.success) {
            conflictData = data.conflicts;
            subjects = data.subjects;
            
            renderTable();
            updateFilters();
            
            // 데이터가 있으면 테이블 표시, 업로드 섹션 숨김
            if (conflictData && conflictData.length > 0) {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('dataTable').style.display = 'block';
            } else {
                // 데이터가 없으면 업로드 섹션 표시, 테이블 숨김
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('dataTable').style.display = 'none';
            }
        } else {
            console.error('API response error:', data);
            if (data.error === 'no_file') {
                // 파일이 없을 때는 업로드 섹션 표시
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('dataTable').style.display = 'none';
                document.getElementById('conflictTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <h5>${data.message || '업로드된 파일이 없습니다.'}</h5>
                                <p class="mb-0">위의 파일 업로드 섹션에서 분반배정표 파일을 업로드해주세요.</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                showModalAlert('오류', `데이터 로드 실패: ${data.error || '알 수 없는 오류'}`, 'error');
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            response: error.response
        });
        showModalAlert('오류', `데이터 로드 중 오류가 발생했습니다: ${error.message}`, 'error');
    }
}

// 테이블 렌더링
function renderTable() {
    const tbody = document.getElementById('conflictTableBody');
    tbody.innerHTML = '';
    
    conflictData.forEach((conflict, index) => {
        const row = document.createElement('tr');
        
        // 과목 1
        const subject1Cell = document.createElement('td');
        subject1Cell.textContent = conflict.subject1;
        subject1Cell.style.fontWeight = 'bold';
        row.appendChild(subject1Cell);
        
        // 과목 2
        const subject2Cell = document.createElement('td');
        subject2Cell.textContent = conflict.subject2;
        subject2Cell.style.fontWeight = 'bold';
        row.appendChild(subject2Cell);
        
        // 공통 학생 수
        const countCell = document.createElement('td');
        countCell.textContent = conflict.student_count;
        countCell.className = 'text-center';
        if (conflict.student_count >= 10) {
            countCell.className += ' text-danger';
        } else if (conflict.student_count >= 5) {
            countCell.className += ' text-warning';
        }
        row.appendChild(countCell);
        
                 // 공통 학생 목록
         const studentsCell = document.createElement('td');
         studentsCell.style.maxWidth = '200px';
         studentsCell.style.fontSize = '0.8rem';
         studentsCell.style.whiteSpace = 'nowrap';
         studentsCell.style.overflow = 'hidden';
         studentsCell.style.textOverflow = 'ellipsis';
         
         const studentsText = conflict.shared_students.join(', ');
         studentsCell.textContent = studentsText;
         studentsCell.title = studentsText;
         
         // 복사 버튼 추가 (왼쪽에 배치)
         const copyBtn = document.createElement('button');
         copyBtn.className = 'btn btn-sm btn-outline-secondary me-2';
         copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
         copyBtn.title = '학생 목록 복사';
         copyBtn.onclick = (event) => copyToClipboard(studentsText, event);
         
         studentsCell.insertBefore(copyBtn, studentsCell.firstChild);
         row.appendChild(studentsCell);
        
        tbody.appendChild(row);
    });
}

// 필터 업데이트
function updateFilters() {
    const subjectFilter = document.getElementById('subjectFilter');
    const studentCountFilter = document.getElementById('studentCountFilter');
    
    subjectFilter.addEventListener('input', filterTable);
    studentCountFilter.addEventListener('change', filterTable);
}

// 테이블 필터링
function filterTable() {
    const subjectFilter = document.getElementById('subjectFilter').value.toLowerCase();
    const studentCountFilter = document.getElementById('studentCountFilter').value;
    
    const rows = document.querySelectorAll('#conflictTableBody tr');
    
    rows.forEach(row => {
        const subject1 = row.cells[0].textContent.toLowerCase();
        const subject2 = row.cells[1].textContent.toLowerCase();
        const studentCount = parseInt(row.cells[2].textContent);
        
        const subjectMatch = subject1.includes(subjectFilter) || subject2.includes(subjectFilter);
        const countMatch = studentCountFilter === '' || 
                          (studentCountFilter === '5' && studentCount >= 5) ||
                          (studentCountFilter === '10' && studentCount >= 10) ||
                          studentCount === parseInt(studentCountFilter);
        
        row.style.display = (subjectMatch && countMatch) ? '' : 'none';
    });
}

// 클립보드 복사 함수
function copyToClipboard(text, event) {
     navigator.clipboard.writeText(text).then(() => {
         // 복사 성공 알림
         const originalText = event.target.innerHTML;
         event.target.innerHTML = '<i class="fas fa-check"></i>';
         event.target.className = 'btn btn-sm btn-success me-2';
         
         setTimeout(() => {
             event.target.innerHTML = originalText;
             event.target.className = 'btn btn-sm btn-outline-secondary me-2';
         }, 1000);
     }).catch(err => {
         console.error('복사 실패:', err);
         showModalAlert('오류', '복사에 실패했습니다.', 'error');
     });
 }

 

 // 파일 업로드 관련 함수들
async function uploadEnrollmentFile() {
    const fileInput = document.getElementById('enrollmentFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showModalAlert('오류', '업로드할 파일을 선택해주세요.', 'error');
        return;
    }
    
    // 파일 검증
    if (!validateFile(file)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.style.display = 'block';
    statusDiv.className = 'alert alert-info';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>파일을 업로드하고 있습니다...';
    
    try {
        const response = await fetch('/api/upload-enrollment-file', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `<i class="fas fa-check me-2"></i>${data.message}`;
            
            // 성공 후 파일 입력 초기화
            fileInput.value = '';
            
            // 3초 후 상태 메시지 숨기기
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
            
            // 충돌 데이터 새로고침
            loadData();
            
            // 업로드 섹션 숨기고 테이블 표시
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dataTable').style.display = 'block';
        } else {
                               // 과목 검증 경고가 있는 경우 특별 처리
                   if (data.warning) {
                       statusDiv.className = 'alert alert-warning alert-dismissible';
                       statusDiv.innerHTML = `
                           <div class="d-flex align-items-start">
                               <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                               <div class="flex-grow-1">
                                   <strong>과목 검증 경고:</strong><br>
                                   ${data.warning.replace(/\\n/g, '<br>')}
                               </div>
                               <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                           </div>
                       `;
                       
                       // 경고 메시지는 사용자가 직접 닫을 때까지 표시 (자동 숨김 없음)
                   } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${data.error}`;
            }
        }
    } catch (error) {
        console.error('Error uploading file:', error);
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>파일 업로드 중 오류가 발생했습니다.`;
    }
}

async function downloadEnrollmentTemplate() {
    try {
        const response = await fetch('/api/download-enrollment-template');
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '학생배정정보.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            showModalAlert('오류', '양식 다운로드에 실패했습니다.', 'error');
        }
    } catch (error) {
        console.error('Error downloading template:', error);
        showModalAlert('오류', '양식 다운로드 중 오류가 발생했습니다.', 'error');
    }
}

// 파일 검증 함수
function validateFile(file) {
    const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel' // .xls
    ];
    
    const maxSize = 10 * 1024 * 1024; // 10MB
    
    if (!allowedTypes.includes(file.type)) {
        showModalAlert('오류', 'Excel 파일(.xlsx, .xls)만 업로드 가능합니다.', 'error');
        return false;
    }
    
    if (file.size > maxSize) {
        showModalAlert('오류', '파일 크기는 10MB 이하여야 합니다.', 'error');
        return false;
    }
    
    return true;
}

// 파일 선택 시 자동 업로드
function handleFileSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // 파일 크기 및 형식 검증
        if (!validateFile(file)) {
            return;
        }
        
        // 자동으로 업로드 실행
        uploadEnrollmentFile();
    }
}

// 모달 알림 표시 함수
function showModalAlert(title, message, type) {
    const modal = new bootstrap.Modal(document.getElementById('alertModal'));
    document.getElementById('alertModalTitle').textContent = title;
    document.getElementById('alertModalBody').textContent = message;
    
    const modalContent = document.querySelector('#alertModal .modal-content');
    modalContent.className = 'modal-content';
    
    if (type === 'error') {
        modalContent.classList.add('border-danger');
    } else if (type === 'success') {
        modalContent.classList.add('border-success');
    }
    
    modal.show();
}

// 완전 초기화 (모든 데이터 삭제)
async function completeResetStudentConflicts() {
    if (!confirm('업로드한 파일과 표 내용을 모두 지우고 빈 화면으로 돌아갑니다. 이 작업은 되돌릴 수 없습니다.')) {
        return;
    }

    try {
        const response = await fetch('/api/complete-reset-student-conflicts', {
            method: 'POST'
        });

        const data = await response.json();
        
        if (data.success) {
            showModalAlert('성공', data.message, 'success');
            // 업로드 섹션 표시하고 테이블 숨김
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';
            // 테이블 내용 초기화
            document.getElementById('conflictTableBody').innerHTML = '';
        } else {
            showModalAlert('오류', data.error, 'error');
        }
    } catch (error) {
        showModalAlert('오류', '완전 초기화 중 오류가 발생했습니다.', 'error');
        console.error('Error completing full reset:', error);
    }
}

// 기존 페이지 로드 이벤트 리스너 제거됨 - 새로운 이벤트 리스너로 대체됨

// 드래그 앤 드롭 이벤트 설정
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('uploadDropZone');
    const fileInput = document.getElementById('enrollmentFile');
    
    let dragCounter = 0;
    
    // 드래그 오버 이벤트
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    // 드래그 엔터 이벤트
    dropZone.addEventListener('dragenter', function(e) {
        e.preventDefault();
        dragCounter++;
        dropZone.classList.add('dragover');
    });
    
    // 드래그 리브 이벤트 (개선된 버전)
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dragCounter--;
        
        // 드래그가 실제로 영역을 벗어났을 때만 클래스 제거
        if (dragCounter === 0) {
            dropZone.classList.remove('dragover');
        }
    });
    
    // 드롭 이벤트
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dragCounter = 0;
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            
            // 파일 검증
            if (!validateFile(file)) {
                return;
            }
            
            // 파일 입력에 설정
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            // 자동으로 업로드 실행
            uploadEnrollmentFile();
        }
    });
    
    // 클릭 이벤트 (파일 선택 다이얼로그 열기)
    dropZone.addEventListener('click', function(e) {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });
});

// 모든 편집 초기화 함수
async function resetAllData() {
    if (confirm('uploads 폴더 내 모든 파일을 삭제하여 완전히 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        try {
            const response = await fetch('/api/reset-all-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const data = await response.json();

            if (data.success) {
                            showModalAlert('성공', 'uploads 폴더가 완전히 초기화되었습니다. (' + data.deleted_files + '개 항목 삭제됨)', 'success');
            // 페이지 새로고침 또는 데이터 요약 다시 로드
            location.reload();
        } else {
            showModalAlert('오류', '데이터 초기화에 실패했습니다: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error resetting data:', error);
        showModalAlert('오류', '데이터 초기화 중 오류가 발생했습니다.', 'error');
    }
    }
}

// 학생 충돌 초기화 함수
async function resetStudentConflicts() {
    if (confirm('학생 충돌 편집을 원본 엑셀 파일로 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        try {
            const response = await fetch('/api/reset-student-conflicts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const data = await response.json();

            if (data.success) {
                            showModalAlert('성공', '학생 충돌이 원본 엑셀 파일로 초기화되었습니다.', 'success');
            loadData(); // 테이블 새로고침
        } else {
            showModalAlert('오류', '학생 충돌 초기화에 실패했습니다: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error resetting student conflicts:', error);
        showModalAlert('오류', '학생 충돌 초기화 중 오류가 발생했습니다.', 'error');
    }
    }
}
</script>


{% endblock %} 