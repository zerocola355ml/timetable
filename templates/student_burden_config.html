{% extends "base.html" %}

{% block title %}학생 부담 조정 - 시험 시간표 배정 시스템{% endblock %}

{% block extra_css %}
<style>
    .constraint-card {
        border-left: 4px solid #007bff;
        margin-bottom: 1rem;
    }
    
    .constraint-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .warning-section {
        display: none;
    }
    
    .main-content {
        display: none;
    }
    
    .loading-spinner {
        display: none;
    }
    
    .sortable {
        cursor: pointer;
        user-select: none;
    }

    .sortable:hover {
        background-color: #e9ecef;
    }

    .sortable i {
        margin-left: 5px;
        opacity: 0.5;
    }

    .sortable.asc i.fa-sort-up,
    .sortable.desc i.fa-sort-down {
        opacity: 1;
    }

    .form-check-input {
        transform: scale(1.2);
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 경고 메시지 섹션 -->
    <div id="warningSection" class="warning-section">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4 id="warningTitle">경고</h4>
                    <p id="warningMessage" class="mb-3">필요한 파일이 없습니다.</p>
                    <a id="warningAction" href="#" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-2"></i>해당 설정 페이지로 이동
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div id="mainContent" class="main-content">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3><i class="fas fa-user-graduate me-2"></i>학생 부담 조정</h3>
                            <div>
                                <button type="button" class="btn btn-danger me-2" onclick="resetToDefaults()">
                                    <i class="fas fa-undo me-2"></i>원본으로 초기화
                                </button>
                                <a href="{{ url_for('data_review') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>돌아가기
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 로딩 스피너 -->
                <div id="loadingSpinner" class="loading-spinner text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                    <p class="mt-3">데이터를 불러오는 중...</p>
                </div>

                <!-- Configuration Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>
                            학생 부담 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="studentBurdenForm">
                            <!-- Basic Settings -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-calendar-day me-2"></i>
                                        시험 개수 제한
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label for="maxExamsPerDay" class="form-label">
                                            학생별 하루 최대 시험 개수
                                        </label>
                                        <input type="number" class="form-control" id="maxExamsPerDay" 
                                               placeholder="제한 없음 (빈 값)" min="1" max="5" onchange="autoSaveConfig()">
                                        <div class="form-text">한 학생이 하루에 치를 수 있는 최대 시험 개수 (빈 값은 제한 없음)</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="maxHardExamsPerDay" class="form-label">
                                            학생별 하루 최대 어려운 시험 개수
                                        </label>
                                        <input type="number" class="form-control" id="maxHardExamsPerDay" 
                                               placeholder="제한 없음 (빈 값)" min="1" max="3" onchange="autoSaveConfig()">
                                        <div class="form-text">한 학생이 하루에 치를 수 있는 최대 어려운 시험 개수 (빈 값은 제한 없음)</div>
                                    </div>
                                </div>
                            </div>

                            
                            
                            <!-- Error Message Container -->
                            <div id="errorContainer" class="mt-3" style="display: none;">
                                <div class="alert alert-danger" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="errorMessage"></span>
                                </div>
                            </div>

                            <!-- Success Message Container -->
                            <div id="successContainer" class="mt-3" style="display: none;">
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="successMessage"></span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 과목별 어려운 과목 설정 테이블 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            과목별 어려운 과목 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="subjectsTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="subject">
                                            과목명 <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="time">
                                            시간 (분) <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="grade">
                                            학년 <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="teacher">
                                            담당교사 <i class="fas fa-sort"></i>
                                        </th>
                                        <th>
                                            어려운 과목
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="subjectsTableBody">
                                    <!-- 데이터가 여기에 로드됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let subjectsData = {};
let hardSubjectsData = {};
let currentSort = { field: 'subject', direction: 'asc' };

// 페이지 로드 시 설정 데이터 로드
document.addEventListener('DOMContentLoaded', loadConfig);

// 경고 메시지 표시
function showWarning(title, message, actionUrl) {
    document.getElementById('warningTitle').textContent = title;
    document.getElementById('warningMessage').textContent = message;
    document.getElementById('warningAction').href = actionUrl;
    document.getElementById('warningSection').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
}

// 메인 콘텐츠 표시
function showMainContent() {
    document.getElementById('warningSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
}

// 로딩 표시
function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

// 설정 데이터 로드
async function loadConfig() {
    showLoading(true);
    
    try {
        const response = await fetch('/api/student-burden-config');
        const data = await response.json();
        
        if (data.success) {
            const config = data.config;
            
            // 값이 있으면 설정, 없으면 빈 값 (제한 없음)
            document.getElementById('maxExamsPerDay').value = config.max_exams_per_day || '';
            document.getElementById('maxHardExamsPerDay').value = config.max_hard_exams_per_day || '';
            
            // 과목 데이터 저장
            subjectsData = data.subjects;
            hardSubjectsData = data.hard_subjects;
            
            // 테이블 렌더링
            renderSubjectsTable();
            showMainContent();
        } else {
            if (data.error === 'no_exam_scope') {
                showWarning('과목 정보 파일이 없습니다', 
                    '과목 정보를 먼저 설정해주세요.', 
                    '/exam-scope');
            } else {
                showWarning('오류 발생', 
                    data.error || '데이터 로드 중 오류가 발생했습니다.', 
                    '/data-review');
            }
        }
    } catch (error) {
        console.error('Error loading config:', error);
        showWarning('오류 발생', 
            '데이터 로드 중 오류가 발생했습니다.', 
            '/data-review');
    } finally {
        showLoading(false);
    }
}

// 과목 테이블 렌더링
function renderSubjectsTable() {
    const tbody = document.getElementById('subjectsTableBody');
    tbody.innerHTML = '';

    // 정렬된 과목 목록 생성
    const sortedSubjects = Object.keys(subjectsData).sort((a, b) => {
        let aVal, bVal;
        
        switch (currentSort.field) {
            case 'subject':
                aVal = a;
                bVal = b;
                break;
            case 'time':
                aVal = subjectsData[a]['시간'] || 0;
                bVal = subjectsData[b]['시간'] || 0;
                break;
            case 'grade':
                aVal = subjectsData[a]['학년'] || '';
                bVal = subjectsData[b]['학년'] || '';
                break;
            case 'teacher':
                aVal = Array.isArray(subjectsData[a]['담당교사']) ? 
                       subjectsData[a]['담당교사'].join(', ') : subjectsData[a]['담당교사'] || '';
                bVal = Array.isArray(subjectsData[b]['담당교사']) ? 
                       subjectsData[b]['담당교사'].join(', ') : subjectsData[b]['담당교사'] || '';
                break;
            default:
                aVal = a;
                bVal = b;
        }
        
        if (currentSort.direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });

    for (const subject of sortedSubjects) {
        const info = subjectsData[subject];
        const isHard = hardSubjectsData[subject] || false;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${subject}</strong></td>
            <td>${info['시간'] || '-'}</td>
            <td>${info['학년'] || '-'}</td>
            <td>${Array.isArray(info['담당교사']) ? info['담당교사'].join(', ') : info['담당교사'] || '-'}</td>
            <td>
                <input type="checkbox" class="form-check-input" 
                       ${isHard ? 'checked' : ''} 
                       onchange="updateHardSubject('${subject}', this.checked)">
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    // 정렬 아이콘 업데이트
    updateSortIcons();
}

// 정렬 아이콘 업데이트
function updateSortIcons() {
    const headers = document.querySelectorAll('.sortable');
    headers.forEach(header => {
        const icon = header.querySelector('i');
        header.classList.remove('asc', 'desc');
        
        if (header.dataset.sort === currentSort.field) {
            if (currentSort.direction === 'asc') {
                header.classList.add('asc');
                icon.className = 'fas fa-sort-up';
            } else {
                header.classList.add('desc');
                icon.className = 'fas fa-sort-down';
            }
        } else {
            icon.className = 'fas fa-sort';
        }
    });
}

// 정렬 이벤트 리스너 추가
document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('.sortable');
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const field = this.dataset.sort;
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            renderSubjectsTable();
        });
    });
});

// 어려운 과목 설정 업데이트
async function updateHardSubject(subject, isHard) {
    try {
        const response = await fetch('/api/update-hard-subject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subject: subject,
                is_hard: isHard
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 로컬 데이터 업데이트
            hardSubjectsData[subject] = isHard;
            // 메시지 표시하지 않음
        } else {
            showError(result.error);
            // 실패 시 체크박스 상태 되돌리기
            loadConfig();
        }
    } catch (error) {
        console.error('Error updating hard subject:', error);
        showError('어려운 과목 설정 업데이트 중 오류가 발생했습니다.');
        // 실패 시 체크박스 상태 되돌리기
        loadConfig();
    }
}

// 자동 저장 함수
async function autoSaveConfig() {
    try {
        // 입력값 가져오기 (빈 값은 null로 처리)
        const maxExamsPerDayInput = document.getElementById('maxExamsPerDay').value.trim();
        const maxHardExamsPerDayInput = document.getElementById('maxHardExamsPerDay').value.trim();
        
        let maxExamsPerDay = maxExamsPerDayInput ? parseInt(maxExamsPerDayInput) : null;
        let maxHardExamsPerDay = maxHardExamsPerDayInput ? parseInt(maxHardExamsPerDayInput) : null;
        
        // 값이 입력된 경우에만 유효성 검사
        if (maxExamsPerDay !== null) {
            if (isNaN(maxExamsPerDay) || maxExamsPerDay < 1 || maxExamsPerDay > 5) {
                return;
            }
        }
        
        if (maxHardExamsPerDay !== null) {
            if (isNaN(maxHardExamsPerDay) || maxHardExamsPerDay < 1 || maxHardExamsPerDay > 3) {
                return;
            }
        }
        
        // 어려운 시험 개수는 전체 시험 개수가 설정된 경우에만 검증
        if (maxExamsPerDay !== null && maxHardExamsPerDay !== null) {
            if (maxHardExamsPerDay > maxExamsPerDay) {
                return;
            }
        }
        
        // API 호출
        const response = await fetch('/api/update-student-burden-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                max_exams_per_day: maxExamsPerDay,
                max_hard_exams_per_day: maxHardExamsPerDay,
                hard_subjects: hardSubjectsData
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            showError(result.error);
        }
        
    } catch (error) {
        console.error('Error auto-saving config:', error);
        showError('설정 자동 저장 중 오류가 발생했습니다.');
    }
}

// 기본값으로 초기화 (원본 설정 복원)
function resetToDefaults() {
    if (confirm('설정을 원본으로 초기화하시겠습니까?')) {
        // 원본 설정 로드 (기본값: 제한 없음)
        document.getElementById('maxExamsPerDay').value = '';
        document.getElementById('maxHardExamsPerDay').value = '';
        
        // 모든 과목을 어렵지 않음으로 설정
        for (const subject in hardSubjectsData) {
            hardSubjectsData[subject] = false;
        }
        
        renderSubjectsTable();
        hideMessages();
        
        // 자동 저장
        autoSaveConfig();
    }
}

// 에러 메시지 표시
function showError(message) {
    hideMessages();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').style.display = 'block';
    document.getElementById('errorContainer').scrollIntoView({ behavior: 'smooth' });
}

// 성공 메시지 표시
function showSuccess(message) {
    hideMessages();
    document.getElementById('successMessage').textContent = message;
    document.getElementById('successContainer').style.display = 'block';
    document.getElementById('successContainer').scrollIntoView({ behavior: 'smooth' });
}

// 메시지 숨기기
function hideMessages() {
    document.getElementById('errorContainer').style.display = 'none';
    document.getElementById('successContainer').style.display = 'none';
}
</script>
{% endblock %}
