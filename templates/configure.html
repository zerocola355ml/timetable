{% extends "base.html" %}

{% block title %}ì„¤ì • ì¡°ì • - ì‹œí—˜ ì‹œê°„í‘œ ë°°ì • ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Header -->
        <div class="text-center mb-4">
            <h2 class="text-primary">
                <i class="fas fa-cog me-2"></i>
                ì„¤ì • ì¡°ì •
            </h2>
            <p class="text-muted">ì‹œí—˜ ì‹œê°„í‘œ ë°°ì •ì— ì‚¬ìš©í•  ì„¤ì •ê°’ë“¤ì„ ì¡°ì •í•˜ì„¸ìš”.</p>
        </div>

        <!-- Configuration Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>
                    ë°°ì • ì„¤ì •
                </h5>
            </div>
                    <div class="card-body">
                <form id="configForm">
                    <!-- Basic Settings -->
                    <div class="row mb-4">
                        

                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-clock me-2"></i>
                                ì‹œê°„ ì„¤ì •
                            </h6>
                            
                            <div class="mb-3">
                                <label for="solveTimeLimit" class="form-label">
                                    ìµœëŒ€ í’€ì´ ì‹œê°„ (ì´ˆ)
                                </label>
                                <input type="number" class="form-control" id="solveTimeLimit" 
                                       value="120" min="10" max="600" step="10">
                                <div class="form-text">ìµœì í™” ì•Œê³ ë¦¬ì¦˜ì´ ì‹¤í–‰ë˜ëŠ” ìµœëŒ€ ì‹œê°„ì…ë‹ˆë‹¤. (10ì´ˆ~600ì´ˆ)</div>
                            </div>


                            <!-- ì‹œí—˜ ì¼ìˆ˜ëŠ” /exam-infoì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤. -->
                        </div>
                    </div>

                    <!-- êµì‹œë³„ ì‹œê°„ ì œí•œì€ /exam-infoì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤. -->

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="resetToDefaults()">
                            <i class="fas fa-undo me-2"></i>
                            ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                        </button>
                        <button type="button" class="btn btn-primary btn-lg" onclick="createSchedule()" id="createBtn">
                            <i class="fas fa-magic me-2"></i>
                            ì‹œí—˜ ì‹œê°„í‘œ ìƒì„±
                        </button>
                    </div>
                    
                    <!-- Error Message Container -->
                    <div id="errorContainer" class="mt-3" style="display: none;">
                        <div class="alert alert-danger" role="alert" style="white-space: pre-line; max-height: 400px; overflow-y: auto;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorMessage"></span>
                            <button type="button" class="btn-close float-end" onclick="hideErrorContainer()" aria-label="Close"></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    ì‹œí—˜ ì‹œê°„í‘œ ìƒì„± ì¤‘...
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <p class="text-muted mb-0" id="progressMessage">ìµœì í™” ì•Œê³ ë¦¬ì¦˜ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted" id="progressDetails">ì§„í–‰ë¥ : 0%</small>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        ìµœì í™” ì•Œê³ ë¦¬ì¦˜ì€ ì„¤ì •ëœ ì‹œê°„ ì œí•œ ë‚´ì—ì„œ ìµœì ì˜ í•´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                    </small>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    ì„¤ì • ë„ì›€ë§
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">í•™ìƒ ë¶€ë‹´ ì¡°ì •</h6>
                        <p class="small text-muted">
                            í•™ìƒë³„ í•˜ë£¨ ìµœëŒ€ ì‹œí—˜ ê°œìˆ˜, ì–´ë ¤ìš´ ì‹œí—˜ ê°œìˆ˜, ì–´ë ¤ìš´ ê³¼ëª© ê¸°ì¤€ ì‹œê°„ì€ 
                            <a href="{{ url_for('student_burden_config') }}">í•™ìƒ ë¶€ë‹´ ì¡°ì •</a> í˜ì´ì§€ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">ì‹œí—˜ ì¼ìˆ˜/êµì‹œ ì‹œê°„</h6>
                        <p class="small text-muted">
                            ì‹œí—˜ ì¼ìˆ˜ì™€ êµì‹œë³„ ì‹œê°„ì€ ë°ì´í„° ê²€í† ì˜ "ì‹œí—˜ ì •ë³´ í¸ì§‘"ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load saved configuration if exists
    loadSavedConfig();
});

function getConfigData() {
    return {
        solve_time_limit: parseInt(document.getElementById('solveTimeLimit').value),
        // í•™ìƒ ë¶€ë‹´ ì¡°ì • ì„¤ì •ì€ /student-burden-configì—ì„œ ê´€ë¦¬
        // ì¼ìˆ˜/êµì‹œ ì‹œê°„ì€ /exam-infoì—ì„œ ê´€ë¦¬
    };
}

function validateConfig(config) {
    const errors = [];
    
    // í•™ìƒ ë¶€ë‹´ ì¡°ì • ì„¤ì • ê²€ì¦ì€ /student-burden-configì—ì„œ ìˆ˜í–‰
    
    // ì‹œí—˜ ì¼ìˆ˜ ê²€ì¦ì€ /exam-infoì—ì„œ ìˆ˜í–‰
    
    // í’€ì´ ì‹œê°„ ì œí•œ ê²€ì¦
    const solveTimeLimit = parseInt(document.getElementById('solveTimeLimit').value);
    if (solveTimeLimit < 10 || solveTimeLimit > 600) {
        errors.push('ìµœëŒ€ í’€ì´ ì‹œê°„ì€ 10ì´ˆì—ì„œ 600ì´ˆ ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }
    
    return errors;
}

function createSchedule() {
    const config = getConfigData();
    const errors = validateConfig(config);
    
    if (errors.length > 0) {
        showAlert(errors.join('<br>'), 'danger');
        return;
    }
    
    // Show progress
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('createBtn').disabled = true;
    
    // Update progress message
    function updateProgress(message, progress = null) {
        document.getElementById('progressMessage').textContent = message;
        
        // ì§„í–‰ë¥ ì´ ì œê³µë˜ë©´ ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
        if (progress !== null) {
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            document.getElementById('progressText').textContent = progress + '%';
            document.getElementById('progressDetails').textContent = 'ì§„í–‰ë¥ : ' + progress + '%';
        }
    }
    
    updateProgress('ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
    
    // ì‹¤ì œ ì„œë²„ ì§„í–‰ìƒí™©ì„ í´ë§
    let statusInterval = setInterval(async () => {
        try {
            const statusResponse = await fetch('/api/schedule-status');
            const statusData = await statusResponse.json();
            
            updateProgress(statusData.step, statusData.progress);
            
            // ì§„í–‰ ì™„ë£Œë˜ë©´ í´ë§ ì¤‘ì§€
            if (!statusData.is_running) {
                clearInterval(statusInterval);
                
                if (statusData.result === 'success') {
                    // ì„±ê³µì‹œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/results';
                    }, 2000); // 2ì´ˆ í›„ ì´ë™
                } else if (statusData.error) {
                    // ì—ëŸ¬ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì´ë¯¸ fetch ì‘ë‹µì—ì„œ ì²˜ë¦¬ë¨
                }
            }
        } catch (error) {
            console.error('Status polling error:', error);
        }
    }, 1000); // 1ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
    
    // Send request
    const requestBody = { config: config, time_limit: config.solve_time_limit || 120 };
    console.log('DEBUG: Sending request with body:', requestBody);
    
    fetch('/api/schedule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('DEBUG: Response status:', response.status);
        console.log('DEBUG: Response headers:', response.headers);
        return response.json();
    })
    .then(data => {
        console.log('DEBUG: Received response data:', data);
        console.log('DEBUG: data.success:', data.success);
        console.log('DEBUG: data.error:', data.error);
        clearInterval(statusInterval); // ì§„í–‰ ìƒí™© ì¸í„°ë²Œ ì •ë¦¬
        
        if (data.success) {
            updateProgress('ì‹œí—˜ ì‹œê°„í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            showSuccessInButtonArea('ì‹œí—˜ ì‹œê°„í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            setTimeout(() => {
                window.location.href = '/results';
            }, 1500);
        } else {
            console.log('DEBUG: Error response data:', data);
            console.log('DEBUG: data.diagnosis:', data.diagnosis);
            console.log('DEBUG: data.details:', data.details);
            
            let errorMessage = data.error || 'ì‹œí—˜ ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            
            // ì§„ë‹¨ ì •ë³´ê°€ ìˆìœ¼ë©´ ë” ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            if (data.diagnosis && Object.keys(data.diagnosis).length > 0) {
                errorMessage = data.error || 'ì‹œí—˜ ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                
                // ì§„ë‹¨ ì •ë³´ë¥¼ ì¶”ê°€ë¡œ í‘œì‹œ
                if (data.diagnosis.possible_causes && data.diagnosis.possible_causes.length > 0) {
                    errorMessage += '\n\nğŸ” ê°€ëŠ¥í•œ ì›ì¸:\n';
                    data.diagnosis.possible_causes.forEach(cause => {
                        errorMessage += `â€¢ ${cause}\n`;
                    });
                }
                
                if (data.diagnosis.recommendations && data.diagnosis.recommendations.length > 0) {
                    errorMessage += '\nğŸ’¡ í•´ê²° ë°©ë²•:\n';
                    data.diagnosis.recommendations.forEach(rec => {
                        errorMessage += `â€¢ ${rec}\n`;
                    });
                }
                
                if (data.diagnosis.constraint_info) {
                    const info = data.diagnosis.constraint_info;
                    errorMessage += '\nğŸ“Š ì œì•½ì¡°ê±´ ì •ë³´:\n';
                    errorMessage += `â€¢ ì´ ìŠ¬ë¡¯ ìˆ˜: ${info.total_slots || 'N/A'}\n`;
                    errorMessage += `â€¢ ì´ ê³¼ëª© ìˆ˜: ${info.total_subjects || 'N/A'}\n`;
                    
                    if (info.subjects_with_few_slots && info.subjects_with_few_slots.length > 0) {
                        errorMessage += `â€¢ ë°°ì • ê°€ëŠ¥ ìŠ¬ë¡¯ì´ ì ì€ ê³¼ëª©: ${info.subjects_with_few_slots.join(', ')}\n`;
                    }
                    
                    if (info.high_conflict_subjects && info.high_conflict_subjects.length > 0) {
                        errorMessage += `â€¢ ì¶©ëŒì´ ë§ì€ ê³¼ëª©: ${info.high_conflict_subjects.join(', ')}\n`;
                    }
                }
            } else {
                // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
                if (errorMessage.includes('ì‹œê°„') || errorMessage.includes('time') || 
                    errorMessage.includes('NO_SOLUTION') || errorMessage.includes('INFEASIBLE')) {
                    errorMessage = 'ì‹œí—˜ ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê°€ëŠ¥í•œ ì›ì¸:\n' +
                                 'â€¢ í’€ì´ ì‹œê°„ì´ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹œê°„ì„ ëŠ˜ë ¤ë³´ì„¸ìš”.\n' +
                                 'â€¢ ì‹œí—˜ ì¼ìˆ˜ë‚˜ êµì‹œ ìˆ˜ê°€ ë„ˆë¬´ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' +
                                 'â€¢ ê³¼ëª© ê°„ ì¶©ëŒì´ ë„ˆë¬´ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' +
                                 'â€¢ êµì‚¬ ë¶ˆê°€ëŠ¥ ì‹œê°„ì´ ë„ˆë¬´ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
            }
            
            updateProgress('ì‹œí—˜ ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            showErrorInButtonArea(errorMessage);
            document.getElementById('progressCard').style.display = 'none';
            document.getElementById('createBtn').disabled = false;
            
            // statusIntervalë„ ì •ë¦¬
            if (typeof statusInterval !== 'undefined') {
                clearInterval(statusInterval);
            }
        }
    })
    .catch(error => {
        console.error('DEBUG: Fetch error:', error);
        clearInterval(statusInterval); // ì§„í–‰ ìƒí™© ì¸í„°ë²Œ ì •ë¦¬
        updateProgress('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        showErrorInButtonArea('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        document.getElementById('progressCard').style.display = 'none';
        document.getElementById('createBtn').disabled = false;
    });
}

function showErrorInButtonArea(message) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const alertDiv = errorContainer.querySelector('.alert');
    
    // ì¤„ë°”ê¿ˆì„ HTMLë¡œ ë³€í™˜
    const formattedMessage = message.replace(/\n/g, '<br>');
    errorMessage.innerHTML = formattedMessage;
    
    errorContainer.style.display = 'block';
    alertDiv.classList.remove('alert-success');
    alertDiv.classList.add('alert-danger');
    
    // ë²„íŠ¼ ê·¼ì²˜ë¡œ ìŠ¤í¬ë¡¤
    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // ì‹¤íŒ¨ ë©”ì‹œì§€ëŠ” ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ - ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì•¼ í•¨
}

function hideErrorContainer() {
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.style.display = 'none';
}

function showSuccessInButtonArea(message) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const alertDiv = errorContainer.querySelector('.alert');
    
    // ì¤„ë°”ê¿ˆì„ HTMLë¡œ ë³€í™˜
    const formattedMessage = message.replace(/\n/g, '<br>');
    errorMessage.innerHTML = formattedMessage;
    
    errorContainer.style.display = 'block';
    alertDiv.classList.remove('alert-danger');
    alertDiv.classList.add('alert-success');
    
    // ë²„íŠ¼ ê·¼ì²˜ë¡œ ìŠ¤í¬ë¡¤
    errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        errorContainer.style.display = 'none';
    }, 5000);
}

function resetToDefaults() {
    document.getElementById('solveTimeLimit').value = 120;
    // í•™ìƒ ë¶€ë‹´ ì¡°ì • ì„¤ì •ì€ /student-burden-configì—ì„œ ê´€ë¦¬
    // ì‹œí—˜ ì¼ìˆ˜/êµì‹œ ì œí•œ ê¸°ë³¸ê°’ì€ /exam-infoì—ì„œ ê´€ë¦¬
    
    showAlert('ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function loadSavedConfig() {
    // Load from localStorage if available
    const saved = localStorage.getItem('examScheduleConfig');
    if (saved) {
        try {
            const config = JSON.parse(saved);
            document.getElementById('solveTimeLimit').value = config.solve_time_limit || 120;
            // í•™ìƒ ë¶€ë‹´ ì¡°ì • ì„¤ì •ì€ /student-burden-configì—ì„œ ê´€ë¦¬
            // /exam-infoì—ì„œ ê´€ë¦¬í•˜ëŠ” ê°’ë“¤ì€ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ
        } catch (e) {
            console.error('Failed to load saved config:', e);
        }
    }
}

// Save config when form changes
document.addEventListener('change', function() {
    const config = getConfigData();
    localStorage.setItem('examScheduleConfig', JSON.stringify(config));
});

function validateSolveTimeLimit(input) {
    const value = parseInt(input.value);
    if (value < 10) {
        input.value = 10;
        showAlert('ìµœì†Œ í’€ì´ ì‹œê°„ì€ 10ì´ˆì…ë‹ˆë‹¤.', 'warning');
    } else if (value > 600) {
        input.value = 600;
        showAlert('ìµœëŒ€ í’€ì´ ì‹œê°„ì€ 600ì´ˆì…ë‹ˆë‹¤.', 'warning');
    }
}
</script>
{% endblock %} 