{% extends "base.html" %}

{% block title %}분반배정표 데이터 편집{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-users me-2"></i>분반배정표 편집</h3>
        <div>
            <button class="btn btn-danger btn-sm me-2" onclick="resetEnrollmentData()">
                <i class="fas fa-undo me-1"></i>분반배정표 초기화
            </button>
            <a href="{{ url_for('data_review') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>돌아가기
            </a>
        </div>
    </div>
    <p class="text-muted">학생별 과목 수강 정보를 확인하고 수정할 수 있습니다.</p>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>수강 정보 편집</h5>
                    <p class="mb-0">학생별 과목 수강 여부를 편집할 수 있습니다.</p>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="studentFilter" class="form-label">학생 검색:</label>
                            <input type="text" id="studentFilter" class="form-control" placeholder="학생명을 입력하세요">
                        </div>
                        <div class="col-md-6">
                            <label for="subjectFilter" class="form-label">과목 검색:</label>
                            <input type="text" id="subjectFilter" class="form-control" placeholder="과목명을 입력하세요">
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-bordered" id="enrollmentTable">
                            <thead class="table-dark sticky-top">
                                <tr id="enrollmentTableHeader">
                                    <th>학생명</th>
                                </tr>
                            </thead>
                            <tbody id="enrollmentTableBody">
                                <!-- 데이터가 여기에 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveChanges()">변경사항 저장</button>
                        <button class="btn btn-secondary" onclick="loadData()">새로고침</button>
                        <button class="btn btn-info" onclick="showStatistics()">통계 보기</button>
                        <a href="{{ url_for('data_review') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>돌아가기
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 통계 모달 -->
    <div class="modal fade" id="statisticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">수강 통계</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statisticsContent">
                    <!-- 통계 내용이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let enrollmentData = {};
let subjects = [];
let students = [];

// 데이터 로드
async function loadData() {
    try {
        const response = await fetch('/api/enrollment-data');
        const data = await response.json();
        
        if (data.success) {
            enrollmentData = data.enrollment_matrix;
            subjects = data.subjects;
            students = data.students;
            
            renderTable();
            updateFilters();
        } else {
            alert('데이터 로드 실패: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading data:', error);
        alert('데이터 로드 중 오류가 발생했습니다.');
    }
}

// 테이블 렌더링
function renderTable() {
    const tbody = document.getElementById('enrollmentTableBody');
    tbody.innerHTML = '';
    
    students.forEach(student => {
        const row = document.createElement('tr');
        
        // 학생명 셀
        const studentCell = document.createElement('td');
        studentCell.textContent = student;
        studentCell.style.fontWeight = 'bold';
        row.appendChild(studentCell);
        
        // 과목별 체크박스 셀들
        subjects.forEach(subject => {
            const cell = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input';
            checkbox.checked = enrollmentData[student] && enrollmentData[student][subject];
            checkbox.onchange = function() {
                if (!enrollmentData[student]) {
                    enrollmentData[student] = {};
                }
                enrollmentData[student][subject] = this.checked;
            };
            cell.appendChild(checkbox);
            row.appendChild(cell);
        });
        
        tbody.appendChild(row);
    });
    
    // 헤더 업데이트
    updateHeader();
}

// 헤더 업데이트
function updateHeader() {
    const header = document.getElementById('enrollmentTableHeader');
    
    // 기존 과목 헤더들 제거 (학생명 헤더는 유지)
    const existingHeaders = header.querySelectorAll('th:not(:first-child)');
    existingHeaders.forEach(th => th.remove());
    
    // 과목명들을 헤더에 추가
    subjects.forEach(subject => {
        const th = document.createElement('th');
        th.textContent = subject;
        th.style.fontSize = '0.8rem';
        th.style.whiteSpace = 'nowrap';
        th.style.minWidth = '80px';
        th.style.color = '#ffffff';
        th.style.fontWeight = 'bold';
        th.style.textAlign = 'center';
        header.appendChild(th);
    });
}

// 필터 업데이트
function updateFilters() {
    const studentFilter = document.getElementById('studentFilter');
    const subjectFilter = document.getElementById('subjectFilter');
    
    studentFilter.addEventListener('input', filterTable);
    subjectFilter.addEventListener('input', filterTable);
}

// 테이블 필터링
function filterTable() {
    const studentFilter = document.getElementById('studentFilter').value.toLowerCase();
    const subjectFilter = document.getElementById('subjectFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#enrollmentTableBody tr');
    
    rows.forEach(row => {
        const studentName = row.cells[0].textContent.toLowerCase();
        const subjectNames = Array.from(row.cells).slice(1).map(cell => {
            const checkbox = cell.querySelector('input');
            return checkbox ? checkbox.checked : false;
        });
        
        const studentMatch = studentName.includes(studentFilter);
        const subjectMatch = subjectFilter === '' || subjects.some((subject, index) => 
            subject.toLowerCase().includes(subjectFilter) && subjectNames[index]
        );
        
        row.style.display = (studentMatch && subjectMatch) ? '' : 'none';
    });
}

// 변경사항 저장
async function saveChanges() {
    try {
        const response = await fetch('/api/update-enrollment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                enrollment_matrix: enrollmentData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('변경사항이 저장되었습니다.');
        } else {
            alert('저장 실패: ' + data.error);
        }
    } catch (error) {
        console.error('Error saving data:', error);
        alert('저장 중 오류가 발생했습니다.');
    }
}

// 통계 보기
function showStatistics() {
    const stats = calculateStatistics();
    const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
    const content = document.getElementById('statisticsContent');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>기본 정보</h6>
                <ul>
                    <li>총 학생 수: ${stats.totalStudents}</li>
                    <li>총 과목 수: ${stats.totalSubjects}</li>
                    <li>평균 수강 과목 수: ${stats.avgSubjectsPerStudent.toFixed(1)}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>과목별 수강 학생 수</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${stats.subjectStats.map(stat => 
                        `<div>${stat.subject}: ${stat.count}명</div>`
                    ).join('')}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <h6>수강 과목 수 분포</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${stats.enrollmentDistribution.map(dist => 
                        `<div>${dist.count}과목 수강: ${dist.students}명</div>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;
    
    modal.show();
}

// 통계 계산
function calculateStatistics() {
    const stats = {
        totalStudents: students.length,
        totalSubjects: subjects.length,
        avgSubjectsPerStudent: 0,
        subjectStats: [],
        enrollmentDistribution: {}
    };
    
    // 과목별 수강 학생 수
    subjects.forEach(subject => {
        let count = 0;
        students.forEach(student => {
            if (enrollmentData[student] && enrollmentData[student][subject]) {
                count++;
            }
        });
        stats.subjectStats.push({ subject, count });
    });
    
    // 학생별 수강 과목 수
    const studentEnrollmentCounts = {};
    students.forEach(student => {
        let count = 0;
        subjects.forEach(subject => {
            if (enrollmentData[student] && enrollmentData[student][subject]) {
                count++;
            }
        });
        studentEnrollmentCounts[student] = count;
    });
    
    // 수강 과목 수 분포
    const distribution = {};
    Object.values(studentEnrollmentCounts).forEach(count => {
        distribution[count] = (distribution[count] || 0) + 1;
    });
    
    stats.enrollmentDistribution = Object.entries(distribution)
        .map(([count, students]) => ({ count: parseInt(count), students }))
        .sort((a, b) => a.count - b.count);
    
    // 평균 수강 과목 수
    const totalEnrollments = Object.values(studentEnrollmentCounts).reduce((sum, count) => sum + count, 0);
    stats.avgSubjectsPerStudent = totalEnrollments / students.length;
    
    return stats;
}

// 페이지 로드 시 데이터 로드
document.addEventListener('DOMContentLoaded', loadData);

// 분반배정표 초기화 함수
async function resetEnrollmentData() {
    if (confirm('분반배정표 편집을 원본 엑셀 파일로 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        try {
            const response = await fetch('/api/reset-enrollment-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const data = await response.json();

            if (data.success) {
                alert('분반배정표가 원본 엑셀 파일로 초기화되었습니다.');
                loadData(); // 테이블 새로고침
            } else {
                alert('분반배정표 초기화에 실패했습니다: ' + data.error);
            }
        } catch (error) {
            console.error('Error resetting enrollment data:', error);
            alert('분반배정표 초기화 중 오류가 발생했습니다.');
        }
    }
}
</script>

<style>
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

#enrollmentTable th {
    font-size: 0.8rem;
    white-space: nowrap;
    min-width: 80px;
    color: #ffffff !important;
    font-weight: bold !important;
    text-align: center;
    background-color: #343a40 !important;
    border-color: #495057 !important;
}

#enrollmentTable td {
    font-size: 0.8rem;
    vertical-align: middle;
    padding: 0.5rem 0.25rem;
}

#enrollmentTable td:first-child {
    font-weight: bold;
    background-color: #f8f9fa;
    border-right: 2px solid #dee2e6;
}

.form-check-input {
    margin: 0;
}
</style>
{% endblock %} 