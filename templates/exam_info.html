<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시험 정보 편집 - 시험 시간표 배정 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-cell:hover {
            background-color: #e9ecef;
        }
        .editing {
            background-color: #fff3cd !important;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .time-slot {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .time-slot-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .time-input {
            width: 80px;
            display: inline-block;
        }
        .date-section {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .date-header {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .period-row {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .period-label {
            font-weight: 600;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- 헤더 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-calendar-alt me-2"></i>시험 정보 편집</h3>
                    <div>
                        <button class="btn btn-outline-secondary me-2" onclick="resetExamInfo()">
                            <i class="fas fa-undo me-2"></i>시험 정보 초기화
                        </button>
                        <a href="{{ url_for('data_review') }}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>돌아가기
                        </a>
                    </div>
                </div>
                <hr>
            </div>
        </div>

        <!-- 기본 정보 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>기본 정보
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="examDays" class="form-label">시험 일수</label>
                                <input type="number" id="examDays" class="form-control" min="1" max="10" onchange="updateExamInfo('exam_days', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label for="periodsPerDay" class="form-label">일일 교시 수</label>
                                <input type="number" id="periodsPerDay" class="form-control" min="1" max="8" onchange="updateExamInfo('periods_per_day', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label for="examStartDate" class="form-label">시험 시작일</label>
                                <input type="date" id="examStartDate" class="form-control" onchange="updateExamInfo('start_date', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label for="examEndDate" class="form-label">시험 종료일</label>
                                <input type="date" id="examEndDate" class="form-control" onchange="updateExamInfo('end_date', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 날짜별 교시 시간 설정 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>날짜별 교시 시간 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="datePeriodTimeSlots">
                            <!-- 날짜별 교시 시간 슬롯이 여기에 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 요약 정보 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>요약 정보
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="h4 text-primary" id="totalSlots">0</div>
                                <small class="text-muted">총 시험 슬롯</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="h4 text-success" id="totalDays">0</div>
                                <small class="text-muted">시험 일수</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="h4 text-info" id="totalPeriods">0</div>
                                <small class="text-muted">일일 교시 수</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="h4 text-warning" id="totalDuration">0분</div>
                                <small class="text-muted">총 시험 시간</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 모달 -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalTitle">알림</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    <!-- 메시지가 여기에 표시됩니다 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let examInfoData = {};

        // 페이지 로드 시 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadExamInfoData();
        });

        // 시험 정보 데이터 로드
        async function loadExamInfoData() {
            try {
                const response = await fetch('/api/exam-info-data');
                const data = await response.json();
                
                if (data.success) {
                    examInfoData = data.data;
                    renderExamInfo();
                } else {
                    showAlert('오류', data.error, 'error');
                }
            } catch (error) {
                showAlert('오류', '데이터 로드 중 오류가 발생했습니다.', 'error');
                console.error('Error loading exam info data:', error);
            }
        }

        // 시험 정보 렌더링
        function renderExamInfo() {
            // 기본 정보 설정
            document.getElementById('examDays').value = examInfoData.exam_days || 3;
            document.getElementById('periodsPerDay').value = examInfoData.periods_per_day || 4;
            document.getElementById('examStartDate').value = examInfoData.start_date || '';
            document.getElementById('examEndDate').value = examInfoData.end_date || '';

            // 날짜별 교시 시간 설정 렌더링
            renderDatePeriodTimeSlots();

            // 요약 정보 업데이트
            updateSummaryInfo();
        }

        // 날짜별 교시 시간 슬롯 렌더링
        function renderDatePeriodTimeSlots() {
            const container = document.getElementById('datePeriodTimeSlots');
            const examDays = parseInt(document.getElementById('examDays').value) || 3;
            const periodsPerDay = parseInt(document.getElementById('periodsPerDay').value) || 4;
            
            container.innerHTML = '';
            
            for (let day = 1; day <= examDays; day++) {
                const dayLabel = `제${day}일`;
                const dayData = examInfoData.date_periods && examInfoData.date_periods[day] ? examInfoData.date_periods[day] : {};
                
                const daySection = document.createElement('div');
                daySection.className = 'date-section';
                daySection.innerHTML = `
                    <div class="date-header">
                        <i class="fas fa-calendar-day me-2"></i>${dayLabel}
                    </div>
                `;
                
                for (let period = 1; period <= periodsPerDay; period++) {
                    const periodData = dayData[period] || {};
                    
                    const periodRow = document.createElement('div');
                    periodRow.className = 'period-row';
                    periodRow.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <span class="period-label">${period}교시</span>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">시작 시간</label>
                                <input type="time" class="form-control time-input" 
                                       value="${periodData.start_time || '09:00'}" 
                                       onchange="updateDatePeriodTime(${day}, ${period}, 'start_time', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">종료 시간</label>
                                <input type="time" class="form-control time-input" 
                                       value="${periodData.end_time || '10:00'}" 
                                       onchange="updateDatePeriodTime(${day}, ${period}, 'end_time', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">시험 시간 (분)</label>
                                <input type="number" class="form-control time-input" 
                                       value="${periodData.duration || 60}" 
                                       min="30" max="120" 
                                       onchange="updateDatePeriodTime(${day}, ${period}, 'duration', this.value)">
                            </div>
                        </div>
                    `;
                    
                    daySection.appendChild(periodRow);
                }
                
                container.appendChild(daySection);
            }
        }

        // 날짜별 교시 시간 업데이트
        async function updateDatePeriodTime(day, period, field, value) {
            try {
                const response = await fetch('/api/update-exam-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: `date_periods.${day}.${period}.${field}`,
                        value: value
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // 로컬 데이터 업데이트
                    if (!examInfoData.date_periods) {
                        examInfoData.date_periods = {};
                    }
                    if (!examInfoData.date_periods[day]) {
                        examInfoData.date_periods[day] = {};
                    }
                    if (!examInfoData.date_periods[day][period]) {
                        examInfoData.date_periods[day][period] = {};
                    }
                    examInfoData.date_periods[day][period][field] = value;
                    
                    // 요약 정보 업데이트
                    updateSummaryInfo();
                } else {
                    showAlert('오류', data.error, 'error');
                }
            } catch (error) {
                showAlert('오류', '교시 시간 업데이트 중 오류가 발생했습니다.', 'error');
                console.error('Error updating date period time:', error);
            }
        }

        // 시험 정보 업데이트
        async function updateExamInfo(field, value) {
            try {
                const response = await fetch('/api/update-exam-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        field: field,
                        value: value
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // 로컬 데이터 업데이트
                    examInfoData[field] = value;
                    
                    // 교시 수나 시험 일수가 변경된 경우 날짜별 교시 시간 슬롯 다시 렌더링
                    if (field === 'periods_per_day' || field === 'exam_days') {
                        renderDatePeriodTimeSlots();
                    }
                    
                    // 요약 정보 업데이트
                    updateSummaryInfo();
                } else {
                    showAlert('오류', data.error, 'error');
                }
            } catch (error) {
                showAlert('오류', '시험 정보 업데이트 중 오류가 발생했습니다.', 'error');
                console.error('Error updating exam info:', error);
            }
        }

        // 요약 정보 업데이트
        function updateSummaryInfo() {
            const examDays = parseInt(document.getElementById('examDays').value) || 0;
            const periodsPerDay = parseInt(document.getElementById('periodsPerDay').value) || 0;
            const totalSlots = examDays * periodsPerDay;
            
            let totalDuration = 0;
            if (examInfoData.date_periods) {
                for (const day in examInfoData.date_periods) {
                    for (const period in examInfoData.date_periods[day]) {
                        totalDuration += parseInt(examInfoData.date_periods[day][period].duration || 60);
                    }
                }
            }
            
            document.getElementById('totalSlots').textContent = totalSlots;
            document.getElementById('totalDays').textContent = examDays;
            document.getElementById('totalPeriods').textContent = periodsPerDay;
            document.getElementById('totalDuration').textContent = `${totalDuration}분`;
        }

        // 시험 정보 초기화
        async function resetExamInfo() {
            if (!confirm('시험 정보를 원본 상태로 초기화하시겠습니까? 모든 편집 내용이 삭제됩니다.')) {
                return;
            }

            try {
                const response = await fetch('/api/reset-exam-info', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('성공', data.message, 'success');
                    loadExamInfoData(); // 데이터 다시 로드
                } else {
                    showAlert('오류', data.error, 'error');
                }
            } catch (error) {
                showAlert('오류', '초기화 중 오류가 발생했습니다.', 'error');
                console.error('Error resetting exam info:', error);
            }
        }

        // 알림 표시
        function showAlert(title, message, type) {
            const modal = new bootstrap.Modal(document.getElementById('alertModal'));
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalBody').textContent = message;
            
            const modalContent = document.querySelector('#alertModal .modal-content');
            modalContent.className = 'modal-content';
            
            if (type === 'error') {
                modalContent.classList.add('border-danger');
            } else if (type === 'success') {
                modalContent.classList.add('border-success');
            }
            
            modal.show();
        }
    </script>
</body>
</html> 